---
title: Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬7ç« -å–æ¶ˆä¸å…³é—­
typora-copy-images-to: 20181105
date: 2018-11-05 09:22:17
tags:
  - Java
  - å¹¶å‘
  - ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹
  categories:
  - è¯»ä¹¦ç¬”è®°
---

æœ¬ç« å°†ç»™å‡ºå„ç§å®ç°å–æ¶ˆå’Œä¸­æ–­çš„æœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä»»åŠ¡å’ŒæœåŠ¡ï¼Œä½¿å®ƒä»¬èƒ½å¯¹å–æ¶ˆè¯·æ±‚åšå‡ºå“åº”ã€‚

# ä»»åŠ¡å–æ¶ˆ

å¯å–æ¶ˆçš„æ“ä½œ ï¼šã€€å¤–éƒ¨ä»£ç èƒ½åœ¨æŸä¸ªæ“ä½œæ­£å¸¸å®Œæˆä¹‹å‰å°†å…¶ç½®å…¥â€œå®Œæˆâ€çŠ¶æ€

å–æ¶ˆæŸä¸ªæ“ä½œçš„åŸå› ï¼š

- ç‚¹å‡»æŸä¸ªæ¡Œé¢åº”ç”¨ä¸­çš„å–æ¶ˆæŒ‰é’®æ—¶ï¼› 
- æŸä¸ªæ“ä½œè¶…è¿‡äº†ä¸€å®šçš„æ‰§è¡Œæ—¶é—´é™åˆ¶éœ€è¦ä¸­æ­¢æ—¶ï¼› 
- å¤šä¸ªçº¿ç¨‹åšç›¸åŒçš„äº‹æƒ…ï¼Œåªè¦ä¸€ä¸ªçº¿ç¨‹æˆåŠŸå…¶å®ƒçº¿ç¨‹éƒ½å¯ä»¥å–æ¶ˆæ—¶ï¼› 
- ä¸€ç»„çº¿ç¨‹ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå‡ºç°é”™è¯¯å¯¼è‡´æ•´ç»„éƒ½æ— æ³•ç»§ç»­æ—¶ï¼› 
- å½“ä¸€ä¸ªåº”ç”¨æˆ–æœåŠ¡éœ€è¦åœæ­¢æ—¶ã€‚

Javaä¸­æ²¡æœ‰ä¸€ç§å®‰å…¨çš„æŠ¢å å¼æ–¹æ³•æ¥åœæ­¢çº¿ç¨‹ï¼Œåªæœ‰ä¸€äº›åä½œå¼çš„æœºåˆ¶ï¼Œä»£ç éƒ½ä¼šéµå¾ªçš„ä¸€ç§åè®®ã€‚

æ¯”å¦‚ï¼š

> **â€œå·²è¯·æ±‚å–æ¶ˆâ€æ ‡å¿—**
>
> ä»»åŠ¡å°†å®šæœŸåœ°æŸ¥çœ‹è¿™ä¸ªæ ‡å¿—ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ï¼Œé‚£ä¹ˆä»»åŠ¡å°†æå‰ç»“æŸã€‚

ğŸ˜ŠPrimeGeneratoræŒç»­åœ°æšä¸¾ç´ æ•°ï¼ˆPrimeï¼‰ï¼Œç›´åˆ°cancelledè¢«è®¾ç½®ã€‚ä¸ºäº†ç¡®ä¿å¯é æ€§cancelledè¢«è®¾ç½®ä¸ºvolatileã€‚

```java
//        7-1      ä½¿ç”¨Volatileç±»å‹çš„åŸŸæ¥ä¿å­˜å–æ¶ˆçŠ¶æ€  
public class PrimeGenerator implements Runnable{
    private final List<BigInteger> primes=
            new ArrayList<BigInteger>();
    private volatile boolean cancelled;//volatileå˜é‡èƒ½ç¡®ä¿å¯è§æ€§ ç¦æ­¢æŒ‡ä»¤é‡æ’åº

    public void run(){
        BigInteger p=BigInteger.ONE;//å¸¸é‡
        while(!cancelled){  //ä»»åŠ¡å°†å®šæœŸåœ°æŸ¥çœ‹è¿™ä¸ªæ ‡å¿—ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ï¼Œé‚£ä¹ˆä»»åŠ¡å°†æå‰ç»“æŸã€‚ï¼ˆå³å¦‚æœcancelledä¸ä¸ºtrueåˆ™ä¸€ç›´è¿è¡Œï¼‰
            p=p.nextProbablePrime();//è¿”å›ä¸€ä¸ªæ¯”å½“å‰å¤§çš„
            synchronized (this) { //ç¡®ä¿ä¸ä¼šè¢«æ·»åŠ å¤šæ¬¡
                primes.add(p);
            }
        }
    }

    public void cancel(){
        cancelled=true;      //å°†â€œå·²è¯·æ±‚å–æ¶ˆæ ‡å¿—â€å–ä¸ºtrue
    }

    public synchronized List<BigInteger> get(){
        return new ArrayList<BigInteger>(primes);
    }
}
```

ä¸Šé¢ä»£ç çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œä¸€ä¸ªä»…è¿è¡Œä¸€ç§’çš„ç´ æ•°ç”Ÿæˆå™¨

```java
//            7-2      ä¸€ä¸ªä»…è¿è¡Œä¸€ç§’çš„ç´ æ•°ç”Ÿæˆå™¨
  static List<BigInteger> aSecondOfPrimes() throws InterruptedException{
        PrimeGenerator generator=new PrimeGenerator();
        new Thread(generator).start();
        try{
            SECONDS.sleep(1); //å»¶è¿Ÿä¸€ç§’æ‰æ‰§è¡Œcancel
        }finally{
            generator.cancel();
        }
        return generator.get();

    }
```

cancelæ–¹æ³•ç”±finallyå—è°ƒç”¨ï¼Œç¡®ä¿å³ä½¿åœ¨è°ƒç”¨sleepæ—¶è¢«ä¸­æ–­ä¹Ÿèƒ½å–æ¶ˆç´ æ•°ç”Ÿæˆå™¨çš„æ‰§è¡Œã€‚

## ä¸­æ–­

PrimeGeneratorçš„é—®é¢˜ï¼šæœä½¿ç”¨è¿™ç§æ–¹æ³•çš„ä»»åŠ¡è°ƒç”¨äº†ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œä¾‹å¦‚BlockingQueue.putï¼Œé‚£ä¹ˆä»»åŠ¡å¯èƒ½æ°¸è¿œä¸ä¼šæ£€æŸ¥å–æ¶ˆæ ‡å¿—ï¼Œå› æ­¤æ°¸è¿œä¸ä¼šç»“æŸã€‚

ğŸ˜§ç”Ÿäº§è€…çº¿ç¨‹ç”Ÿæˆç´ æ•°ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚å¦‚æœç”Ÿæˆè€…çš„é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦ï¼Œ é˜Ÿåˆ—å°†è¢«å¡«æ»¡ï¼Œputæ–¹æ³•ä¹Ÿä¼šé˜»å¡ã€‚å› æ­¤ï¼Œç”Ÿäº§è€…å´æ°¸è¿œä¸èƒ½æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ã€‚

```java
//             7-3    ä¸å¯é çš„å–æ¶ˆæ“ä½œå§ç”Ÿæˆè€…ç½®äºé˜»å¡çš„æ“ä½œä¸­ï¼ˆä¸è¦è¿™ä¹ˆåšï¼‰
public class BrokenPrimeProducer extends Thread {
       private final BlockingQueue<BigInteger> queue;
       private volatile boolean cancelled=false;

      public BrokenPrimeProducer(BlockingQueue<BigInteger> queue) {
        this.queue=queue;
      }

      public void run(){
          try{
              BigInteger p=BigInteger.ONE;
              while(!cancelled){
                  queue.put(p=p.nextProbablePrime());
              }
          }catch (InterruptedException consumed) {

        }
      }
}

void consumePrimes() throws InterruptedException{
    BlockingQueue<BigInteger> primes=new ArrayBlockingQueue<>(MAX_PRIORITY);
    BrokenPrimeProducer producer=new BrokenPrimeProducer(primes);
    producer.start();
    try{
        while(needMorePrimes())              //å¦‚æœéœ€è¦ç»§ç»­æ¶ˆè´¹
            consume(primes.take());
    }finally{              
        //å®ƒå¯ä»¥è°ƒç”¨cancelæ–¹æ³•æ¥è®¾ç½®cancelledæ ‡å¿—ï¼Œä½†æ­¤æ—¶ç”Ÿäº§è€…å´æ°¸è¿œä¸èƒ½æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œå› ä¸ºå®ƒæ— æ³•ä»é˜»å¡çš„putæ–¹æ³•ä¸­æ¢å¤è¿‡æ¥ï¼ˆå› ä¸ºæ¶ˆè´¹è€…æ­¤æ—¶å·²ç»åœæ­¢ä»é˜Ÿåˆ—ä¸­å–å‡ºç´ æ•°ï¼Œæ‰€ä»¥putæ–¹æ³•å°†ä¸€ç›´ä¿æŒé˜»å¡çŠ¶æ€ã€‚ï¼‰
        producer.cancel();
    }
}
```

> **Threadçš„ä¸­æ–­**
> é˜»å¡åº“æ–¹æ³•å®šæœŸæ£€æŸ¥Threadçš„ä¸­æ–­ï¼Œå¹¶åœ¨é€‚å½“æ—¶å€™åœæ­¢å½“å‰å·¥ä½œ

**Threadä¸­çš„ä¸­æ–­æ–¹æ³•** ï¼š æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªbooleanç±»å‹çš„ä¸­æ–­çŠ¶æ€ã€‚å½“ä¸­æ–­çº¿ç¨‹æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†è¢«è®¾ç½®ä¸ºtrueã€‚

åœ¨Threadä¸­åŒ…å«äº†ä¸­æ–­çº¿ç¨‹ä»¥åŠæŸ¥è¯¢çº¿ç¨‹ä¸­æ–­çŠ¶æ€çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

- interruptæ–¹æ³•èƒ½ä¸­æ–­ç›®æ ‡çº¿ç¨‹ 
- isInterruptæ–¹æ³•èƒ½è¿”å›ç›®æ ‡çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ 
- é™æ€çš„interruptedæ–¹æ³•å°†æ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¹¶è¿”å›å®ƒä¹‹å‰çš„å€¼ï¼Œè¿™ä¹Ÿæ˜¯æ¸…é™¤ä¸­æ–­çŠ¶æ€çš„å”¯ä¸€æ–¹æ³•ã€‚

é˜»å¡åº“æ–¹æ³•ï¼Œå¦‚Thread.sleepå’ŒObject.waitï¼Œåœ¨å‘ç°ä¸­æ–­æ—¶æå‰è¿”å›ã€‚å®ƒä»¬åœ¨å“åº”ä¸­æ–­æ—¶ä¼šï¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼ŒæŠ›å‡ºInterruptedException

**è°ƒç”¨Interruptå¹¶ä¸æ„å‘³ç€ç«‹å³åœæ­¢ç›®æ ‡çº¿ç¨‹æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œè€Œåªæ˜¯ä¼ é€’äº†è¯·æ±‚ä¸­æ–­çš„æ¶ˆæ¯ã€‚**

ä¸Šé¢çš„BrokenPrimeProducerçš„è§£å†³æ–¹å¼ï¼šè¿›è¡Œé˜»å¡çš„BlockingQueueå¯ä»¥æ£€æµ‹Threadçš„interruptï¼Œæ‰€ä»¥ç”¨interruptä»£æ›¿è‡ªå®šä¹‰çš„ä¸­æ–­æ–¹å¼ã€‚

```java
//       7-5 é€šè¿‡ä¸­æ–­æ¥å–æ¶ˆ
public class PrimeProducer extends Thread {
    private final BlockingQueue<BigInteger> queue;

    PrimeProducer(BlockingQueue<BigInteger> queue) {
        this.queue = queue;
    }

    public void run() {
        try {
            BigInteger p = BigInteger.ONE;
            //åœ¨æ¯æ¬¡è¿­ä»£å¾ªç¯ä¸­ï¼Œæœ‰ä¸¤ä¸ªä½ç½®å¯ä»¥æ£€æµ‹å‡ºä¸­æ–­ï¼šåœ¨é˜»å¡çš„putæ–¹æ³•ä¸­è°ƒç”¨ï¼Œä»¥åŠåœ¨å¾ªç¯å¼€å§‹å¤„æŸ¥è¯¢ä¸­æ–­çŠ¶æ€ã€‚
            while (!Thread.currentThread().isInterrupted())
                queue.put(p = p.nextProbablePrime());
        } catch (InterruptedException consumed) {
            /* å…è®¸çº¿ç¨‹é€€å‡º */
        }
    }

    public void cancel() {
        interrupt();
    }
}
```

## ä¸­æ–­ç­–ç•¥

ä¸­æ–­ç­–ç•¥ï¼šåœ¨å‘ç°ä¸­æ–­è¯·æ±‚æ—¶åº”è¯¥åšå“ªäº›å·¥ä½œ

æœ€åˆç†çš„ç»ˆç«¯ç­–ç•¥ï¼šå°½å¿«é€€å‡ºï¼Œå¹¶æŠŠä¸­æ–­ä¿¡æ¯ä¼ é€’ç»™è°ƒç”¨è€…ï¼Œä»è€Œä½¿è°ƒç”¨æ ˆä¸­çš„ä¸Šå±‚ä»£ç å¯ä»¥é‡‡å–è¿›ä¸€æ­¥çš„æ“ä½œã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°å¯é˜»å¡çš„åº“å‡½æ•°éƒ½åªæ˜¯æŠ›å‡ºInterruptedExceptionä½œä¸ºä¸­æ–­å“åº”ã€‚å®ƒä»¬æ°¸è¿œä¸ä¼šåœ¨æŸä¸ªç”±è‡ªå·±æ‹¥æœ‰çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œå› æ­¤å®ƒä»¬ä¸ºä»»åŠ¡æˆ–åº“ä»£ç å®ç°äº†è¿™ä¸ªæœ€åˆç†çš„å–æ¶ˆç­–ç•¥ã€‚ä½†å®ƒå¯ä»¥æ¨è¿Ÿå¤„ç†ä¸­æ–­è¯·æ±‚ï¼Œå¹¶ç›´åˆ°æŸä¸ªæ›´åˆé€‚çš„æ—¶åˆ»ï¼Œåœ¨æŠ›å‡ºInterruptedExceptionã€‚

## å“åº”ä¸­æ–­

æœ‰ä¸¤ç§å®ç”¨ç­–ç•¥å¯ç”¨äºå¤„ç†InterruptedExceptionï¼š 

- **ä¼ é€’å¼‚å¸¸**ï¼ˆå¯èƒ½åœ¨æŸä¸ªç‰¹å®šäºä»»åŠ¡é¢æ¸…é™¤æ“ä½œä¹‹åï¼‰ï¼Œä»è€Œä½¿ä½ çš„æ–¹æ³•ä¹Ÿç§°ä¸ºå¯ä¸­æ–­çš„é˜»å¡æ–¹æ³•ã€‚

- **æ¢å¤ä¸­æ–­çŠ¶æ€**ï¼Œä»è€Œä½¿è°ƒç”¨æ ˆä¸Šçš„ä¸Šå±‚ä»£ç èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ä¹Ÿå°±æ˜¯è°ƒç”¨interrupt

# Reference

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜](https://book.douban.com/subject/10484692/)

[æºä»£ç ](http://jcip.net/listings.html)

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼ˆå­¦ä¹ ç¬”è®°å…­ ç¬¬ä¸ƒç«  å–æ¶ˆä¸å…³é—­ ä¸Šï¼‰](https://blog.csdn.net/ahaha413525642/article/details/76815299)