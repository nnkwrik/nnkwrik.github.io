---
title: å¹¶å‘æ“ä½œåˆé›†-7.å¹¶å‘å®¹å™¨ï¼šBlockingQueue
typora-copy-images-to: 20181102-3
date: 2018-11-04 11:15:21
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
---

> ğŸ¤ [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— ç›®å½•]()
>
> ğŸ• [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

è¿™ä¸€ç¯‡æ–‡ç« ä¹Ÿä¼šä»‹ç»ä¸€ä¸ªå¹¶å‘å®¹å™¨ï¼ŒBlockingQueueã€‚

# BlockingQueue

é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚

é˜»å¡é˜Ÿåˆ—æä¾›äº†å››ç§å¤„ç†æ–¹æ³•:

| æ–¹æ³•\å¤„ç†æ–¹å¼ | æŠ›å‡ºå¼‚å¸¸  | è¿”å›ç‰¹æ®Šå€¼ | ä¸€ç›´é˜»å¡ | è¶…æ—¶é€€å‡º           |
| ------------- | --------- | ---------- | -------- | ------------------ |
| æ’å…¥æ–¹æ³•      | add(e)    | offer(e)   | put(e)   | offer(e,time,unit) |
| ç§»é™¤æ–¹æ³•      | remove()  | poll()     | take()   | poll(time,unit)    |
| æ£€æŸ¥æ–¹æ³•      | element() | peek()     | ä¸å¯ç”¨   | ä¸å¯ç”¨             |

- æŠ›å‡ºå¼‚å¸¸ï¼šæ˜¯æŒ‡å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶å€™ï¼Œå†å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œä¼šæŠ›å‡ºIllegalStateException(â€œQueue fullâ€)å¼‚å¸¸ã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ æ—¶ä¼šæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸ ã€‚
- è¿”å›ç‰¹æ®Šå€¼ï¼šæ’å…¥æ–¹æ³•ä¼šè¿”å›æ˜¯å¦æˆåŠŸï¼ŒæˆåŠŸåˆ™è¿”å›trueã€‚ç§»é™¤æ–¹æ³•ï¼Œåˆ™æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null
- ä¸€ç›´é˜»å¡ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°æ‹¿åˆ°æ•°æ®ï¼Œæˆ–è€…å“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¹Ÿä¼šé˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚
- è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚

##  Javaé‡Œçš„é˜»å¡é˜Ÿåˆ—

JDK7æä¾›äº†7ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚åˆ†åˆ«æ˜¯

- LinkedBlockingQueue ï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- ArrayBlockingQueue ï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- PriorityBlockingQueue ï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚
- DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
- LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚

### LinkedBlockingQueue

LinkedBlockingQueueæ˜¯ä¸€ä¸ªç”¨é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—çš„é»˜è®¤å’Œæœ€å¤§é•¿åº¦ä¸ºInteger.MAX_VALUEã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚

### ArrayBlockingQueue

ArrayBlockingQueueæ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯è®¿é—®è€…å…¬å¹³çš„è®¿é—®é˜Ÿåˆ—ï¼Œæ‰€è°“å…¬å¹³è®¿é—®é˜Ÿåˆ—æ˜¯æŒ‡é˜»å¡çš„æ‰€æœ‰ç”Ÿäº§è€…çº¿ç¨‹æˆ–æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå½“é˜Ÿåˆ—å¯ç”¨æ—¶ï¼Œå¯ä»¥æŒ‰ç…§é˜»å¡çš„å…ˆåé¡ºåºè®¿é—®é˜Ÿåˆ—ï¼Œå³å…ˆé˜»å¡çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œå¯ä»¥å…ˆå¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œå…ˆé˜»å¡çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå¯ä»¥å…ˆä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ ã€‚é€šå¸¸æƒ…å†µä¸‹ä¸ºäº†ä¿è¯å…¬å¹³æ€§ä¼šé™ä½ååé‡ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç åˆ›å»ºä¸€ä¸ªå…¬å¹³çš„é˜»å¡é˜Ÿåˆ—ï¼š

```java
ArrayBlockingQueue fairQueue = new  ArrayBlockingQueue(1000,true);
```

### PriorityBlockingQueue

PriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡å–è‡ªç„¶é¡ºåºæ’åˆ—ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ¯”è¾ƒå™¨comparatoræ¥æŒ‡å®šå…ƒç´ çš„æ’åºè§„åˆ™ã€‚å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—ã€‚

### SynchronousQueue

SynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚SynchronousQueueå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¼ çƒæ‰‹ï¼Œè´Ÿè´£æŠŠç”Ÿäº§è€…çº¿ç¨‹å¤„ç†çš„æ•°æ®ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…çº¿ç¨‹ã€‚é˜Ÿåˆ—æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œéå¸¸é€‚åˆäºä¼ é€’æ€§åœºæ™¯,æ¯”å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®ï¼Œä¼ é€’ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ŒSynchronousQueueçš„ååé‡é«˜äºLinkedBlockingQueue å’Œ ArrayBlockingQueueã€‚

### DelayQueue

DelayQueueæ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä½¿ç”¨PriorityQueueæ¥å®ç°ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œåœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚åªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥å°†DelayQueueè¿ç”¨åœ¨ä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼š

- ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡ï¼šå¯ä»¥ç”¨DelayQueueä¿å­˜ç¼“å­˜å…ƒç´ çš„æœ‰æ•ˆæœŸï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯æŸ¥è¯¢DelayQueueï¼Œä¸€æ—¦èƒ½ä»DelayQueueä¸­è·å–å…ƒç´ æ—¶ï¼Œè¡¨ç¤ºç¼“å­˜æœ‰æ•ˆæœŸåˆ°äº†ã€‚
- å®šæ—¶ä»»åŠ¡è°ƒåº¦ã€‚ä½¿ç”¨DelayQueueä¿å­˜å½“å¤©å°†ä¼šæ‰§è¡Œçš„ä»»åŠ¡å’Œæ‰§è¡Œæ—¶é—´ï¼Œä¸€æ—¦ä»DelayQueueä¸­è·å–åˆ°ä»»åŠ¡å°±å¼€å§‹æ‰§è¡Œï¼Œä»æ¯”å¦‚TimerQueueå°±æ˜¯ä½¿ç”¨DelayQueueå®ç°çš„ã€‚

é˜Ÿåˆ—ä¸­çš„Delayedå¿…é¡»å®ç°compareToæ¥æŒ‡å®šå…ƒç´ çš„é¡ºåºã€‚

### LinkedTransferQueue

LinkedTransferQueueæ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡TransferQueueé˜Ÿåˆ—ã€‚ç›¸å¯¹äºå…¶ä»–é˜»å¡é˜Ÿåˆ—LinkedTransferQueueå¤šäº†tryTransferå’Œtransferæ–¹æ³•ã€‚

**transferæ–¹æ³•**ã€‚å¦‚æœå½“å‰æœ‰æ¶ˆè´¹è€…æ­£åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼ˆæ¶ˆè´¹è€…ä½¿ç”¨take()æ–¹æ³•æˆ–å¸¦æ—¶é—´é™åˆ¶çš„poll()æ–¹æ³•æ—¶ï¼‰ï¼Œtransferæ–¹æ³•å¯ä»¥æŠŠç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ ç«‹åˆ»transferï¼ˆä¼ è¾“ï¼‰ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œtransferæ–¹æ³•ä¼šå°†å…ƒç´ å­˜æ”¾åœ¨é˜Ÿåˆ—çš„tailèŠ‚ç‚¹ï¼Œå¹¶ç­‰åˆ°è¯¥å…ƒç´ è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚ç”Ÿäº§è€…ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æ‰€æ·»åŠ åˆ°é˜Ÿåˆ—çš„å…ƒç´ è¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹

**tryTransferæ–¹æ³•**ã€‚åˆ™æ˜¯ç”¨æ¥è¯•æ¢ä¸‹ç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ æ˜¯å¦èƒ½ç›´æ¥ä¼ ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œåˆ™è¿”å›falseã€‚å’Œtransferæ–¹æ³•çš„åŒºåˆ«æ˜¯tryTransferæ–¹æ³•æ— è®ºæ¶ˆè´¹è€…æ˜¯å¦æ¥æ”¶ï¼Œæ–¹æ³•ç«‹å³è¿”å›ã€‚è€Œtransferæ–¹æ³•æ˜¯å¿…é¡»ç­‰åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚

å¯¹äºå¸¦æœ‰æ—¶é—´é™åˆ¶çš„tryTransfer(E e, long timeout, TimeUnit unit)æ–¹æ³•ï¼Œåˆ™æ˜¯è¯•å›¾æŠŠç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ ç›´æ¥ä¼ ç»™æ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹è¯¥å…ƒç´ åˆ™ç­‰å¾…æŒ‡å®šçš„æ—¶é—´å†è¿”å›ï¼Œå¦‚æœè¶…æ—¶è¿˜æ²¡æ¶ˆè´¹å…ƒç´ ï¼Œåˆ™è¿”å›falseï¼Œå¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ¶ˆè´¹äº†å…ƒç´ ï¼Œåˆ™è¿”å›trueã€‚

### LinkedBlockingDeque

LinkedBlockingDequeæ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„ä½ å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚åŒç«¯é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚ç›¸æ¯”å…¶ä»–çš„é˜»å¡é˜Ÿåˆ—ï¼ŒLinkedBlockingDequeå¤šäº†addFirstï¼ŒaddLastï¼ŒofferFirstï¼ŒofferLastï¼ŒpeekFirstï¼ŒpeekLastç­‰æ–¹æ³•ï¼Œä»¥Firstå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–ï¼ˆpeekï¼‰æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ä»¥Lastå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æ’å…¥æ–¹æ³•addç­‰åŒäºaddLastï¼Œç§»é™¤æ–¹æ³•removeç­‰æ•ˆäºremoveFirstã€‚ä½†æ˜¯takeæ–¹æ³•å´ç­‰åŒäºtakeFirstï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯Jdkçš„bugï¼Œä½¿ç”¨æ—¶è¿˜æ˜¯ç”¨å¸¦æœ‰Firstå’ŒLaståç¼€çš„æ–¹æ³•æ›´æ¸…æ¥šã€‚åœ¨åˆå§‹åŒ–LinkedBlockingDequeæ—¶å¯ä»¥åˆå§‹åŒ–é˜Ÿåˆ—çš„å®¹é‡ï¼Œç”¨æ¥é˜²æ­¢å…¶å†æ‰©å®¹æ—¶è¿‡æ¸¡è†¨èƒ€ã€‚å¦å¤–åŒå‘é˜»å¡é˜Ÿåˆ—å¯ä»¥è¿ç”¨åœ¨â€œå·¥ä½œçªƒå–â€æ¨¡å¼ä¸­ã€‚

å…³äºLinkedBlockingDequeçš„å·¥ä½œçªƒå–ç¤ºä¾‹å¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/hxpjava1/article/details/44245593)

# ç¤ºä¾‹ï¼šå†çœ‹å‘é€è€…-æ¥å—è€…é—®é¢˜

åœ¨ä¹‹å‰2.çŠ¶æ€è½¬æ¢æ–¹æ³•ä¸€ç« ä¸­ï¼Œç”¨wait/notifyå†™è¿‡ä¸€ä¸ªå‘é€è€…-æ¥å—è€…ï¼ˆå…¶å®æœ¬è´¨å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼‰çš„ä¾‹å­ã€‚è¿™æ¬¡æˆ‘ä»¬ç”¨BlokingQueueæ¥å®ç°è¿™ä¸ªé—®é¢˜ã€‚

Dataç±»æ¥å®ç°æ•°æ®åŒ…çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ“ä½œï¼š

```java
public class Data {

    private BlockingQueue<String> queue;

    public Data(BlockingQueue queue) {
        this.queue = queue;
    }

    public String receive() {

        try {
            String packet = queue.take();
            System.out.println(Thread.currentThread().getName() + " receive: " + packet);
            return packet+ " <======= FROM " + Thread.currentThread().getName();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            e.printStackTrace();
        }
        return null;

    }

    public void send(String packet) {

        try {
            System.out.println(Thread.currentThread().getName() + " send: " + packet);
            queue.put(packet);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            e.printStackTrace();
        }
    }
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¹‹å‰æˆ‘ä»¬ä½¿ç”¨waitæ—¶ï¼Œä½¿ç”¨synchronizeåŒ…ä½äº†receive()å’Œsend()æ–¹æ³•ï¼Œè¿™åœ¨BlockingQueueä¸­æ˜¯ä¸éœ€è¦çš„ï¼Œå¦åˆ™ä¼šäº§ç”Ÿæ­»é”ã€‚

ä¸‹é¢æ˜¯Senderç±»å’ŒReceiverç±»ï¼Œå®ƒä»¬å°†å¯¹Dataç±»è¿›è¡ŒåŒæ­¥æ“ä½œï¼š

Senderç±»

```java
public class Sender implements Runnable {

    protected Data data;

    public Sender(Data data) {
        this.data = data;
    }

    @Override
    public void run() {
        String packets[] = {
                "First packet",
                "Second packet",
                "Third packet",
                "Fourth packet",
                "End"
        };
        for (String packet : packets) {
            data.send(packet);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                System.out.println("Thread Interrupted");
            }
        }

    }
}
```

Receiverç±»ï¼š

```java
public class Receiver implements Runnable {

    private Data load;
    private int senderNum = 1;

    public Receiver(Data load, int consumerNum) {
        this.load = load;
        this.senderNum = consumerNum;
    }

    public Receiver(Data load) {
        this.load = load;
    }

    @Override
    public void run() {
        while (senderNum >= 0) {

            String receivedMessage = load.receive();
            if ("End".equals(receivedMessage)) senderNum--;

            System.out.println("=======> " + receivedMessage);

            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                System.out.println("Thread Interrupted");
            }
        }
    }
}
```

ä¸€ç›´æ¥å—æ•°æ®åŒ…å¹¶è¾“å‡ºï¼Œç›´åˆ°ä»æ‰€æœ‰çº¿ç¨‹æ”¶åˆ°â€œEndâ€æ•°æ®åŒ…ã€‚

## LinkedBlockingQueue

ç”¨LinkedBlockingDequeå®ç°ä¸€ä¸ªBlockingQueueï¼ŒLinkedBlockingDequeæ˜¯åˆ›å»ºBlockingQueueæ—¶æœ€ç®€å•ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„åˆ›å»ºBlockingQueueæ–¹æ³•ã€‚

```java
BlockingQueue<String> blockingQueue = new LinkedBlockingDeque<>();
Data data = new Data(blockingQueue);
Thread sender = new Thread(new Sender(data), "Sender Thread");
Thread receiver = new Thread(new Receiver(data), "Receiver Thread");

sender.start();
receiver.start();
```

## ArrayBlockingQueue

ç”¨ArrayBlockingQueueå®ç°å¤§å°ä¸º100,å¹¶ä¸€ä¸ªå…·å¤‡å…¬å¹³é”çš„BlockingQueueï¼ŒæŠŠè¿™ä¸ªBlockingQueueä¼ ç»™å‘é€è€…çº¿ç¨‹å’Œæ¥å—è€…çº¿ç¨‹ï¼š

```java
BlockingQueue<String> blockingQueue = new ArrayBlockingQueue<>(100, true);
Data data = new Data(blockingQueue);
Thread sender = new Thread(new Sender(data), "Sender Thread");
Thread receiver = new Thread(new Receiver(data), "Receiver Thread");

sender.start();
receiver.start();
```

## PriorityBlockingQueue

PriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜Ÿåˆ—ã€‚æˆ‘ä»¬ç»™å®ƒä¸€ä¸ªå€’åºçš„æ¯”è¾ƒå™¨ï¼Œè®©å®ƒè¾“å‡ºè¾“å‡ºå­—æ¯å€’åºåçš„ç»“æœã€‚

```java
//æŒ‰å­—æ¯æ’åºï¼Œè¾“å‡ºå­—ç¬¦ä¸²å€’åºåçš„ç»“æœ
BlockingQueue<String> blockingQueue = new PriorityBlockingQueue<>(100, Comparator.reverseOrder());
Data data = new Data(blockingQueue);
Thread sender = new Thread(new Sender(data), "Sender Thread");
Thread receiver = new Thread(new Receiver(data), "Receiver Thread");

sender.start();
sender.join();  //ç­‰å‘é€æ–¹å…¨éƒ¨å‘é€å®Œæˆ
receiver.start();	//è¾“å‡º Third packetï¼ŒSecond packetï¼Œ Fourth packet ... End
```

## SynchronousQueue

SynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚

ä»ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œåªæœ‰æœ€åè¢«æ”¾å…¥çš„å…ƒç´ ä¼šè¢«å–åˆ°ï¼Œè€Œå‘é€è€…æ”¾å…¥çš„å¤§å¤šæ•°æ•°æ®éƒ½ä¸¢å¤±äº†ã€‚

```java
//åªä¼šå–åˆ°æœ€åè¢«æ”¾å…¥çš„å…ƒç´ 
BlockingQueue<String> blockingQueue = new SynchronousQueue<>();
int senderNum = 3;
Data data = new Data(blockingQueue);
for (int i = 0; i < senderNum; i++) {
    Thread sender = new Thread(new Sender(data), "Sender Thread" + i);
    sender.start();

}
Thread receiver = new Thread(new Receiver(data, senderNum), "Receiver Thread");

receiver.start();
```

## DelayQueue

DelayQueueä¸­çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œåœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚æˆ‘ä»¬éœ€è¦å…ˆæŠŠæ•°æ®åŒ…åŒ…è£…æˆDelayedï¼š

```java
public class DelayPacket implements Delayed {

    private String data;
    private long startTime;


    DelayPacket(String data, long delayInMilliseconds) {
        this.data = data;
        this.startTime = System.currentTimeMillis() + delayInMilliseconds;
    }

    @Override
    public long getDelay(TimeUnit unit) {
        long diff = startTime - System.currentTimeMillis();
        return unit.convert(diff, TimeUnit.MILLISECONDS);
    }

    @Override
    public int compareTo(Delayed o) {	//å®ƒæ˜¯æ”¯æŒä¼˜å…ˆé˜Ÿåˆ—çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å®ƒçš„æ’åºæ–¹å¼
        return (int) ( this.getDelay(TimeUnit.MILLISECONDS) - o.getDelay(TimeUnit.MILLISECONDS));
    }

    @Override
    public String toString() {
        return "{" + "data='" + data + '\'' + ", startTime=" + startTime + '}';
    }
}
```

ä¸ºäº†èƒ½å‘é€å’Œå–åˆ°åŒ…è£…åçš„å»¶è¿Ÿæ•°æ®åŒ…ï¼Œæˆ‘ä»¬æŠŠDataæ”¹ä¸ºå¦‚ä¸‹

```java
public class Data {
    private DelayQueue<DelayPacket> delayQueue;
    private final int DELAY = 3000; //3ç§’å‘é€å»¶è¿Ÿ

    public Data(DelayQueue delayQueue) {
        this.delayQueue = delayQueue;
    }
    public String receive() {
        try {
            String packet = delayQueue.take().toString();
            System.out.println(Thread.currentThread().getName() + " receive: " + packet);
            return packet+ " <======= FROM " + Thread.currentThread().getName();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            e.printStackTrace();
        }
        return null;

    }
    public void send(String packet) {
        System.out.println(Thread.currentThread().getName() + " send: " + packet);
        DelayPacket delayPacket = new DelayPacket(packet, DELAY);
        delayQueue.put(delayPacket);
    }
}
```

å¯åŠ¨çº¿ç¨‹ï¼Œæ¥æ”¶è€…å°†åœ¨å‘é€è€…å‘é€çš„5ç§’åæ”¶åˆ°æ•°æ®åŒ…

```java
DelayQueue<DelayPacket> delayQueue = new DelayQueue<>();

DData data = new DData(delayQueue);
Thread sender = new Thread(new Sender(data), "Sender Thread");
Thread receiver = new Thread(new Receiver(data), "Receiver Thread");

sender.start();
receiver.start();   //å»¶è¿Ÿ3ç§’åæ”¶åˆ°
```

## LinkedTransferQueue

ä½¿ç”¨LinkedTransferQueueçš„transferæ–¹æ³•ï¼Œç”Ÿäº§è€…ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æ‰€æ·»åŠ åˆ°é˜Ÿåˆ—çš„å…ƒç´ è¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ä¸ºäº†æµ‹è¯•LinkedTransferQueueéœ€è¦å…ˆæŠŠDataç±»çš„å‘é€è€…put()çš„éƒ¨åˆ†æ”¹ä¸ºtransfer()ã€‚

å¯¹Dataç±»è¿›è¡Œä¿®æ”¹ï¼š

```java
private TransferQueue<String> transferQueue;
...
public void send(String packet) {
...
    transferQueue.transfer(packet + " FROM " + Thread.currentThread().getName());
...
}
```

æµ‹è¯•LinkedTransferQueueï¼Œå¯åŠ¨å¤šä¸ªå‘é€è€…çº¿ç¨‹ï¼Œæ¯ä¸ªå‘é€è€…ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è‡ªå·±æ”¾å…¥çš„å…ƒç´ è¢«å–èµ°ã€‚

```java
//ç”Ÿäº§è€…ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è‡ªå·±æ”¾å…¥çš„å…ƒç´ è¢«å–èµ°
TransferQueue<String> blockingQueue = new LinkedTransferQueue<>();

TData data = new TData(blockingQueue);
for (int i = 0; i < 3; i++) {
    Thread sender = new Thread(new Sender(data), "Sender Thread" + i);
    sender.start();

}
Thread receiver = new Thread(new Receiver(data), "Receiver Thread");
receiver.start();
```

ä¹ä¸€çœ‹å’ŒSynchronousQueueæœ‰ç‚¹ç›¸ä¼¼ï¼Œéƒ½æ˜¯åœ¨ç”Ÿäº§è€…æ”¾å…¥çš„å…ƒç´ è¢«å–èµ°å‰è¿›è¡Œè¿›è¡Œé˜»å¡ã€‚ä¸åŒçš„æ˜¯SynchronousQueueåªä¼šä¿ç•™**æ‰€æœ‰çº¿ç¨‹ä¸­æœ€åè¢«æ”¾å…¥**çš„é‚£ä¸ªå…ƒç´ ã€‚å’ŒSynchronousQueueä¸åŒLinkedTransferQueueä¸ä¼šä¸¢å¤±æ•°æ®åŒ…ã€‚

# Reference

[èŠèŠå¹¶å‘ï¼ˆä¸ƒï¼‰â€”â€”Javaä¸­çš„é˜»å¡é˜Ÿåˆ—](http://ifeve.com/java-blocking-queue/)

[Guide to DelayQueue](http://www.baeldung.com/java-delay-queue)