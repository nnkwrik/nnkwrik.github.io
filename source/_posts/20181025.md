---
title: Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬2ç« -çº¿ç¨‹å®‰å…¨æ€§
typora-copy-images-to: 20181025
date: 2018-10-25 15:44:01
tags:
  - Java
  - å¹¶å‘
  - ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹
categories:
  - è¯»ä¹¦ç¬”è®°
---

ç¼–å†™çº¿ç¨‹å®‰å…¨çš„ä»£ç  å°±æ˜¯å¯¹`å…±äº«çš„`å’Œ`å¯å˜çš„`çŠ¶æ€è®¿é—®æ“ä½œè¿›è¡Œç®¡ç†ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯çŠ¶æ€ï¼Ÿ

çŠ¶æ€æ˜¯æŒ‡å­˜å‚¨åœ¨çŠ¶æ€å˜é‡æ€»çš„æ•°æ®ã€‚æ¯”å¦‚æŸä¸ªHashMapçš„çŠ¶æ€ï¼Œä¸ä»…æ˜¯HashMapæœ¬èº«,ä¹ŸåŒ…æ‹¬å­˜å‚¨çš„Map.Entryå¯¹è±¡ã€‚å¯¹å¤–éƒ¨æœ‰å½±å“çš„æ•°æ®éƒ½èƒ½ç§°ä¸ºæ˜¯çŠ¶æ€ã€‚

- `å…±äº«çš„` : å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„å˜é‡
- `å¯å˜çš„` : å˜é‡çš„å€¼åœ¨ç”Ÿå‘½å‘¨æœŸå†…å¯ä»¥å‘ç”Ÿå˜åŒ–

å¦‚æœä¸€ä¸ªå¯¹è±¡ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œé‚£ä¹ˆä»–å°±éœ€è¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤éœ€è¦é‡‡ç”¨åŒæ­¥æœºåˆ¶æ¥ååŒå¯¹è±¡å¯å˜çŠ¶æ€çš„è®¿é—®ã€‚å¦‚æœä¸èƒ½ååŒï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½äº§ç”Ÿä¸è¯¥å‡ºç°çš„ç»“æœã€‚

> é˜²æ­¢å‘ç”Ÿçº¿ç¨‹ä¸å®‰å…¨çš„çŠ¶å†µ : 1. ä¸åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«è¯¥çŠ¶æ€å˜é‡ 2. å°†çŠ¶æ€å˜é‡ä¿®æ”¹ä¸ºä¸å¯å˜çš„å˜é‡ 3. åœ¨è®¿é—®çŠ¶æ€å˜é‡æ—¶ä½¿ç”¨åŒæ­¥

å¦å¤–ï¼Œç¨‹åºçš„å°è£…æ€§è¶Šå¥½ï¼Œå°±è¶Šå®¹æ˜“å®ç°ç¨‹åºçš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œä¸”æ›´å®¹æ˜“ç»´æŠ¤ã€‚

# ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨æ€§

> **çº¿ç¨‹å®‰å…¨æ€§** : å½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªç±»ä½¿,è¿™ä¸ªç±»å§‹ç»ˆéƒ½èƒ½è¡¨ç°å‡ºæ­£ç¡®çš„è¡Œä¸º,é‚£ä¹ˆå°±ç§°è¿™ä¸ªç±»ä¸ºçº¿ç¨‹å®‰å…¨çš„

> æ— çŠ¶æ€çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„.

:blush: ä¸€ä¸ªæ— çŠ¶æ€çš„Servlet

```java
@ThreadSafe
public class StatelessFactorizer extends GenericServlet implements Servlet {

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = factor(i);
        encodeIntoResponse(resp, factors);
    }
}
```

åœ¨è¿™ä¸ªServletä¸­ï¼Œä¸åŒ…å«ä»»ä½•å˜é‡ï¼Œä¹Ÿä¸åŒ…å«å…¶ä»–ç±»çš„å˜é‡ã€‚è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€éƒ½å­˜äºå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶ä¸”åªèƒ½ç”±å½“å‰çº¿ç¨‹è®¿é—®ã€‚æ‰€ä»¥è®¿é—®Servletçš„çº¿ç¨‹ä¸ä¼šå½±å“åˆ°å¦ä¸€ä¸ªåŒæ—¶è®¿é—®Servletçš„è®¡ç®—ç»“æœã€‚å› ä¸ºä»–ä»¬æ²¡æœ‰å…±äº«çŠ¶æ€ã€‚

# åŸå­æ€§

:anguished: ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„Hit Counterç¨‹åº

```java
@NotThreadSafe
public class UnsafeCountingFactorizer extends GenericServlet implements Servlet {
    private long count = 0;

    public long getCount() {
        return count;
    }

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = factor(i);
        ++count;
        encodeIntoResponse(resp, factors);
    }
}
```

åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œ`++count`æ“ä½œå®é™…ä¸Šæ˜¯åˆ†ä¸‰æ­¥ï¼Œ"è¯»å–-ä¿®æ”¹-å†™å…¥"ï¼Œè€Œä¸”å…¶ç»“æœä¾èµ–äºä¹‹å‰çš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œå½“ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œæ—¶ï¼Œä»–ä»¬èµ·åˆè¯»åˆ°çš„éƒ½æ˜¯9ï¼Œä¸‰ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸåç»“æœå´æ›´æ–°ä¸º10ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚åƒè¿™ç§å› ä¸ºæ‰§è¡Œæ—¶åºå¯¼è‡´äº§ç”Ÿä¸æ­£ç¡®çš„ç»“æœï¼Œè¢«ç§°ä¸º`ç«æ€æ¡ä»¶`ã€‚

## ç«æ€æ¡ä»¶

æŒ‡è®¡ç®—ç»“æœå–å†³äºæ‰§è¡Œé¡ºåºï¼Œæ¢å¥è¯è¯´å°±æ˜¯ç»“æœçš„æ­£ç¡®æ€§é è¿æ°”ã€‚

- å¸¸è§çš„ç«äº‰ : "å…ˆæ£€æŸ¥åæ‰§è¡Œ(Check-Then-Act)"æ“ä½œã€‚å³é€šè¿‡ä¸€ä¸ªå¯èƒ½äº‹é¡¹çš„è§‚æµ‹ç»“æœæ¥å†³å®šä¸‹ä¸€æ­¥çš„åŠ¨ä½œ
- å•ä¾‹è®¾è®¡æ¨¡å¼çš„æ‡’æ±‰å¼å°±æ˜¯å…¸å‹çš„"å…ˆæ£€æŸ¥åæ‰§è¡Œ"

## å¤åˆæ“ä½œ

é‚£ä¹ˆå¦‚ä½•é¿å…ç«æ€æ¡ä»¶ï¼Ÿéœ€è¦ä¿è¯åœ¨ä¿®æ”¹è¯¥å˜é‡æ—¶ï¼Œé€šè¿‡æŸç§æ–¹å¼é˜²æ­¢å…¶ä»–çº¿ç¨‹ä½¿ç”¨è¿™ä¸ªå˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŠŠ"è¯»å–-ä¿®æ”¹-å†™å…¥"è¿™ç§`å¤åˆæ“ä½œ`ä»¥åŸå­æ€§æ–¹å¼æ‰§è¡Œã€‚

:blush:  ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„Hit Counterç¨‹åº

```java
@ThreadSafe
public class CountingFactorizer extends GenericServlet implements Servlet {
    private final AtomicLong count = new AtomicLong(0);

    public long getCount() { return count.get(); }

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = factor(i);
        count.incrementAndGet();
        encodeIntoResponse(resp, factors);
    }
}
```

é€šè¿‡ç”¨AtomicLongæ¥ä»£æ›¿longã€‚

> å°½å¯èƒ½ä½¿ç”¨ç°æœ‰çš„çº¿ç¨‹å®‰å…¨å¯¹è±¡(å¦‚AtomicLong)æ¥ç®¡ç†ç±»çš„çŠ¶æ€

# åŠ é”æœºåˆ¶

é‚£ä¹ˆæ˜¯ä¸æ˜¯åªè¦æŠŠçŠ¶æ€å…¨éƒ¨å­˜ä¸º`AtomicLong`é‚£ç§çº¿ç¨‹å®‰å…¨çš„å˜é‡å°±è¡Œäº†? å‡è®¾æˆ‘ä»¬æƒ³æå‡æ€§èƒ½ï¼Œåœ¨ä¹‹å‰çš„Counterä¸­åŠ å…¥å› æ•°åˆ†è§£çš„ç¼“å­˜æœºåˆ¶æ¥ä¿å­˜ä¸Šä¸€æ¬¡çš„è®¡ç®—ç»“æœã€‚å¹¶åŒæ ·å°è¯•ç”¨Atomicæ¥ç®¡ç†è¿™ä¸ªç¼“å­˜ã€‚

ğŸ˜§ ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„cacheç¨‹åº

```java
@NotThreadSafe
public class UnsafeCachingFactorizer extends GenericServlet implements Servlet {
    private final AtomicReference<BigInteger> lastNumber
            = new AtomicReference<BigInteger>();
    private final AtomicReference<BigInteger[]> lastFactors
            = new AtomicReference<BigInteger[]>();

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        if (i.equals(lastNumber.get()))					
            encodeIntoResponse(resp, lastFactors.get());	
        else {
            BigInteger[] factors = factor(i);
            lastNumber.set(i);
            lastFactors.set(factors);			//<---å­˜åœ¨é—®é¢˜
            encodeIntoResponse(resp, factors);	//<---
        }
    }
}

```

è™½ç„¶å˜é‡éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„Atomicç±»ï¼Œä½†ä»å­˜åœ¨ç«äº‰æ¡ä»¶ã€‚å› ä¸ºæ­¤æ—¶ä¸¤ä¸ªå˜é‡ä¹‹é—´ä¸æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ï¼Œå½“æ›´æ–°æŸä¸ªå˜é‡æ—¶ï¼Œéœ€è¦å¯¹å¦ä¸€ä¸ªä¹ŸåŒæ—¶è¿›è¡Œæ›´æ–°ã€‚å¦‚æœåœ¨ä¸¤ä¸ªå˜é‡çš„æ›´æ–°è¿‡ç¨‹ä¸­æœ‰åˆ«çš„çº¿ç¨‹ç ´åäº†ä¸å˜æ€§æ¡ä»¶ï¼Œå°±æ— æ³•è·å–æœŸå¾…çš„å€¼ã€‚

> è¦ä¿æŒçŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œå°±éœ€è¦åœ¨å•ä¸ªåŸå­æ“ä½œä¸­æ›´æ–°æ‰€æœ‰ç›¸å…³çš„å˜é‡

## å†…ç½®é”

- `ä»£ç åŒæ­¥å—`(synchronized):Javaæä¾›çš„ä¸€ç§å†…ç½®é”æœºåˆ¶ï¼Œæ•´ä½“å…·æœ‰åŸå­æ€§

```java
synchronized (lock) {	//<--ä½œä¸ºé”çš„å¯¹è±¡å¼•ç”¨
    //ç”±ä¸Šé¢çš„é”ä¿æŠ¤çš„ä»£ç å—
}
```

- ç”¨`synchronized`ä¿®é¥°çš„æ–¹æ³•: é”å°±æ˜¯æ–¹æ³•è°ƒç”¨æ‰€åœ¨çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯é™æ€çš„`synchronized`æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒçš„é”å°±æ˜¯Classæœ¬èº«ã€‚

`å†…ç½®é”` : æ¯ä¸ªjavaå¯¹è±¡éƒ½èƒ½ä½œä¸ºå†…ç½®é”ã€‚çº¿ç¨‹åœ¨è¿›å…¥åŒæ­¥ä»£ç å—ä¹‹å‰ä¼šè‡ªåŠ¨è·å¾—é”ï¼Œåœ¨é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾é”ã€‚

å†…ç½®é”ç›¸å½“äºä¸€ç§äº’æ–¥é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰è¿™ç§é”ã€‚å½“çº¿ç¨‹å°è¯•è·å–ä¸€ä¸ªç”±çº¿ç¨‹BæŒæœ‰çš„é”æ—¶ï¼ŒAå¿…é¡»ç­‰å¾…æˆ–é˜»å¡ï¼Œç›´åˆ°Bé‡Šæ”¾é”ã€‚å› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥è¢«å†…ç½®é”ä¿æŠ¤çš„ä»£ç å—ï¼Œæ‰€ä»¥åœ¨è¿™è¿‡ç¨‹ä¸­æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

:confused:  ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„cacheç¨‹åº,æŠŠserviceæ–¹æ³•ä¿®é¥°ä¸ºsynchronized(æ€§èƒ½ç³Ÿç³•)

```java
@ThreadSafe
public class SynchronizedFactorizer extends GenericServlet implements Servlet {
    @GuardedBy("this") private BigInteger lastNumber;
    @GuardedBy("this") private BigInteger[] lastFactors;

    public synchronized void service(ServletRequest req,
                                     ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        if (i.equals(lastNumber))
            encodeIntoResponse(resp, lastFactors);
        else {
            BigInteger[] factors = factor(i);
            lastNumber = i;
            lastFactors = factors;
            encodeIntoResponse(resp, factors);
        }
    }
}
```



## é‡å…¥

å†…ç½®é”æ˜¯`å¯é‡å…¥`çš„ã€‚ä»€ä¹ˆæ˜¯é‡å…¥ï¼Ÿå¦‚æœçº¿ç¨‹Aï¼ŒBéœ€è¦åŒä¸€æŠŠé”ï¼Œå½“BæŒæœ‰æ—¶çº¿ç¨‹Aå°±ä¼šè¢«é˜»å¡ç›´åˆ°è¿™æŠŠé”è¢«é‡Šæ”¾ã€‚ä½†å¦‚æœå½“Bç»“æŸäº†è¿™æ¬¡è°ƒç”¨ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶çš„æ–¹æ³•ä»ä¾èµ–è¿™æŠŠé”ï¼Œå®ƒä¼šè¯•å›¾è·å¾—è¿™ä¸ªè‡ªå·±å·²ç»æŒæœ‰çš„é”ï¼Œæ­¤æ—¶Bæ˜¯å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™æŠŠé”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´,å¦‚æœå¤šæ¬¡æ“ä½œéœ€è¦çš„éƒ½æ˜¯åŒä¸€æŠŠé”æ—¶ï¼Œçº¿ç¨‹å¯ä»¥ä¸€ç›´ç”¨è¿™æŠŠé”ã€‚**"é‡å…¥"æ„å‘³ç€è·å–é”çš„æ“ä½œçš„é¢—ç²’åº¦æ˜¯"çº¿ç¨‹"è€Œä¸æ˜¯"è°ƒç”¨"**ã€‚

ç›¸åï¼Œå¦‚æœå†…ç½®é”æ˜¯ä¸å¯é‡å…¥çš„ï¼Œé‚£ä¹ˆè¿™æ®µä»£ç ä¼šå‘ç”Ÿæ­»é”ã€‚

```java
public class Widget {
    public synchronized void doSomething() {...}
}
public class LoggingWidget extends Widget {
    public synchronized void doSomething() {
        System.out.println(toString() + ": calling doSomething");
        super.doSomething();
	}
}

```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨å¯é‡å…¥é”çš„æ¦‚å¿µï¼Œå­ç±»çš„doSomethingè¢«è°ƒç”¨åä¸ºäº†æ‰§è¡Œ`super.doSomething()`ï¼Œå°±å¿…é¡»è¿›å…¥çˆ¶ç±»çš„doSomethingæ–¹æ³•ï¼Œç„¶è€Œçˆ¶ç±»çš„doSomethingæ–¹æ³•ä¹Ÿæ˜¯è¢«`synchronized`ä¿®é¥°çš„ï¼Œæ­¤æ—¶å´æ— æ³•è·å–Widgetä¸Šçš„é”ï¼Œå› ä¸ºè¿™ä¸ªé”å·²è¢«ï¼ˆè‡ªå·±?ï¼‰æŒæœ‰ï¼Œæ‰€ä»¥ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œé€ æˆæ­»é”ã€‚

# ç”¨é”æ¥ä¿æŠ¤çŠ¶æ€

`ä¸²è¡Œè®¿é—®`ï¼šæ„å‘³ç€å¤šä¸ªçº¿ç¨‹ä¾æ¬¡ä»¥ç‹¬å çš„æ–¹å¼è®¿é—®å¯¹è±¡ï¼Œè€Œä¸æ˜¯å¹¶å‘çš„è®¿é—®

å¦‚æœç”¨åŒæ­¥æ¥è®¿é—®æŸä¸ªå˜é‡æ—¶ï¼Œè®¿é—®è¯¥å˜é‡çš„æ‰€æœ‰ä½ç½®éƒ½éœ€è¦åŒæ­¥ï¼Œè€Œä¸”éƒ½éœ€è¦**åŒä¸€ä¸ª**é”ã€‚

ä¸€ç§å¸¸è§çš„åŠ é”çº¦å®šå°±æ˜¯ï¼Œå°†æ‰€æœ‰çš„å¯å˜çŠ¶æ€éƒ½å°è£…åœ¨å¯¹è±¡å†…éƒ¨ï¼Œå¹¶é€šè¿‡å¯¹è±¡çš„å†…ç½®é”å¯¹æ‰€æœ‰è®¿é—®å¯å˜çŠ¶æ€çš„ä»£ç è·¯å¾„è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—åœ¨è¯¥å¯¹è±¡ä¸Šä¸ä¼šå‘ç”Ÿå¹¶å‘è®¿é—®ã€‚Vectorå’Œå…¶ä»–åŒæ­¥é›†åˆç±»éƒ½ä½¿ç”¨äº†è¿™ç§æ–¹å¼ã€‚

> å¯¹äºæ¯ä¸ªåŒ…å«å¤šä¸ªå˜é‡çš„ä¸å˜æ€§æ¡ä»¶ï¼Œå…¶ä¸­æ¶‰åŠçš„æ‰€æœ‰å˜é‡éƒ½éœ€è¦ç”±åŒä¸€ä¸ªé”ä¿æŠ¤

# æ´»è·ƒæ€§ä¸æ€§èƒ½

å†æ¬¡åˆ†æä¹‹å‰çš„çº¿ç¨‹å®‰å…¨ï¼Œä½†æ€§èƒ½ç³Ÿç³•çš„Servletã€‚é€šè¿‡ç¼©å°åŒæ­¥ä»£ç å—çš„ä½œç”¨èŒƒå›´å¯ä»¥æ”¹å–„æ€§èƒ½ã€‚

:blush: æ”¹å–„åçš„çº¿ç¨‹å®‰å…¨cacheç¨‹åº

```java
@ThreadSafe
public class CachedFactorizer extends GenericServlet implements Servlet {
    @GuardedBy("this") private BigInteger lastNumber;
    @GuardedBy("this") private BigInteger[] lastFactors;
    @GuardedBy("this") private long hits;
    @GuardedBy("this") private long cacheHits;

    public synchronized long getHits() {
        return hits;
    }

    public synchronized double getCacheHitRatio() {
        return (double) cacheHits / (double) hits;
    }

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = null;
        synchronized (this) {
            ++hits;
            if (i.equals(lastNumber)) {
                ++cacheHits;
                factors = lastFactors.clone();
            }
        }
        if (factors == null) {
            factors = factor(i);
            synchronized (this) {
                lastNumber = i;
                lastFactors = factors.clone();
            }
        }
        encodeIntoResponse(resp, factors);
    }
}
```

