---
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
typora-copy-images-to: 20181101-2
title: å¹¶å‘æ“ä½œåˆé›†-4.Lcokå’ŒCondition
date: 2018-11-01 21:59:38
---

> ğŸ¤ [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— ç›®å½•]()
>
> ğŸ• [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

å¹¶å‘APIæ”¯æŒå¤šç§æ˜¾å¼çš„é”ï¼Œå®ƒä»¬ç”±`Lock`æ¥å£è§„å®šï¼Œç”¨äºä»£æ›¿`synchronized`çš„éšå¼é”ã€‚é”å¯¹ç»†ç²’åº¦çš„æ§åˆ¶æ”¯æŒå¤šç§æ–¹æ³•ï¼Œå› æ­¤å®ƒä»¬æ¯”éšå¼çš„ç›‘è§†å™¨å…·æœ‰æ›´å¤§çš„å¼€é”€ã€‚

# Lockæ¥å£å’Œsynchronizedå…³é”®å­—çš„å·®åˆ«

ä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹ï¼š

| ç±»åˆ«     | synchronized                                                 | Lock                                                         |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| å­˜åœ¨å±‚æ¬¡ | Javaçš„å…³é”®å­—ï¼Œåœ¨jvmå±‚é¢ä¸Š                                    | æ˜¯ä¸€ä¸ªç±»                                                     |
| é”çš„é‡Šæ”¾ | 1ã€ä»¥è·å–é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ï¼Œé‡Šæ”¾é”<br />2ã€çº¿ç¨‹æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ï¼Œjvmä¼šè®©çº¿ç¨‹é‡Šæ”¾é” | åœ¨finallyä¸­å¿…é¡»é‡Šæ”¾é”ï¼Œä¸ç„¶å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”                  |
| é”çš„è·å– | å‡è®¾Açº¿ç¨‹è·å¾—é”ï¼ŒBçº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœAçº¿ç¨‹é˜»å¡ï¼ŒBçº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…   | åˆ†æƒ…å†µè€Œå®šï¼ŒLockæœ‰å¤šä¸ªé”è·é”çš„æ–¹å¼ï¼Œå¤§è‡´å°±æ˜¯å¯ä»¥å°è¯•è·å¾—é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ç”¨ä¸€ç›´ç­‰å¾… |
| é”çŠ¶æ€   | æ— æ³•åˆ¤æ–­                                                     | å¯ä»¥åˆ¤æ–­                                                     |
| é”ç±»å‹   | å¯é‡å…¥ ä¸å¯ä¸­æ–­ éå…¬å¹³                                       | å¯é‡å…¥ å¯ä¸­æ–­ å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰                             |
| æ€§èƒ½     | å°‘é‡åŒæ­¥                                                     | å¤§é‡åŒæ­¥                                                     |

è¡¨ä¸­æåˆ°äº†æ‰€ç±»å‹ï¼Œå…ˆäº†è§£ä¸€ä¸‹é”ç±»å‹éƒ½æœ‰å“ªäº›ï¼š

- å¯é‡å…¥é”ï¼šåœ¨æ‰§è¡Œå¯¹è±¡ä¸­æ‰€æœ‰åŒæ­¥æ–¹æ³•ä¸ç”¨å†æ¬¡è·å¾—é”
- å¯ä¸­æ–­é”ï¼šåœ¨ç­‰å¾…è·å–é”è¿‡ç¨‹ä¸­å¯ä¸­æ–­
- å…¬å¹³é”ï¼š æŒ‰ç­‰å¾…è·å–é”çš„çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´è¿›è¡Œè·å–ï¼Œç­‰å¾…æ—¶é—´é•¿çš„å…·æœ‰ä¼˜å…ˆè·å–é”æƒåˆ©
- è¯»å†™é”ï¼šå¯¹èµ„æºè¯»å–å’Œå†™å…¥çš„æ—¶å€™æ‹†åˆ†ä¸º2éƒ¨åˆ†å¤„ç†ï¼Œè¯»çš„æ—¶å€™å¯ä»¥å¤šçº¿ç¨‹ä¸€èµ·è¯»ï¼Œå†™çš„æ—¶å€™å¿…é¡»åŒæ­¥åœ°å†™

# Lockæ¥å£å®šä¹‰çš„æ–¹æ³•å’Œä½¿ç”¨

- lock()ï¼šè·å–é”ï¼Œå¦‚æœé”è¢«æš‚ç”¨åˆ™ä¸€ç›´ç­‰å¾…

- unlock():é‡Šæ”¾é”

- tryLock(): æ³¨æ„è¿”å›ç±»å‹æ˜¯booleanï¼Œå¦‚æœè·å–é”çš„æ—¶å€™é”è¢«å ç”¨å°±è¿”å›falseï¼Œå¦åˆ™è¿”å›true

- tryLock(long time, TimeUnit unit)ï¼šæ¯”èµ·tryLock()å°±æ˜¯ç»™äº†ä¸€ä¸ªæ—¶é—´æœŸé™ï¼Œä¿è¯ç­‰å¾…å‚æ•°æ—¶é—´

- lockInterruptibly()ï¼šé”çš„è·å¾—æ–¹å¼ï¼Œå¦‚æœçº¿ç¨‹åœ¨è·å–é”çš„é˜¶æ®µè¿›å…¥äº†ç­‰å¾…ï¼Œé‚£ä¹ˆå¯ä»¥ä¸­æ–­æ­¤çº¿ç¨‹ï¼Œå…ˆå»åšåˆ«çš„äº‹

é€šè¿‡ ä»¥ä¸Šçš„è§£é‡Šï¼Œå¤§è‡´å¯ä»¥è§£é‡Šåœ¨ä¸Šä¸ªéƒ¨åˆ†ä¸­â€œé”ç±»å‹(lockInterruptibly())â€ï¼Œâ€œé”çŠ¶æ€(tryLock())â€ç­‰é—®é¢˜ï¼Œè¿˜æœ‰å°±æ˜¯å‰é¢å­æ‰€è·å–çš„è¿‡ç¨‹æˆ‘æ‰€å†™çš„â€œå¤§è‡´å°±æ˜¯å¯ä»¥å°è¯•è·å¾—é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ä¼šä¸€ç›´ç­‰å¾…â€ç”¨äº†â€œå¯ä»¥â€çš„åŸå› ã€‚

ç®€å•çœ‹ä¸€ä¸‹æ¯”è¾ƒå¸¸ç”¨çš„lock()å’ŒtryLock()æ–¹æ³•çš„ä½¿ç”¨æ–¹å¼,å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹æ¥è°ƒç”¨è¿™äº›æ–¹æ³•ï¼š

lock()

```java
    private void testLock(Thread thread) {
        lock.lock();
        try {
            System.out.println("çº¿ç¨‹å" + thread.getName() + "è·å¾—äº†é”");
            Thread.sleep(1000);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println("çº¿ç¨‹å" + thread.getName() + "é‡Šæ”¾äº†é”");
            lock.unlock();
        }
    }
---------------------------
è¾“å‡º
çº¿ç¨‹åThread-1è·å¾—äº†é”
çº¿ç¨‹åThread-1é‡Šæ”¾äº†é”
çº¿ç¨‹åThread-0è·å¾—äº†é”
çº¿ç¨‹åThread-0é‡Šæ”¾äº†é”
```

tryLock()

```java
 private void testTryLock(Thread thread) {
        if (lock.tryLock()) {
            try {
                System.out.println("çº¿ç¨‹å" + thread.getName() + "è·å¾—äº†é”");
                Thread.sleep(1000);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                System.out.println("çº¿ç¨‹å" + thread.getName() + "é‡Šæ”¾äº†é”");
                lock.unlock();
            }
        } else {
            System.out.println("æˆ‘æ˜¯" + Thread.currentThread().getName() + "æœ‰äººå ç€é”ï¼Œæˆ‘å°±ä¸è¦å•¦");
        }
    }
---------------------------
è¾“å‡º
çº¿ç¨‹åThread-0è·å¾—äº†é”
æˆ‘æ˜¯Thread-1æœ‰äººå ç€é”ï¼Œæˆ‘å°±ä¸è¦å•¦
çº¿ç¨‹åThread-0é‡Šæ”¾äº†é”
```

# Lockæ¥å£çš„å®ç°

é”çš„å¤šä¸ªå®ç°åœ¨æ ‡å‡†JDKä¸­æä¾›ï¼Œå®ƒä»¬ä¼šåœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­å±•ç¤º

## ReentrantLock

`ReentrantLock`ç±»æ˜¯äº’æ–¥é”ï¼Œä¸é€šè¿‡`synchronized`è®¿é—®çš„éšå¼ç›‘è§†å™¨å…·æœ‰ç›¸åŒè¡Œä¸ºï¼Œä½†æ˜¯å…·æœ‰æ‰©å±•åŠŸèƒ½ã€‚å°±åƒå®ƒçš„åç§°ä¸€æ ·ï¼Œè¿™ä¸ªé”å®ç°äº†é‡å…¥ç‰¹æ€§ï¼Œå°±åƒéšå¼ç›‘è§†å™¨ä¸€æ ·ã€‚

ä½¿ç”¨`ReentrantLock`å†™ä¸€ä¸ªä¾‹å­ã€‚

```java
public class ReentrantLockDemo {
    private static ReentrantLock lock = new ReentrantLock();

    private static int count = 0;

    private static void increment() {
        lock.lock();
        try {
            count++;
            System.out.println(Thread.currentThread().getName());
        } finally {
            lock.unlock();
        }
    }

    public static void main(String[] args) throws InterruptedException {

        //æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œ3æ¬¡ increment()
        Runnable runnable = () -> IntStream.range(0, 3)
//                                            .range(0, 10000)	//count = 20000
                                            .forEach(i -> increment());

        Thread t1 = new Thread(runnable);
        Thread t2 = new Thread(runnable);
        t1.start();
        t2.start();

        TimeUnit.SECONDS.sleep(1);
        System.out.println(count);
    }
}
------------------------------------
è¾“å‡º
Thread-0
Thread-0
Thread-0
Thread-1
Thread-1
Thread-1
6
```

ä¸Šé¢çš„ä»£ç ä¸­æˆ‘åˆ†è®©æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œ3æ¬¡ increment()ã€‚è€ŒåŒä¸€ä¸ªçº¿ç¨‹è¿ç»­æ‰§è¡Œäº†ä¸‰æ¬¡æ‰æ¢ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œå¾ˆæ˜¾ç„¶æ˜¯å¯é‡å…¥é”ã€‚æˆ‘ä»¬è®©incrementå¤šæ‰§è¡Œå‡ æ¬¡ï¼ŒæŠŠ`IntStream.range(0, 3)`æ”¹ä¸º`IntStream.range(0, 10000)`ï¼Œç»“æœå¾—åˆ°20000ï¼Œä¹Ÿè¯´æ˜ä¸å­˜åœ¨ç«äº‰ã€‚

å¦å¤–ï¼Œé”å¯¹ç»†ç²’åº¦çš„æ§åˆ¶æ”¯æŒå¤šç§æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
public class ReentrantLock2Demo {
    private static ReentrantLock lock = new ReentrantLock();

    public static void main(String[] args) throws InterruptedException {


        Thread t1 = new Thread(() -> {
            lock.lock();
            try {
                TimeUnit.SECONDS.sleep(1);  //ä¿æŒ1ç§’ä¸æ”¾é”
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        });

        Thread t2 = new Thread(() -> {
            System.out.println("é”æ˜¯å¦è¢«å ç”¨ï¼š " + lock.isLocked());
            System.out.println("å ç”¨æ‰€çš„æ˜¯å¦æ˜¯æˆ‘ï¼š " + lock.isHeldByCurrentThread());
            boolean locked = lock.tryLock();
            System.out.println("æ˜¯å¦è·å–é” ï¼š " + locked);
        });

        t1.start();
        t2.start();

    }
}
------------------------------------
è¾“å‡º
é”æ˜¯å¦è¢«å ç”¨ï¼š true
å ç”¨æ‰€çš„æ˜¯å¦æ˜¯æˆ‘ï¼š false
æ˜¯å¦è·å–é” ï¼š false
```

## ReadWriteLock

`ReadWriteLock`æ¥å£è§„å®šäº†é”çš„å¦ä¸€ç§ç±»å‹ï¼ŒåŒ…å«ç”¨äºè¯»å†™è®¿é—®çš„ä¸€å¯¹é”ã€‚è¯»å†™é”çš„ç†å¿µæ˜¯ï¼Œåªè¦æ²¡æœ‰ä»»ä½•çº¿ç¨‹å†™å…¥å˜é‡ï¼Œå¹¶å‘è¯»å–å¯å˜å˜é‡é€šå¸¸æ˜¯å®‰å…¨çš„ã€‚æ‰€ä»¥è¯»é”å¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåªè¦æ²¡æœ‰çº¿ç¨‹æŒæœ‰å†™é”ã€‚è¿™æ ·å¯ä»¥æå‡æ€§èƒ½å’Œååé‡ï¼Œå› ä¸ºè¯»å–æ¯”å†™å…¥æ›´åŠ é¢‘ç¹ã€‚

```java
public class ReadWriteLockDemo {
    public static void main(String[] args) {
        Map<String, String> map = new HashMap<>();
        ReadWriteLock lock = new ReentrantReadWriteLock();

		//å†™çš„Runnable
        Runnable write = () -> {
            lock.writeLock().lock();
            try {
                TimeUnit.SECONDS.sleep(1);
                map.put("foo", "bar");
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.writeLock().unlock();
            }
        };
		
        //è¯»çš„Runnable
        Runnable read = () -> {
            lock.readLock().lock();
            try {
                System.out.println(map.get("foo"));
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.readLock().unlock();
            }
        };

        //å¼€å¯ä¸€ä¸ªå†™çº¿ç¨‹å’Œä¸¤ä¸ªè¯»çº¿ç¨‹
        new Thread(write).start();
        new Thread(read).start();
        new Thread(read).start();
    }
}
```

å½“ä½ æ‰§è¡Œè¿™ä¸€ä»£ç ç¤ºä¾‹æ—¶ï¼Œä½ ä¼šæ³¨æ„åˆ°ä¸¤ä¸ªè¯»ä»»åŠ¡éœ€è¦ç­‰å¾…å†™ä»»åŠ¡å®Œæˆã€‚åœ¨é‡Šæ”¾äº†å†™é”ä¹‹åï¼Œä¸¤ä¸ªè¯»ä»»åŠ¡ä¼šåŒæ—¶æ‰§è¡Œï¼Œå¹¶åŒæ—¶æ‰“å°ç»“æœã€‚å®ƒä»¬ä¸éœ€è¦ç›¸äº’ç­‰å¾…å®Œæˆï¼Œå› ä¸ºè¯»é”å¯ä»¥å®‰å…¨åŒæ­¥è·å–ï¼Œåªè¦æ²¡æœ‰å…¶å®ƒçº¿ç¨‹è·å–äº†å†™é”ã€‚

# StampedLock

Java 8 è‡ªå¸¦äº†ä¸€ç§æ–°çš„é”ï¼Œå«åš`StampedLock`ï¼Œå®ƒåŒæ ·æ”¯æŒè¯»å†™é”ï¼Œå°±åƒä¸Šé¢çš„ä¾‹å­é‚£æ ·ã€‚ä¸`ReadWriteLock`ä¸åŒçš„æ˜¯ï¼Œ`StampedLock`çš„é”æ–¹æ³•ä¼šè¿”å›è¡¨ç¤ºä¸º`long`çš„æ ‡è®°ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™äº›æ ‡è®°æ¥é‡Šæ”¾é”ï¼Œæˆ–è€…æ£€æŸ¥é”æ˜¯å¦æœ‰æ•ˆã€‚æ­¤å¤–ï¼Œ`StampedLock`æ”¯æŒå¦ä¸€ç§å«åšä¹è§‚é”ï¼ˆoptimistic lockingï¼‰çš„æ¨¡å¼ã€‚

è®©æˆ‘ä»¬ä½¿ç”¨`StampedLock`ä»£æ›¿`ReadWriteLock`é‡å†™ä¸Šé¢çš„ä¾‹å­ï¼š

```java
        Runnable write = () -> {
            long stamp = lock.writeLock();
            try {
                TimeUnit.SECONDS.sleep(1);
                map.put("foo", "bar");
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlockWrite(stamp);
            }
        };

        Runnable read = () -> {
            long stamp = lock.readLock();
            try {
                System.out.println(map.get("foo"));
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlockRead(stamp);
            }
        };
```

è¾“å‡ºç»“æœå’Œä¸Šä¾‹ç›¸åŒã€‚é€šè¿‡`readLock()` æˆ– `writeLock()`æ¥è·å–è¯»é”æˆ–å†™é”ä¼šè¿”å›ä¸€ä¸ªæ ‡è®°ï¼Œå®ƒå¯ä»¥åœ¨ç¨åç”¨äºåœ¨`finally`å—ä¸­è§£é”ã€‚è¦è®°ä½`StampedLock`å¹¶**æ²¡æœ‰å®ç°é‡å…¥ç‰¹æ€§**ã€‚æ¯æ¬¡è°ƒç”¨åŠ é”éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„æ ‡è®°ï¼Œå¹¶ä¸”åœ¨æ²¡æœ‰å¯ç”¨çš„é”æ—¶é˜»å¡ï¼Œå³ä½¿ç›¸åŒçº¿ç¨‹å·²ç»æ‹¿é”äº†ã€‚æ‰€ä»¥ä½ éœ€è¦é¢å¤–æ³¨æ„ä¸è¦å‡ºç°æ­»é”ã€‚

å°±åƒå‰é¢çš„`ReadWriteLock`ä¾‹å­é‚£æ ·ï¼Œä¸¤ä¸ªè¯»ä»»åŠ¡éƒ½éœ€è¦ç­‰å¾…å†™é”é‡Šæ”¾ã€‚ä¹‹åä¸¤ä¸ªè¯»ä»»åŠ¡åŒæ—¶å‘æ§åˆ¶å°æ‰“å°ä¿¡æ¯ï¼Œå› ä¸ºå¤šä¸ªè¯»æ“ä½œä¸ä¼šç›¸äº’é˜»å¡ï¼Œåªè¦æ²¡æœ‰çº¿ç¨‹æ‹¿åˆ°å†™é”ã€‚

ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†ä¹è§‚é”ï¼š

```java
public class StampedLockDemo2 {
    public static void main(String[] args) throws InterruptedException {
        StampedLock lock = new StampedLock();

        Runnable optimisticRead = () ->{
            long stamp = lock.tryOptimisticRead();
            try {
                System.out.println("ä¹è§‚é”æ˜¯å¦æœ‰æ•ˆ  : "+ lock.validate(stamp));
                TimeUnit.SECONDS.sleep(1);
                System.out.println("ä¹è§‚é”æ˜¯å¦æœ‰æ•ˆ  : "+ lock.validate(stamp));
                TimeUnit.SECONDS.sleep(2);
                System.out.println("ä¹è§‚é”æ˜¯å¦æœ‰æ•ˆ  : "+ lock.validate(stamp));
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.tryUnlockRead();
            }
        };

        Runnable write = () -> {
            long stamp = lock.writeLock();
            try {
                System.out.println("è·å–å†™é”");
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock(stamp);
                System.out.println("å†™å®Œäº†");
            }
        };
        
        new Thread(optimisticRead).start();
        new Thread(write).start();
    }
}
```

ä¹è§‚çš„è¯»é”é€šè¿‡è°ƒç”¨`tryOptimisticRead()`è·å–ï¼Œå®ƒæ€»æ˜¯è¿”å›ä¸€ä¸ªæ ‡è®°è€Œä¸é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— è®ºé”æ˜¯å¦çœŸæ­£å¯ç”¨ã€‚å¦‚æœå·²ç»æœ‰å†™é”è¢«æ‹¿åˆ°ï¼Œè¿”å›çš„æ ‡è®°ç­‰äº0ã€‚ä½ éœ€è¦æ€»æ˜¯é€šè¿‡`lock.validate(stamp)`æ£€æŸ¥æ ‡è®°æ˜¯å¦æœ‰æ•ˆã€‚

æ‰§è¡Œä¸Šé¢çš„ä»£ç ä¼šäº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š

```
ä¹è§‚é”æ˜¯å¦æœ‰æ•ˆ  : true
è·å–å†™é”
ä¹è§‚é”æ˜¯å¦æœ‰æ•ˆ  : false
å†™å®Œäº†
ä¹è§‚é”æ˜¯å¦æœ‰æ•ˆ  : false
```

ä¹è§‚é”åœ¨åˆšåˆšæ‹¿åˆ°é”ä¹‹åæ˜¯æœ‰æ•ˆçš„ã€‚å’Œæ™®é€šçš„è¯»é”ä¸åŒçš„æ˜¯ï¼Œä¹è§‚é”ä¸é˜»æ­¢å…¶ä»–çº¿ç¨‹åŒæ—¶è·å–å†™é”ã€‚åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹æš‚åœä¸€ç§’ä¹‹åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹æ‹¿åˆ°å†™é”è€Œæ— éœ€ç­‰å¾…ä¹è§‚çš„è¯»é”è¢«é‡Šæ”¾ã€‚æ­¤æ—¶ï¼Œä¹è§‚çš„è¯»é”å°±ä¸å†æœ‰æ•ˆäº†ã€‚ç”šè‡³å½“å†™é”é‡Šæ”¾æ—¶ï¼Œä¹è§‚çš„è¯»é”è¿˜å¤„äºæ— æ•ˆçŠ¶æ€ã€‚

æ‰€ä»¥åœ¨ä½¿ç”¨ä¹è§‚é”æ—¶ï¼Œä½ éœ€è¦æ¯æ¬¡åœ¨è®¿é—®ä»»ä½•å…±äº«å¯å˜å˜é‡ä¹‹åéƒ½è¦æ£€æŸ¥é”ï¼Œæ¥ç¡®ä¿è¯»é”ä»ç„¶æœ‰æ•ˆã€‚

æœ‰æ—¶ï¼Œå°†è¯»é”è½¬æ¢ä¸ºå†™é”è€Œä¸ç”¨å†æ¬¡è§£é”å’ŒåŠ é”ååˆ†å®ç”¨ã€‚`StampedLock`ä¸ºè¿™ç§ç›®çš„æä¾›äº†`tryConvertToWriteLock()`æ–¹æ³•ï¼Œå°±åƒä¸‹é¢é‚£æ ·ï¼š

```java
public class StampedLockDemo3 {

    private static int count = 0;

    public static void main(String[] args) {
        StampedLock lock = new StampedLock();

        Runnable runnable = () -> {
            long stamp = lock.readLock();   //å…ˆè®¾ä¸ºè¯»é”
            try {
                if (count == 0) {
                    stamp = lock.tryConvertToWriteLock(stamp);  //è¯•å›¾è½¬ä¸ºå†™é”
                    if (stamp == 0L) {
                        System.out.println("è½¬æ¢å†™é”å¤±è´¥");
                        stamp = lock.writeLock();   //é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„å†™é”
                    }
                    count = 23;
                }
                System.out.println(count);

            } finally {
                lock.unlock(stamp);
            }
        };

        new Thread(runnable).start();
    }
}
//è¾“å‡º 23
```

ç¬¬ä¸€ä¸ªä»»åŠ¡è·å–è¯»é”ï¼Œå¹¶å‘æ§åˆ¶å°æ‰“å°`count`å­—æ®µçš„å½“å‰å€¼ã€‚ä½†æ˜¯å¦‚æœå½“å‰å€¼æ˜¯é›¶ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶èµ‹å€¼ä¸º`23`ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦å°†è¯»é”è½¬æ¢ä¸ºå†™é”ï¼Œæ¥é¿å…æ‰“ç ´å…¶å®ƒçº¿ç¨‹æ½œåœ¨çš„å¹¶å‘è®¿é—®ã€‚`tryConvertToWriteLock()`çš„è°ƒç”¨ä¸ä¼šé˜»å¡ï¼Œä½†æ˜¯å¯èƒ½ä¼šè¿”å›ä¸ºé›¶çš„æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰å¯ç”¨çš„å†™é”ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è°ƒç”¨`writeLock()`æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„å†™é”ã€‚

# Condition


ä»»ä½•ä¸€ä¸ªjavaå¯¹è±¡éƒ½å¤©ç„¶ç»§æ‰¿äºObjectç±»ï¼Œåœ¨çº¿ç¨‹é—´å®ç°é€šä¿¡çš„å¾€å¾€ä¼šåº”ç”¨åˆ°Objectçš„å‡ ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚wait()ä¸notify(),notifyAll()å‡ ä¸ªæ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ŒåŒæ ·çš„ï¼Œ åœ¨java Lockä½“ç³»ä¸‹ä¾ç„¶ä¼šæœ‰åŒæ ·çš„æ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚ä»æ•´ä½“ä¸Šæ¥çœ‹**Objectçš„waitå’Œnotify/notifyæ˜¯ä¸å¯¹è±¡ç›‘è§†å™¨é…åˆå®Œæˆçº¿ç¨‹é—´çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œè€ŒConditionä¸Locké…åˆå®Œæˆç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå‰è€…æ˜¯javaåº•å±‚çº§åˆ«çš„ï¼Œåè€…æ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œå…·æœ‰æ›´é«˜çš„å¯æ§åˆ¶æ€§å’Œæ‰©å±•æ€§**ã€‚

å‚ç…§Objectçš„waitå’Œnotify/notifyAllæ–¹æ³•ï¼ŒConditionä¹Ÿæä¾›äº†åŒæ ·çš„æ–¹æ³•ï¼š

- ä¸Object.waitæ–¹æ³•å¯¹åº”çš„Condition.awaitæ–¹æ³•
- ä¸Object.notify/notifyAllæ–¹æ³•å¯¹åº”çš„Condition.signal/signalAllæ–¹æ³•

## ä¸Lockä¸€èµ·ä½¿ç”¨

é€šè¿‡ä¸€ä¸ªçš„ç¤ºä¾‹ï¼Œæ¥ç†è§£å¦‚ä½•å’Œé…åˆLockä½¿ç”¨Conditionã€‚

æˆ‘åœ¨ 2.çº¿ç¨‹çŠ¶æ€è½¬æ¢æ–¹æ³• ä¸­å†™è¿‡é€šè¿‡wait/notifyå®ç°çš„å‘é€è€… - æ¥æ”¶è€…åŒæ­¥é—®é¢˜ç¤ºä¾‹ï¼Œå¦‚æœä½ æ²¡çœ‹è¿‡æ‰¾ä¸€ä¸‹æˆ‘ä¹‹å‰çš„æ–‡ç« ã€‚æˆ‘æŠŠä¸Šæ¬¡çš„wait/notifyæ”¹æˆConditionçš„æ–¹æ³•ã€‚

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š

```java
public class Data {
    private String packet;
    private final Lock lock = new ReentrantLock();
    private boolean transfer = true;

    //å‘é€è€…å’Œæ¥å—è€…å„éœ€è¦ä¸€ä¸ªCondition
    private final Condition receiveCondition = lock.newCondition();
    private final Condition senderCondition = lock.newCondition();

    public String receive() {
        lock.lock();
        try {
            while (transfer) {
                receiveCondition.await();
            }
            transfer = true;
            senderCondition.signalAll();

        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
            return packet;
        }
    }

    public void send(String packet) {
        lock.lock();
        try {
            while (!transfer) {
                senderCondition.await();
            }
            transfer = false;
            this.packet = packet;
            receiveCondition.signalAll();

        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}
```

# Reference

[è¯¦è§£synchronizedä¸Lockçš„åŒºåˆ«ä¸ä½¿ç”¨](https://blog.csdn.net/u012403290/article/details/64910926?locationNum=11&fps=1)

[Java 8 å¹¶å‘æ•™ç¨‹ï¼šåŒæ­¥å’Œé”](https://zhuanlan.zhihu.com/p/33267015)

[çº¿ç¨‹é«˜çº§ç¯‡-Locké”å’ŒConditionæ¡ä»¶](https://www.cnblogs.com/Wanted-Tao/p/6378942.html)