---
title: å¹¶å‘æ“ä½œåˆé›†-10.Executorå’Œçº¿ç¨‹æ± 
typora-copy-images-to: 20181104-3
date: 2018-11-04 14:43:03
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
---

> ğŸ¤ [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— ç›®å½•]()
>
> ğŸ• [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

# Executor

å¹¶å‘APIå¼•å…¥äº†`ExecutorService`ä½œä¸ºä¸€ä¸ªåœ¨ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨Threadçš„é«˜å±‚æ¬¡çš„æ›¿æ¢æ–¹æ¡ˆã€‚Executosæ”¯æŒè¿è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œé€šå¸¸ç®¡ç†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±ä¸éœ€è¦æ‰‹åŠ¨å»åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚åœ¨ä¸æ–­åœ°å¤„ç†ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹æ± å†…éƒ¨çº¿ç¨‹å°†ä¼šå¾—åˆ°å¤ç”¨ï¼Œå› æ­¤ï¼Œåœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªexecutor serviceæ¥è¿è¡Œå’Œæˆ‘ä»¬æƒ³åœ¨æˆ‘ä»¬æ•´ä¸ªç¨‹åºä¸­æ‰§è¡Œçš„ä¸€æ ·å¤šçš„å¹¶å‘ä»»åŠ¡ã€‚

ä¸‹é¢æ˜¯ä½¿ç”¨executorsçš„ç¬¬ä¸€ä¸ªä»£ç ç¤ºä¾‹ï¼š

```java
ExecutorService executor = Executors.newSingleThreadExecutor();
executor.submit(() -> {
String threadName = Thread.currentThread().getName();
System.out.println("Hello " + threadName);
});
// => Hello pool-1-thread-1
```

`Executors`ç±»æä¾›äº†ä¾¿åˆ©çš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºä¸åŒç±»å‹çš„ executor servicesã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå•çº¿ç¨‹çº¿ç¨‹æ± çš„ executorã€‚

ä»£ç è¿è¡Œçš„ç»“æœç±»ä¼¼äºä¸Šä¸€ä¸ªç¤ºä¾‹ï¼Œä½†æ˜¯å½“è¿è¡Œä»£ç æ—¶ï¼Œä½ ä¼šæ³¨æ„åˆ°ä¸€ä¸ªå¾ˆå¤§çš„å·®åˆ«ï¼šJavaè¿›ç¨‹ä»æ²¡æœ‰åœæ­¢ï¼Executorså¿…é¡»æ˜¾å¼çš„åœæ­¢-å¦åˆ™å®ƒä»¬å°†æŒç»­ç›‘å¬æ–°çš„ä»»åŠ¡ã€‚

`ExecutorService`æä¾›äº†ä¸¤ä¸ªæ–¹æ³•æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„â€”â€”`shutdwon()`ä¼šç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œè€Œ`shutdownNow()`ä¼šç»ˆæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å¹¶ç«‹å³å…³é—­execuotrã€‚

è¿™æ˜¯æˆ‘å–œæ¬¢çš„é€šå¸¸å…³é—­executorsçš„æ–¹å¼ï¼š

```java
try {
    System.out.println("å°è¯•ç»ˆæ­¢executor");
    executor.shutdown();
    executor.awaitTermination(5, TimeUnit.SECONDS);// 5ç§’å†…å°è¯•ç»ˆæ­¢,æœŸé—´ä¼šé˜»å¡å½“å‰çº¿ç¨‹

} catch (InterruptedException e) {
    System.err.println("ç»ˆæ­¢è¡Œä¸ºè¢«ä¸­æ–­");
} finally {
    if (!executor.isTerminated()) {
        System.err.println("å¼ºåˆ¶ç»ˆæ­¢æœªç»“æŸçš„ä»»åŠ¡");
    }
    executor.shutdownNow();
    System.out.println("ç»ˆæ­¢å®Œæ¯•");
}
```

executoré€šè¿‡ç­‰å¾…æŒ‡å®šçš„æ—¶é—´è®©å½“å‰æ‰§è¡Œçš„ä»»åŠ¡ç»ˆæ­¢æ¥â€œæ¸©æŸ”çš„â€å…³é—­executorã€‚åœ¨ç­‰å¾…æœ€é•¿5ç§’çš„æ—¶é—´åï¼Œexecuoteæœ€ç»ˆä¼šé€šè¿‡ä¸­æ–­æ‰€æœ‰çš„æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å…³é—­ã€‚

## Callable å’Œ Future

é™¤äº†`Runnable`ï¼Œexecutorè¿˜æ”¯æŒå¦ä¸€ç§ç±»å‹çš„ä»»åŠ¡â€”â€”`Callable`ã€‚Callablesä¹Ÿæ˜¯ç±»ä¼¼äºrunnablesçš„å‡½æ•°æ¥å£ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼ŒCallableè¿”å›ä¸€ä¸ªå€¼ã€‚

ä¸‹é¢çš„lambdaè¡¨è¾¾å¼å®šä¹‰äº†ä¸€ä¸ªcallableï¼šåœ¨ä¼‘çœ ä¸€åˆ†é’Ÿåè¿”å›ä¸€ä¸ªæ•´æ•°ã€‚

```java
Callable<Integer> task = () -> {
    try {
        TimeUnit.MINUTES.sleep(1);
        return 123;
    }
    catch (InterruptedException e) {
        throw new IllegalStateException("task interrupted", e);
    }
};
```

Callbaleä¹Ÿå¯ä»¥åƒrunnbalesä¸€æ ·æäº¤ç»™ executor servicesã€‚ä½†æ˜¯callablesçš„ç»“æœæ€ä¹ˆåŠï¼Ÿå› ä¸º`submit()`ä¸ä¼šç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œexecutor serviceä¸èƒ½ç›´æ¥è¿”å›callableçš„ç»“æœã€‚ä¸è¿‡ï¼Œexecutor å¯ä»¥è¿”å›ä¸€ä¸ª`Future`ç±»å‹çš„ç»“æœï¼Œå®ƒå¯ä»¥ç”¨æ¥åœ¨ç¨åæŸä¸ªæ—¶é—´å–å‡ºå®é™…çš„ç»“æœã€‚

```java
ExecutorService executor = Executors.newFixedThreadPool(1);
Future<Integer> future = executor.submit(task);
System.out.println("future done? " + future.isDone());
Integer result = future.get();
System.out.println("future done? " + future.isDone());
System.out.print("result: " + result);
```

åœ¨å°†callableæäº¤ç»™exectorä¹‹åï¼Œæˆ‘ä»¬å…ˆé€šè¿‡è°ƒç”¨`isDone()`æ¥æ£€æŸ¥è¿™ä¸ªfutureæ˜¯å¦å·²ç»å®Œæˆæ‰§è¡Œã€‚æˆ‘ååˆ†ç¡®å®šè¿™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå› ä¸ºåœ¨è¿”å›é‚£ä¸ªæ•´æ•°ä¹‹å‰callableä¼šä¼‘çœ ä¸€åˆ†é’Ÿã€‚

ä½ å¯èƒ½æ³¨æ„åˆ°æˆ‘ä»¬è¿™æ¬¡åˆ›å»ºexecutorçš„æ–¹å¼ä¸ä¸Šä¸€ä¸ªä¾‹å­ç¨æœ‰ä¸åŒã€‚æˆ‘ä»¬ä½¿ç”¨`newFixedThreadPool(1)`æ¥åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çº¿ç¨‹æ± çš„ execuot serviceã€‚
è¿™ç­‰åŒäºä½¿ç”¨`newSingleThreadExecutor`ä¸è¿‡ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼æˆ‘ä»¬å¯ä»¥ç¨åé€šè¿‡ç®€å•çš„ä¼ å…¥ä¸€ä¸ªæ¯”1å¤§çš„å€¼æ¥å¢åŠ çº¿ç¨‹æ± çš„å¤§å°ã€‚ç¨åæˆ‘è¿˜ä¼šä»‹ç»å…¶ä»–åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•ã€‚

åœ¨è°ƒç”¨`get()`æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°callableåœ¨è¿”å›å®é™…çš„ç»“æœ123ä¹‹å‰æ‰§è¡Œå®Œæˆã€‚ç°åœ¨futureæ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹çš„ç»“æœï¼š

```java
future done? false
future done? true
result: 123
```

Futureä¸åº•å±‚çš„executor serviceç´§å¯†çš„ç»“åˆåœ¨ä¸€èµ·ã€‚è®°ä½ï¼Œå¦‚æœä½ å…³é—­executorï¼Œæ‰€æœ‰çš„æœªä¸­æ­¢çš„futureéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

```java
executor.shutdownNow();
future.get();
```

ä»»ä½•`future.get()`è°ƒç”¨éƒ½ä¼šé˜»å¡ï¼Œç„¶åç­‰å¾…ç›´åˆ°callableä¸­æ­¢ã€‚åœ¨æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªcallableæŒç»­è¿è¡Œâ€”â€”å› æ­¤ä½¿ä½ çš„ç¨‹åºå°†æ²¡æœ‰å“åº”ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•çš„ä¼ å…¥ä¸€ä¸ªæ—¶é•¿æ¥é¿å…è¿™ç§æƒ…å†µã€‚

```java
ExecutorService executor = Executors.newFixedThreadPool(1);
    Future<Integer> future = executor.submit(() -> {
    try {
        TimeUnit.MINUTES.sleep(2);
        return 123;
    } catch (InterruptedException e) {
        throw new IllegalStateException("task interrupted", e);
    }
});
future.get(1, TimeUnit.MINUTES);
```

è¿è¡Œä¸Šé¢çš„ä»£ç å°†ä¼šäº§ç”Ÿä¸€ä¸ª`TimeoutException`ï¼š

```java
Exception in thread "main" java.util.concurrent.TimeoutException
    at java.util.concurrent.FutureTask.get(FutureTask.java:205)
```

ä½ å¯èƒ½å·²ç»çŒœåˆ°ä¸ºä»€ä¹ˆä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚æˆ‘ä»¬æŒ‡å®šçš„æœ€é•¿ç­‰å¾…æ—¶é—´ä¸º1åˆ†é’Ÿï¼Œè€Œè¿™ä¸ªcallableåœ¨è¿”å›ç»“æœä¹‹å‰å®é™…éœ€è¦ä¸¤åˆ†é’Ÿã€‚

## invokeAll

Executorsæ”¯æŒé€šè¿‡`invokeAll()`ä¸€æ¬¡æ‰¹é‡æäº¤å¤šä¸ªcallableã€‚è¿™ä¸ªæ–¹æ³•ç»“æœä¸€ä¸ªcallableçš„é›†åˆï¼Œç„¶åè¿”å›ä¸€ä¸ªfutureçš„åˆ—è¡¨ã€‚

```java
ExecutorService executor = Executors.newWorkStealingPool();
List<Callable<String>> callables = Arrays.asList(
        () -> "task1",
        () -> "task2",
        () -> "task3");
executor.invokeAll(callables)
    .stream()
    .map(future -> {
        try {
            return future.get();
        }
        catch (Exception e) {
            throw new IllegalStateException(e);
        }
    })
    .forEach(System.out::println);
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨Java8ä¸­çš„å‡½æ•°æµï¼ˆstreamï¼‰æ¥å¤„ç†`invokeAll()`è°ƒç”¨è¿”å›çš„æ‰€æœ‰futureã€‚æˆ‘ä»¬é¦–å…ˆå°†æ¯ä¸€ä¸ªfutureæ˜ å°„åˆ°å®ƒçš„è¿”å›å€¼ï¼Œç„¶åå°†æ¯ä¸ªå€¼æ‰“å°åˆ°æ§åˆ¶å°ã€‚

## invokeAny

æ‰¹é‡æäº¤callableçš„å¦ä¸€ç§æ–¹å¼å°±æ˜¯`invokeAny()`ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ä¸`invokeAll()`ç¨æœ‰ä¸åŒã€‚åœ¨ç­‰å¾…futureå¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šé˜»å¡ç›´åˆ°ç¬¬ä¸€ä¸ªcallableä¸­æ­¢ç„¶åè¿”å›è¿™ä¸€ä¸ªcallableçš„ç»“æœã€‚

ä¸ºäº†æµ‹è¯•è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªå¸®åŠ©æ–¹æ³•æ¥æ¨¡æ‹Ÿä¸åŒæ‰§è¡Œæ—¶é—´çš„callableã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªcallableï¼Œè¿™ä¸ªcallableä¼‘çœ æŒ‡å®š çš„æ—¶é—´ç›´åˆ°è¿”å›ç»™å®šçš„ç»“æœã€‚

```java
Callable<String> callable(String result, long sleepSeconds) {
    return () -> {
        TimeUnit.SECONDS.sleep(sleepSeconds);
        return result;
    };
}
```

æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•åˆ›å»ºä¸€ç»„callableï¼Œè¿™äº›callableæ‹¥æœ‰ä¸åŒçš„æ‰§è¡Œæ—¶é—´ï¼Œä»1ç§’åˆ°3ç§’ã€‚é€šè¿‡`invokeAny()`å°†è¿™äº›callableæäº¤ç»™ä¸€ä¸ªexecutorï¼Œè¿”å›æœ€å¿«çš„callableçš„å­—ç¬¦ä¸²ç»“æœ-åœ¨è¿™ä¸ªä¾‹å­ä¸­ä¸ºä»»åŠ¡2ï¼š

```java
ExecutorService executor = Executors.newWorkStealingPool();
List<Callable<String>> callables = Arrays.asList(
callable("task1", 2),
callable("task2", 1),
callable("task3", 3));
String result = executor.invokeAny(callables);
System.out.println(result);
// => task2
```

ä¸Šé¢è¿™ä¸ªä¾‹å­åˆä½¿ç”¨äº†å¦ä¸€ç§æ–¹å¼æ¥åˆ›å»ºexecutorâ€”â€”è°ƒç”¨`newWorkStealingPool()`ã€‚è¿™ä¸ªå·¥å‚æ–¹æ³•æ˜¯Java8å¼•å…¥çš„ï¼Œè¿”å›ä¸€ä¸ª`ForkJoinPool`ç±»å‹çš„ executorï¼Œå®ƒçš„å·¥ä½œæ–¹æ³•ä¸å…¶ä»–å¸¸è§çš„execuotrç¨æœ‰ä¸åŒã€‚ä¸ä½¿ç”¨ä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ä¸åŒï¼Œ`ForkJoinPools`ä½¿ç”¨ä¸€ä¸ªå¹¶è¡Œå› å­æ•°æ¥åˆ›å»ºï¼Œé»˜è®¤å€¼ä¸ºä¸»æœºCPUçš„å¯ç”¨æ ¸å¿ƒæ•°ã€‚

## ScheduledExecutor

æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•åœ¨ä¸€ä¸ª executor ä¸­æäº¤å’Œè¿è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚ä¸ºäº†æŒç»­çš„å¤šæ¬¡æ‰§è¡Œå¸¸è§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è°ƒåº¦çº¿ç¨‹æ± ã€‚

`ScheduledExecutorService`æ”¯æŒä»»åŠ¡è°ƒåº¦ï¼ŒæŒç»­æ‰§è¡Œæˆ–è€…å»¶è¿Ÿä¸€æ®µæ—¶é—´åæ‰§è¡Œã€‚

ä¸‹é¢çš„å®ä¾‹ï¼Œè°ƒåº¦ä¸€ä¸ªä»»åŠ¡åœ¨å»¶è¿Ÿ3ç§’é’Ÿåæ‰§è¡Œï¼š

```java
ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
Runnable task = () -> System.out.println("Scheduling: " + System.nanoTime());
ScheduledFuture<?> future = executor.schedule(task, 3, TimeUnit.SECONDS);
TimeUnit.MILLISECONDS.sleep(1337);
long remainingDelay = future.getDelay(TimeUnit.MILLISECONDS);
System.out.printf("Remaining Delay: %sms", remainingDelay);
```

è°ƒåº¦ä¸€ä¸ªä»»åŠ¡å°†ä¼šäº§ç”Ÿä¸€ä¸ªä¸“é—¨çš„futureç±»å‹â€”â€”`ScheduleFuture`ï¼Œå®ƒé™¤äº†æä¾›äº†Futureçš„æ‰€æœ‰æ–¹æ³•ä¹‹å¤–ï¼Œä»–è¿˜æä¾›äº†`getDelay()`æ–¹æ³•æ¥è·å¾—å‰©ä½™çš„å»¶è¿Ÿã€‚åœ¨å»¶è¿Ÿæ¶ˆé€åï¼Œä»»åŠ¡å°†ä¼šå¹¶å‘æ‰§è¡Œã€‚

ä¸ºäº†è°ƒåº¦ä»»åŠ¡æŒç»­çš„æ‰§è¡Œï¼Œexecutors æä¾›äº†ä¸¤ä¸ªæ–¹æ³•`scheduleAtFixedRate()`å’Œ`scheduleWithFixedDelay()`ã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•ç”¨æ¥ä»¥å›ºå®šé¢‘ç‡æ¥æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ¯”å¦‚ï¼Œä¸‹é¢è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ¯ç§’é’Ÿä¸€æ¬¡ï¼š

```java
ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
Runnable task = () -> System.out.println("Scheduling: " + System.nanoTime());
int initialDelay = 0;
int period = 1;
executor.scheduleAtFixedRate(task, initialDelay, period, TimeUnit.SECONDS);
```

å¦å¤–ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æ¥æ”¶ä¸€ä¸ªåˆå§‹åŒ–å»¶è¿Ÿï¼Œç”¨æ¥æŒ‡å®šè¿™ä¸ªä»»åŠ¡é¦–æ¬¡è¢«æ‰§è¡Œç­‰å¾…çš„æ—¶é•¿ã€‚

è¯·è®°ä½ï¼š`scheduleAtFixedRate()`å¹¶ä¸è€ƒè™‘ä»»åŠ¡çš„å®é™…ç”¨æ—¶ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æŒ‡å®šäº†ä¸€ä¸ªperiodä¸º1åˆ†é’Ÿè€Œä»»åŠ¡éœ€è¦æ‰§è¡Œ2åˆ†é’Ÿï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¸ºäº†æ€§èƒ½ä¼šæ›´å¿«çš„æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ä»–ä¸ä¼šå»¶è¿Ÿç­‰å¾…1åˆ†é’Ÿï¼Œåœ¨2åˆ†é’Ÿæ‰§è¡Œè¿‡åç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ª2åˆ†é’Ÿã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥è€ƒè™‘ä½¿ç”¨`scheduleWithFixedDelay()`ã€‚è¿™ä¸ªæ–¹æ³•çš„å·¥ä½œæ–¹å¼ä¸ä¸Šæˆ‘ä»¬ä¸Šé¢æè¿°çš„ç±»ä¼¼ã€‚ä¸åŒä¹‹å¤„åœ¨äºç­‰å¾…æ—¶é—´ period çš„åº”ç”¨æ˜¯åœ¨ä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸå’Œä¸‹ä¸€ä¸ªä»»åŠ¡çš„å¼€å§‹ä¹‹é—´ã€‚ä¾‹å¦‚ï¼š

```java
ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
Runnable task = () -> {
    try {
        TimeUnit.SECONDS.sleep(2);
        System.out.println("Scheduling: " + System.nanoTime());
    } catch (InterruptedException e) {
        System.err.println("task interrupted");
    }
};
executor.scheduleWithFixedDelay(task, 0, 1, TimeUnit.SECONDS);
```

è¿™ä¸ªä¾‹å­è°ƒåº¦äº†ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶åœ¨ä¸€æ¬¡æ‰§è¡Œçš„ç»“æŸå’Œä¸‹ä¸€æ¬¡æ‰§è¡Œçš„å¼€å§‹ä¹‹é—´è®¾ç½®äº†ä¸€ä¸ª1ç§’é’Ÿçš„å›ºå®šå»¶è¿Ÿã€‚åˆå§‹åŒ–å»¶è¿Ÿä¸º0ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸º0ã€‚æ‰€ä»¥æˆ‘ä»¬åˆ†åˆ«åœ¨0s,3s,6s,9sç­‰é—´éš”å¤„ç»“æŸä¸€æ¬¡æ‰§è¡Œã€‚å¦‚ä½ æ‰€è§ï¼Œ`scheduleWithFixedDelay()`åœ¨ä½ ä¸èƒ½é¢„æµ‹è°ƒåº¦ä»»åŠ¡çš„æ‰§è¡Œæ—¶é•¿æ—¶æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

# çº¿ç¨‹æ± 

æˆ‘ä»¬åœ¨ä»‹ç»Executorçš„è¿‡ç¨‹ä¸­ç”¨åˆ°äº†å‡ ä¸ªçº¿ç¨‹æ± ï¼Œä¸‹é¢ä¼šè¯¦ç»†æ€»ç»“è¿™äº›çº¿ç¨‹æ± ã€‚

Java8é€šè¿‡Executorsæä¾›ä¸ƒç§çº¿ç¨‹æ± ï¼Œåˆ†åˆ«ä¸ºï¼š

- **newCachedThreadPool**åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œè‹¥æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºçº¿ç¨‹ã€‚
- **newFixedThreadPool** åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚
- **newScheduledThreadPool** åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œã€‚
- **newSingleThreadExecutor** åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåº(FIFO, LIFO, ä¼˜å…ˆçº§)æ‰§è¡Œã€‚
- **newSingleThreadScheduledExcutor**ï¼šåˆ›å»ºä¸€ä¸ªå•ä¾‹çº¿ç¨‹æ± ï¼Œå®šæœŸæˆ–å»¶æ—¶æ‰§è¡Œä»»åŠ¡ã€‚
- **newWorkStealingPool** åˆ›å»ºæŒæœ‰è¶³å¤Ÿçº¿ç¨‹çš„çº¿ç¨‹æ± æ¥æ”¯æŒç»™å®šçš„å¹¶è¡Œçº§åˆ«ï¼Œå¹¶é€šè¿‡ä½¿ç”¨å¤šä¸ªé˜Ÿåˆ—ï¼Œå‡å°‘ç«äº‰ï¼Œå®ƒéœ€è¦ç©¿ä¸€ä¸ªå¹¶è¡Œçº§åˆ«çš„å‚æ•°ï¼Œå¦‚æœä¸ä¼ ï¼Œåˆ™è¢«è®¾å®šä¸ºé»˜è®¤çš„CPUæ•°é‡ã€‚
- **ForkJoinPool** æ”¯æŒå¤§ä»»åŠ¡åˆ†è§£æˆå°ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œè¿™æ˜¯Java8æ–°å¢çº¿ç¨‹æ± ï¼Œé€šå¸¸é…åˆForkJoinTaskæ¥å£çš„å­ç±»RecursiveActionæˆ–RecursiveTaskä½¿ç”¨ã€‚

## newCachedThreadPool

åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œè‹¥æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºçº¿ç¨‹ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
ExecutorService cachedThreadPool = Executors.newCachedThreadPool();
for (int i = 0; i < 6; i++) {
    final int index = i;
    try {
        Thread.sleep(index * 100);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    cachedThreadPool.execute(() -> System.out.println(Thread.currentThread().getName()+" : " + index));
}
cachedThreadPool.shutdown();
-------------------------------
è¾“å‡º
pool-1-thread-1 : 0
pool-1-thread-1 : 1
pool-1-thread-1 : 2
pool-1-thread-1 : 3
pool-1-thread-1 : 4
pool-1-thread-1 : 5
```

çº¿ç¨‹æ± ä¸ºæ— é™å¤§ï¼Œå½“æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡æ—¶ç¬¬ä¸€ä¸ªä»»åŠ¡å·²ç»å®Œæˆï¼Œä¼šå¤ç”¨æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡çš„çº¿ç¨‹ï¼Œè€Œä¸ç”¨æ¯æ¬¡æ–°å»ºçº¿ç¨‹ã€‚

## newFixedThreadPool

åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
ExecutorService cachedThreadPool = Executors.newFixedThreadPool(3);
for (int i = 0; i < 6; i++) {
    final int index = i;
    cachedThreadPool.execute(() -> System.out.println(Thread.currentThread().getName()+" : " + index));
}
cachedThreadPool.shutdown();
--------------------------------
è¾“å‡º
pool-1-thread-1 : 0
pool-1-thread-3 : 2
pool-1-thread-2 : 1
pool-1-thread-3 : 4
pool-1-thread-1 : 3
pool-1-thread-2 : 5
```

å®šé•¿çº¿ç¨‹æ± çš„å¤§å°æœ€å¥½æ ¹æ®ç³»ç»Ÿèµ„æºè¿›è¡Œè®¾ç½®ã€‚å¦‚Runtime.getRuntime().availableProcessors()

## newScheduledThreadPool

åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œã€‚å»¶è¿Ÿæ‰§è¡Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
ScheduledExecutorService executor = Executors.newScheduledThreadPool(3);
Runnable task = () -> System.out.println(Thread.currentThread().getName());
int initialDelay= 0;
int period = 1;
executor.scheduleAtFixedRate(task, initialDelay, period, TimeUnit.SECONDS);

TimeUnit.SECONDS.sleep(5);
executor.shutdown();
--------------------------------
è¾“å‡º
pool-1-thread-1
pool-1-thread-1
pool-1-thread-2
pool-1-thread-2
pool-1-thread-2
pool-1-thread-2
```

æ¯è¿‡ä¸€ç§’æ‰§è¡Œä¸€æ¬¡ã€‚

## newSingleThreadExecutor

åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåº(FIFO, LIFO, ä¼˜å…ˆçº§)æ‰§è¡Œã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
ExecutorService executor = Executors.newSingleThreadExecutor();
for (int i = 0; i < 6; i++) {
    final int index = i;
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    executor.execute(() -> System.out.println(Thread.currentThread().getName()+" : " + index));
}
executor.shutdown();
-------------------------------
è¾“å‡º
pool-1-thread-1 : 0
pool-1-thread-1 : 1
pool-1-thread-1 : 2
pool-1-thread-1 : 3
pool-1-thread-1 : 4
pool-1-thread-1 : 5
```

ç»“æœä¾æ¬¡è¾“å‡ºï¼Œç›¸å½“äºé¡ºåºæ‰§è¡Œå„ä¸ªä»»åŠ¡ã€‚

## newWorkStealingPoolå’ŒForkJoinPool

JDK1.8ä¸­æ–°å¼•å…¥çš„è¿™ä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢ä¸¤ä¸ªé“¾æ¥

- [Java å¤šçº¿ç¨‹ä¸­çš„ä»»åŠ¡åˆ†è§£æœºåˆ¶-ForkJoinPoolè¯¦è§£](https://blog.csdn.net/a369414641/article/details/48350795)

- [Java ä¸­7ç§çº¿ç¨‹æ± è¯¦è§£+ç¤ºä¾‹ä»£ç ](https://blog.csdn.net/a369414641/article/details/48342253)

# Reference

[Java 8 å¹¶å‘æ•™ç¨‹ï¼šThreadså’ŒExecutors](https://zhuanlan.zhihu.com/p/33266682)

[Javaå››ç§çº¿ç¨‹æ± çš„ä½¿ç”¨](http://cuisuqiang.iteye.com/blog/2019372)

[Java ä¸­7ç§çº¿ç¨‹æ± è¯¦è§£+ç¤ºä¾‹ä»£ç ](https://blog.csdn.net/a369414641/article/details/48342253)