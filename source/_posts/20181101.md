---
title: å¹¶å‘æ“ä½œåˆé›†-3.Synchronizedä½¿ç”¨æŒ‡å—
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
typora-copy-images-to: 20181101
date: 2018-11-01 21:55:47
---

> ğŸ¤ [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— ç›®å½•]()
>
> ğŸ• [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

è¿™ç¯‡æ–‡ç« å°†å‘Šè¯‰ä½ å¦‚ä½•æ­£ç¡®çš„ä½¿ç”¨*synchronized*å…³é”®å­—ã€‚é€šè¿‡ç¤ºä¾‹ä»£ç å½»åº•äº†è§£*synchronized*å…³é”®å­—çš„ä½¿ç”¨è§„åˆ™å’Œä¸€äº›éšæ‚£ã€‚

## 1.Javaçš„é”

## 1.1 é”çš„å†…å­˜è¯­ä¹‰

- é”å¯ä»¥è®©ä¸´ç•ŒåŒºäº’æ–¥æ‰§è¡Œï¼Œè¿˜å¯ä»¥è®©é‡Šæ”¾é”çš„çº¿ç¨‹å‘åŒä¸€ä¸ªé”çš„çº¿ç¨‹å‘é€æ¶ˆæ¯
- é”çš„é‡Šæ”¾è¦éµå¾ªHappens-beforeåŸåˆ™ï¼ˆ`é”è§„åˆ™ï¼šè§£é”å¿…ç„¶å‘ç”Ÿåœ¨éšåçš„åŠ é”ä¹‹å‰`ï¼‰
- é”åœ¨Javaä¸­çš„å…·ä½“è¡¨ç°æ˜¯ `Synchronized` å’Œ `Lock`

## 2.Synchronizedçš„ç»¼è¿°

- **åŒæ­¥æœºåˆ¶ï¼š** synchronizedæ˜¯JavaåŒæ­¥æœºåˆ¶çš„ä¸€ç§å®ç°ï¼Œå³äº’æ–¥é”æœºåˆ¶ï¼Œå®ƒæ‰€è·å¾—çš„é”å«åšäº’æ–¥é”
- **äº’æ–¥é”ï¼š** æŒ‡çš„æ˜¯æ¯ä¸ªå¯¹è±¡çš„é”ä¸€æ¬¡åªèƒ½åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å ç”¨
- **ä½œç”¨ï¼š** synchronizedç”¨äºä¿è¯åŒä¸€æ—¶åˆ»åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åˆ°ä¸´ç•ŒåŒºï¼ŒåŒæ—¶ä¿è¯å…±äº«å˜é‡çš„å¯è§æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§
- **ä½¿ç”¨ï¼š** å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒæ­¥ä»£ç æ–¹æ³•(å—)æ—¶ï¼Œå®ƒé¦–å…ˆå¿…é¡»å¾—åˆ°é”ï¼Œé€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”

## 3.Synchronizedçš„ä½¿ç”¨

## 3.1 Synchronizedçš„ä¸‰ç§åº”ç”¨æ–¹å¼

![preview](20181101/v2-31082db517ab544d94dae0714369802f_r.jpg)

> **è¡¥å……ï¼š** ä½¿ç”¨åŒæ­¥ä»£ç å—çš„å¥½å¤„åœ¨äºå…¶ä»–çº¿ç¨‹ä»å¯ä»¥è®¿é—®ésynchronized(this)çš„åŒæ­¥ä»£ç å—

## 3.2 Synchronizedçš„ä½¿ç”¨è§„åˆ™

```java
/**
  * å…ˆå®šä¹‰ä¸€ä¸ªæµ‹è¯•æ¨¡æ¿ç±»
  *     è¿™é‡Œè¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šThread.sleep(long)ä¸ä¼šé‡Šæ”¾é”
  *     è¯»è€…å¯å‚è§ç¬”è€…çš„`å¹¶å‘ç•ª@Threadä¸€æ–‡é€š`
  */ 
public class SynchronizedDemo {
    public static synchronized void staticMethod(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†é™æ€åŒæ­¥æ–¹æ³•staticMethod");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "ç»“æŸè®¿é—®é™æ€åŒæ­¥æ–¹æ³•staticMethod");
    }
    public static void staticMethod2(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†é™æ€åŒæ­¥æ–¹æ³•staticMethod2");
        synchronized (SynchronizedDemo.class){
            System.out.println(Thread.currentThread().getName() + "åœ¨staticMethod2æ–¹æ³•ä¸­è·å–äº†SynchronizedDemo.class");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    public synchronized void synMethod(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod");
    }
    public synchronized void synMethod2(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod2");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod2");
    }
    public void method(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†æ™®é€šæ–¹æ³•method");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "ç»“æŸè®¿é—®æ™®é€šæ–¹æ³•method");
    }
    private Object lock = new Object();
    public void chunkMethod(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†chunkMethodæ–¹æ³•");
        synchronized (lock){
            System.out.println(Thread.currentThread().getName() + "åœ¨chunkMethodæ–¹æ³•ä¸­è·å–äº†lock");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    public void chunkMethod2(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†chunkMethod2æ–¹æ³•");
        synchronized (lock){
            System.out.println(Thread.currentThread().getName() + "åœ¨chunkMethod2æ–¹æ³•ä¸­è·å–äº†lock");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    public void chunkMethod3(){
        System.out.println(Thread.currentThread().getName() + "è®¿é—®äº†chunkMethod3æ–¹æ³•");
        //åŒæ­¥ä»£ç å—
        synchronized (this){
            System.out.println(Thread.currentThread().getName() + "åœ¨chunkMethod3æ–¹æ³•ä¸­è·å–äº†this");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    public void stringMethod(String lock){
        synchronized (lock){
            while (true){
                System.out.println(Thread.currentThread().getName());
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
```

## 3.2.1 æ™®é€šæ–¹æ³•ä¸åŒæ­¥æ–¹æ³•è°ƒç”¨äº’ä¸å…³è”

> **å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­£å¸¸è®¿é—®å…¶ä»–éåŒæ­¥æ–¹æ³•**

```java
public static void main(String[] args) {
    SynchronizedDemo synDemo = new SynchronizedDemo();
    Thread thread1 = new Thread(() -> {
        //è°ƒç”¨æ™®é€šæ–¹æ³•
        synDemo.method();
    });
    Thread thread2 = new Thread(() -> {
        //è°ƒç”¨åŒæ­¥æ–¹æ³•
        synDemo.synMethod();
    });
    thread1.start();
    thread2.start();
}
---------------------
//è¾“å‡ºï¼š
Thread-1è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod
Thread-0è®¿é—®äº†æ™®é€šæ–¹æ³•method
Thread-0ç»“æŸè®¿é—®æ™®é€šæ–¹æ³•method
Thread-1ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod
//åˆ†æï¼šé€šè¿‡ç»“æœå¯çŸ¥ï¼Œæ™®é€šæ–¹æ³•å’ŒåŒæ­¥æ–¹æ³•æ˜¯éé˜»å¡æ‰§è¡Œçš„
```

## 3.2.2 æ‰€æœ‰åŒæ­¥æ–¹æ³•åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®

> **å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è®¿é—®ä»»ä½•åŒæ­¥æ–¹æ³•**

```java
public static void main(String[] args) {
    SynchronizedDemo synDemo = new SynchronizedDemo();
    Thread thread1 = new Thread(() -> {
        synDemo.synMethod();
        synDemo.synMethod2();
    });
    Thread thread2 = new Thread(() -> {
        synDemo.synMethod2();
        synDemo.synMethod();
    });
    thread1.start();
    thread2.start();
}
---------------------
//è¾“å‡ºï¼š
Thread-0è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod
Thread-0ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod
Thread-0è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod2
Thread-0ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod2
Thread-1è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod2
Thread-1ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod2
Thread-1è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod
Thread-1ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod
//åˆ†æï¼šé€šè¿‡ç»“æœå¯çŸ¥ï¼Œä»»åŠ¡çš„æ‰§è¡Œæ˜¯é˜»å¡çš„ï¼Œæ˜¾ç„¶Thread-1å¿…é¡»ç­‰å¾…Thread-0æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œ
```

## 3.2.3 åŒä¸€ä¸ªé”çš„åŒæ­¥ä»£ç å—åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®

> **å½“åŒæ­¥ä»£ç å—éƒ½æ˜¯åŒä¸€ä¸ªé”æ—¶ï¼Œæ–¹æ³•å¯ä»¥è¢«æ‰€æœ‰çº¿ç¨‹è®¿é—®ï¼Œä½†åŒä¸€ä¸ªé”çš„åŒæ­¥ä»£ç å—åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®**

```java
public static void main(String[] args) {
    SynchronizedDemo synDemo = new SynchronizedDemo();
    Thread thread1 = new Thread(() -> {
        //è°ƒç”¨åŒæ­¥å—æ–¹æ³•
        synDemo.chunkMethod();
        synDemo.chunkMethod2();
    });
    Thread thread2 = new Thread(() -> {
        //è°ƒç”¨åŒæ­¥å—æ–¹æ³•
        synDemo.chunkMethod();
        synDemo.chunkMethod2();
    });
    thread1.start();
    thread2.start();
}
---------------------
//è¾“å‡ºï¼š
Thread-0è®¿é—®äº†chunkMethodæ–¹æ³•
Thread-1è®¿é—®äº†chunkMethodæ–¹æ³•
Thread-0åœ¨chunkMethodæ–¹æ³•ä¸­è·å–äº†lock  
...åœé¡¿ç­‰å¾…...
Thread-1åœ¨chunkMethodæ–¹æ³•ä¸­è·å–äº†lock
...åœé¡¿ç­‰å¾…...
Thread-0è®¿é—®äº†chunkMethod2æ–¹æ³•
Thread-0åœ¨chunkMethod2æ–¹æ³•ä¸­è·å–äº†lock
...åœé¡¿ç­‰å¾…...
Thread-1è®¿é—®äº†chunkMethod2æ–¹æ³•
Thread-1åœ¨chunkMethod2æ–¹æ³•ä¸­è·å–äº†lock
//åˆ†æå¯çŸ¥ï¼š
//1.å¯¹æ¯”18è¡Œå’Œ19è¡Œå¯çŸ¥ï¼Œå³ä½¿æ™®é€šæ–¹æ³•æœ‰åŒæ­¥ä»£ç å—ï¼Œä½†æ–¹æ³•çš„è®¿é—®æ˜¯éé˜»å¡çš„ï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è‡ªç”±è¿›å…¥
//2.å¯¹æ¯”20è¡Œã€22è¡Œä»¥åŠ25è¡Œå’Œ27è¡Œå¯çŸ¥ï¼Œå¯¹äºåŒä¸€ä¸ªé”çš„åŒæ­¥ä»£ç å—çš„è®¿é—®ä¸€å®šæ˜¯é˜»å¡çš„
```

## 3.2.4 çº¿ç¨‹é—´åŒæ—¶è®¿é—®åŒä¸€ä¸ªé”çš„å¤šä¸ªåŒæ­¥ä»£ç çš„æ‰§è¡Œé¡ºåºä¸å®š

- çº¿ç¨‹é—´åŒæ—¶è®¿é—®åŒä¸€ä¸ªé”å¤šä¸ªåŒæ­¥ä»£ç çš„æ‰§è¡Œé¡ºåºä¸å®šï¼Œå³ä½¿æ˜¯ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡é”ï¼Œè¿™ç‚¹è·ŸåŒæ­¥æ–¹æ³•æœ‰å¾ˆå¤§å·®å¼‚
- ï¼Ÿï¼Ÿè¯»è€…å¯ä»¥å…ˆæ€è€ƒä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Ÿï¼Ÿ

```java
public static void main(String[] args) {
    SynchronizedDemo synDemo = new SynchronizedDemo();
    Thread thread1 = new Thread(() -> {
        //è°ƒç”¨åŒæ­¥å—æ–¹æ³•
        synDemo.chunkMethod();
        synDemo.chunkMethod2();
    });
    Thread thread2 = new Thread(() -> {
        //è°ƒç”¨åŒæ­¥å—æ–¹æ³•
        synDemo.chunkMethod2();
        synDemo.chunkMethod();
    });
    thread1.start();
    thread2.start();
}
---------------------
//è¾“å‡ºï¼š
Thread-0è®¿é—®äº†chunkMethodæ–¹æ³•
Thread-1è®¿é—®äº†chunkMethod2æ–¹æ³•
Thread-0åœ¨chunkMethodæ–¹æ³•ä¸­è·å–äº†lock
...åœé¡¿ç­‰å¾…...
Thread-0è®¿é—®äº†chunkMethod2æ–¹æ³•
Thread-1åœ¨chunkMethod2æ–¹æ³•ä¸­è·å–äº†lock
...åœé¡¿ç­‰å¾…...
Thread-1è®¿é—®äº†chunkMethodæ–¹æ³•
Thread-0åœ¨chunkMethod2æ–¹æ³•ä¸­è·å–äº†lock
...åœé¡¿ç­‰å¾…...
Thread-1åœ¨chunkMethodæ–¹æ³•ä¸­è·å–äº†lock

//åˆ†æå¯çŸ¥ï¼š
//ç°è±¡ï¼šå¯¹æ¯”20è¡Œã€22è¡Œå’Œ24è¡Œã€25è¡Œå¯çŸ¥ï¼Œè™½ç„¶æ˜¯åŒä¸€ä¸ªlockå¯¹è±¡ï¼Œä½†å…¶ä¸åŒä»£ç å—çš„è®¿é—®æ˜¯éé˜»å¡çš„
//åŸå› ï¼šæ ¹æºåœ¨äºé”çš„é‡Šæ”¾å’Œé‡æ–°ç«äº‰ï¼Œå½“Thread-0è®¿é—®å®ŒchunkMethodæ–¹æ³•åä¼šå…ˆé‡Šæ”¾é”ï¼Œè¿™æ—¶Thread-1å°±æœ‰æœºä¼šèƒ½è·å–åˆ°é”ä»è€Œä¼˜å…ˆæ‰§è¡Œï¼Œä¾æ¬¡ç±»æ¨åˆ°24è¡Œã€25è¡Œæ—¶ï¼ŒThread-0åˆé‡æ–°è·å–åˆ°é”ä¼˜å…ˆæ‰§è¡Œäº†
//æ³¨æ„ï¼šä½†æœ‰ä¸€ç‚¹æ˜¯å¿…é¡»çš„ï¼Œå¯¹äºåŒä¸€ä¸ªé”çš„åŒæ­¥ä»£ç å—çš„è®¿é—®ä¸€å®šæ˜¯é˜»å¡çš„
//è¡¥å……ï¼šåŒæ­¥æ–¹æ³•ä¹‹æ‰€æœ‰ä¼šè¢«å…¨éƒ¨é˜»å¡ï¼Œæ˜¯å› ä¸ºsynDemoå¯¹è±¡ä¸€ç›´è¢«çº¿ç¨‹åœ¨å†…éƒ¨æŠŠæŒä½å°±æ²¡é‡Šæ”¾è¿‡ï¼Œè®ºæŠŠæŒä½çš„é‡è¦æ€§ï¼
```

## 3.2.5 ä¸åŒé”ä¹‹é—´è®¿é—®éé˜»å¡

- ç”±äºä¸‰ç§ä½¿ç”¨æ–¹å¼çš„é”å¯¹è±¡éƒ½ä¸ä¸€æ ·ï¼Œå› æ­¤ç›¸äº’ä¹‹é—´ä¸ä¼šæœ‰ä»»ä½•å½±å“

- ä½†æœ‰ä¸¤ç§æƒ…å†µé™¤å¤–ï¼š

- - 1.å½“åŒæ­¥ä»£ç å—ä½¿ç”¨çš„Classå¯¹è±¡å’Œç±»å¯¹è±¡ä¸€è‡´æ—¶å±äºåŒä¸€ä¸ªé”ï¼Œéµå¾ªä¸Šé¢çš„`3.2.3`åŸåˆ™
  - 2.å½“åŒæ­¥ä»£ç å—ä½¿ç”¨çš„æ˜¯thisï¼Œå³ä¸åŒæ­¥æ–¹æ³•ä½¿ç”¨é”å±äºåŒä¸€ä¸ªé”ï¼Œéµå¾ªä¸Šé¢çš„`3.2.2`å’Œ`3.2.3`åŸåˆ™

```java
public static void main(String[] args) {
    SynchronizedDemo synDemo = new SynchronizedDemo();
    Thread thread1 = new Thread(() -> synDemo.chunkMethod());   //åŒæ­¥å—ï¼Œé”æ˜¯ä¸€ä¸ªobject
    Thread thread2 = new Thread(() -> synDemo.chunkMethod3());  //åŒæ­¥å—ï¼Œé”æ˜¯this
    Thread thread3 = new Thread(() -> synDemo.staticMethod());  //é™æ€åŒæ­¥æ–¹æ³•,(éšè§†é”æ˜¯SynchronizedDemo.class)
    Thread thread4 = new Thread(() -> synDemo.staticMethod2()); //é™æ€æ–¹æ³• + åŒæ­¥å—,é”æ˜¯SynchronizedDemo.class

    thread1.start();
    thread2.start();
    thread3.start();
    thread4.start();
}
---------------------
//è¾“å‡ºï¼š
Thread-1è®¿é—®äº†chunkMethod3æ–¹æ³•
Thread-1åœ¨chunkMethod3æ–¹æ³•ä¸­è·å–äº†this
Thread-2è®¿é—®äº†é™æ€åŒæ­¥æ–¹æ³•staticMethod
Thread-0è®¿é—®äº†chunkMethodæ–¹æ³•
Thread-0åœ¨chunkMethodæ–¹æ³•ä¸­è·å–äº†lock
Thread-3è®¿é—®äº†é™æ€åŒæ­¥æ–¹æ³•staticMethod2
...åœé¡¿ç­‰å¾…...
Thread-2ç»“æŸè®¿é—®é™æ€åŒæ­¥æ–¹æ³•staticMethod
Thread-3åœ¨staticMethod2æ–¹æ³•ä¸­è·å–äº†SynchronizedDemo.class
//åˆ†æå¯çŸ¥ï¼š
//ç°è±¡ï¼šå¯¹æ¯”16è¡Œã€18è¡Œå’Œ24è¡Œã€25è¡Œå¯çŸ¥ï¼Œè™½ç„¶æ˜¯åŒä¸€ä¸ªlockå¯¹è±¡ï¼Œä½†å…¶ä¸åŒä»£ç å—çš„è®¿é—®æ˜¯éé˜»å¡çš„
//åŸå› ï¼šæ ¹æºåœ¨äºé”çš„é‡Šæ”¾å’Œé‡æ–°ç«äº‰ï¼Œå½“Thread-0è®¿é—®å®ŒchunkMethodæ–¹æ³•åä¼šå…ˆé‡Šæ”¾é”ï¼Œè¿™æ—¶Thread-1å°±æœ‰æœºä¼šèƒ½è·å–åˆ°é”ä»è€Œä¼˜å…ˆæ‰§è¡Œï¼Œä¾æ¬¡ç±»æ¨åˆ°24è¡Œã€25è¡Œæ—¶ï¼ŒThread-0åˆé‡æ–°è·å–åˆ°é”ä¼˜å…ˆæ‰§è¡Œäº†
```

- ## 3.3 Synchronizedçš„å¯é‡å…¥æ€§

  - **é‡å…¥é”ï¼š**å½“ä¸€ä¸ªçº¿ç¨‹å†æ¬¡è¯·æ±‚è‡ªå·±æŒæœ‰å¯¹è±¡é”çš„ä¸´ç•Œèµ„æºæ—¶ï¼Œè¿™ç§æƒ…å†µå±äºé‡å…¥é”ï¼Œè¯·æ±‚å°†ä¼šæˆåŠŸ
  - **å®ç°ï¼š**ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°ä¸€ä¸ªå¯¹è±¡é”åå†æ¬¡è¯·æ±‚è¯¥å¯¹è±¡é”ï¼Œæ˜¯å…è®¸çš„ï¼Œæ¯é‡å…¥ä¸€æ¬¡ï¼Œmonitorè¿›å…¥æ¬¡æ•°+1

  ```java
  public static void main(String[] args) {
      SynchronizedDemo synDemo = new SynchronizedDemo();
      Thread thread1 = new Thread(() -> {
          synDemo.synMethod();
          synDemo.synMethod2();
      });
      Thread thread2 = new Thread(() -> {
          synDemo.synMethod2();
          synDemo.synMethod();
      });
      thread1.start();
      thread2.start();
  }
  ---------------------
  //è¾“å‡ºï¼š
  Thread-0è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod
  Thread-0ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod
  Thread-0è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod2
  Thread-0ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod2
  Thread-1è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod2
  Thread-1ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod2
  Thread-1è®¿é—®äº†åŒæ­¥æ–¹æ³•synMethod
  Thread-1ç»“æŸè®¿é—®åŒæ­¥æ–¹æ³•synMethod
  //åˆ†æï¼šå¯¹æ¯”16è¡Œå’Œ18è¡Œå¯çŸ¥ï¼Œåœ¨ä»£ç å—ä¸­ç»§ç»­è°ƒç”¨äº†å½“å‰å®ä¾‹å¯¹è±¡çš„å¦å¤–ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œå†æ¬¡è¯·æ±‚å½“å‰å®ä¾‹é”æ—¶ï¼Œå°†è¢«å…è®¸ï¼Œè¿›è€Œæ‰§è¡Œæ–¹æ³•ä½“ä»£ç ï¼Œè¿™å°±æ˜¯é‡å…¥é”æœ€ç›´æ¥çš„ä½“ç°
  ```

  ## 3.4 Synchronizedä¸Stringé”

  - **éšæ‚£ï¼š**ç”±äºåœ¨JVMä¸­å…·æœ‰Stringå¸¸é‡æ± ç¼“å­˜çš„åŠŸèƒ½ï¼Œå› æ­¤**ç›¸åŒå­—é¢é‡æ˜¯åŒä¸€ä¸ªé”ï¼ï¼ï¼**
  - **æ³¨æ„ï¼š**ä¸¥é‡ä¸æ¨èå°†Stringä½œä¸ºé”å¯¹è±¡ï¼Œè€Œåº”è¯¥æ”¹ç”¨å…¶ä»–éç¼“å­˜å¯¹è±¡
  - **æç¤ºï¼š**å¯¹å­—é¢é‡æœ‰ç–‘é—®çš„è¯è¯·å…ˆå›é¡¾ä¸€ä¸‹Stringçš„åŸºç¡€ï¼Œè¿™é‡Œä¸åŠ ä»¥è§£é‡Š

  ```java
  public static void main(String[] args) {
      SynchronizedDemo synDemo = new SynchronizedDemo();
      Thread thread1 = new Thread(() -> synDemo.stringMethod("sally"));
      Thread thread2 = new Thread(() -> synDemo.stringMethod("sally"));
      thread1.start();
      thread2.start();
  }
  ---------------------
  //è¾“å‡ºï¼š
  Thread-0
  Thread-0
  Thread-0
  Thread-0
  ...æ­»å¾ªç¯...
  //åˆ†æï¼šè¾“å‡ºç»“æœæ°¸è¿œéƒ½æ˜¯Thread-0çš„æ­»å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¯´å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå³Thread-1çº¿ç¨‹æ ¹æœ¬ä¸ä¼šè¿è¡Œ
  //åŸå› ï¼šåŒæ­¥å—ä¸­çš„é”æ˜¯åŒä¸€ä¸ªå­—é¢é‡
  ```

  ## 3.5 Synchronizedä¸ä¸å¯å˜é”

  - **éšæ‚£ï¼š**å½“ä½¿ç”¨ä¸å¯å˜ç±»å¯¹è±¡(final Class)ä½œä¸ºå¯¹è±¡é”æ—¶ï¼Œä½¿ç”¨synchronizedåŒæ ·ä¼šæœ‰å¹¶å‘é—®é¢˜
  - **åŸå› ï¼š**ç”±äºä¸å¯å˜ç‰¹æ€§ï¼Œå½“ä½œä¸ºé”ä½†åŒæ­¥å—å†…éƒ¨ä»ç„¶æœ‰è®¡ç®—æ“ä½œï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é”å¯¹è±¡
  - **æ³¨æ„ï¼š**ä¸¥é‡ä¸æ¨èå°†final Classä½œä¸ºé”å¯¹è±¡æ—¶ä»å¯¹å…¶æœ‰è®¡ç®—æ“ä½œ
  - **è¡¥å……ï¼š**è™½ç„¶Stringä¹Ÿæ˜¯final Classï¼Œä½†å®ƒçš„åŸå› å´æ˜¯å­—é¢é‡å¸¸é‡æ± 

```java
public class SynchronizedDemo {
    static Integer i = 0;   //Integeræ˜¯final Class
    public static void main(String[] args) throws InterruptedException {
        Runnable runnable = new Runnable() {
            @Override
            public void run() {
                for (int j = 0;j<10000;j++){
                    synchronized (i){
                        i++;
                    }
                }
            }
        };
        Thread thread1 = new Thread(runnable);
        Thread thread2 = new Thread(runnable);
        thread1.start();
        thread2.start();
        thread1.join();
        thread2.join();
        System.out.println(i);
    }
}
---------------------
//è¾“å‡ºï¼š
14134
//åˆ†æï¼šè·Ÿé¢„æƒ³ä¸­çš„20000ä¸ä¸€è‡´ï¼Œå½“ä½¿ç”¨Integerä½œä¸ºå¯¹è±¡é”æ—¶ä½†è¿˜æœ‰è®¡ç®—æ“ä½œå°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜
```

## 3.6 Synchronizedä¸æ­»é”

- **æ­»é”ï¼š**å½“çº¿ç¨‹é—´éœ€è¦**ç›¸äº’ç­‰å¾…å¯¹æ–¹å·²æŒæœ‰çš„é”**æ—¶ï¼Œå°±å½¢æˆæ­»é”ï¼Œè¿›è€Œäº§ç”Ÿæ­»å¾ªç¯
- **æ³¨æ„ï¼š****ä»£ç ä¸­ä¸¥ç¦å‡ºç°æ­»é”ï¼ï¼ï¼**

```java
public static void main(String[] args) {
    Object lock = new Object();
    Object lock2 = new Object();
    Thread thread1 = new Thread(() -> {
        synchronized (lock){
            System.out.println(Thread.currentThread().getName() + "è·å–åˆ°locké”");
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            synchronized (lock2){
                System.out.println(Thread.currentThread().getName() + "è·å–åˆ°lock2é”");
            }
        }
    });
    Thread thread2 = new Thread(() -> {
        synchronized (lock2){
            System.out.println(Thread.currentThread().getName() + "è·å–åˆ°lock2é”");
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            synchronized (lock){
                System.out.println(Thread.currentThread().getName() + "è·å–åˆ°locké”");
            }
        }
    });
    thread1.start();
    thread2.start();
}
---------------------
//è¾“å‡ºï¼š
Thread-1è·å–åˆ°lock2é”
Thread-0è·å–åˆ°locké”
.....
//åˆ†æï¼šçº¿ç¨‹0è·å¾—locké”ï¼Œçº¿ç¨‹1è·å¾—lock2é”ï¼Œä½†ä¹‹åç”±äºä¸¤ä¸ªçº¿ç¨‹è¿˜è¦è·å–å¯¹æ–¹å·²æŒæœ‰çš„é”ï¼Œä½†å·²æŒæœ‰çš„é”éƒ½ä¸ä¼šè¢«åŒæ–¹é‡Šæ”¾ï¼Œçº¿ç¨‹"å‡æ­»"ï¼Œæ— æ³•å¾€ä¸‹æ‰§è¡Œï¼Œä»è€Œå½¢æˆæ­»å¾ªç¯ï¼Œå³æ­»é”ï¼Œä¹‹åä¸€ç›´åœ¨åšæ— ç”¨çš„æ­»å¾ªç¯ï¼Œä¸¥é‡æµªè´¹ç³»ç»Ÿèµ„æº
```

# Reference

[Java 8 å¹¶å‘ç¯‡ - å†·é™åˆ†æ Synchronizedï¼ˆä¸Šï¼‰](https://zhuanlan.zhihu.com/p/34537635)

[å¹¶å‘ç•ª@Synchronizedä¸€æ–‡é€šï¼ˆ1.8ç‰ˆï¼‰](https://www.zybuluo.com/kiraSally/note/857726)