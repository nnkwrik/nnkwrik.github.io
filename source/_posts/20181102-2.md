---
title: å¹¶å‘æ“ä½œåˆé›†-6.å¹¶å‘å®¹å™¨ï¼šConcurrentHashMap
typora-copy-images-to: 20181102-2
date: 2018-11-02 20:12:17
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
---
> ğŸ¤ [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— ç›®å½•]()
>
> ğŸ• [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

Javaä¸­æä¾›äº†å¤§é‡çš„å¹¶å‘å®¹å™¨ï¼Œå®ƒä»¬ä¸åŒäºå¹¶è¡Œå®¹å™¨ï¼ˆVectorï¼ŒHashMapï¼‰ã€‚å¹¶å‘å®¹å™¨åœ¨ç¡®ä¿çº¿ç¨‹å®‰å…¨çš„åŒæ—¶åˆå…·å¤‡è¾ƒé«˜çš„æ€§èƒ½ã€‚

æœ¬ç« ä¼šä»‹ç»å¹¶å‘å®¹å™¨ä¸­æœ€å¸¸ç”¨çš„ConcurrentHashMapã€‚

# ConcurrentHashMapç®€ä»‹

ConcurrentMapæ¥å£ç»§æ‰¿è‡ª`Map`æ¥å£ï¼Œå®ç°äº†é«˜ååé‡çš„åŒæ—¶çº¿ç¨‹å®‰å…¨ã€‚ConcurrentHashMapæ˜¯ConcurrentMapçš„å®ç°ã€‚åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼å’ŒMapç›¸ä¼¼ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ¶‰åŠä¸€äº›åŸç†ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£ConcurrentHashMapä¸ºä½•èƒ½å®ç°é«˜ååé‡ã€‚ä¹‹åæˆ‘ä»¬ä¼šçœ‹ä¸€ä¸‹JDK1.8ä¸­æ–°æ·»åŠ çš„æ–¹æ³•ã€‚

# ConcurrentHashMapåŸç†

æ•´ä¸ª ConcurrentHashMap ç”±ä¸€ä¸ªä¸ª Segment ç»„æˆï¼ŒSegment ä»£è¡¨â€éƒ¨åˆ†â€œæˆ–â€ä¸€æ®µâ€œçš„æ„æ€ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹éƒ½ä¼šå°†å…¶æè¿°ä¸ºåˆ†æ®µé”ã€‚

ç®€å•ç†è§£å°±æ˜¯ï¼ŒConcurrentHashMap æ˜¯ä¸€ä¸ª Segment æ•°ç»„ï¼ŒSegment é€šè¿‡ç»§æ‰¿ ReentrantLock æ¥è¿›è¡ŒåŠ é”ï¼Œæ‰€ä»¥æ¯æ¬¡éœ€è¦åŠ é”çš„æ“ä½œé”ä½çš„æ˜¯ä¸€ä¸ª segmentï¼Œè¿™æ ·åªè¦ä¿è¯æ¯ä¸ª Segment æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå°±å®ç°äº†å…¨å±€çš„çº¿ç¨‹å®‰å…¨ã€‚

**concurrencyLevel**ï¼šå¹¶è¡Œçº§åˆ«ã€‚é»˜è®¤æ˜¯ 16ï¼Œä¹Ÿå°±æ˜¯è¯´ ConcurrentHashMap æœ‰ 16 ä¸ª Segmentsã€‚è¿™ä¸ªæ—¶å€™ï¼Œæœ€å¤šå¯ä»¥åŒæ—¶æ”¯æŒ 16 ä¸ªçº¿ç¨‹å¹¶å‘å†™ï¼Œåªè¦å®ƒä»¬çš„æ“ä½œåˆ†åˆ«åˆ†å¸ƒåœ¨ä¸åŒçš„ Segment ä¸Šã€‚è¿™ä¸ªå€¼å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®ä¸ºå…¶ä»–å€¼ã€‚

å…³äºå®ƒçš„åˆå§‹åŒ–å’Œgetï¼Œputçš„å®ç°åŸç†ï¼Œå¯ä»¥å‚è€ƒæ–‡æœ«çš„é“¾æ¥ã€‚

# ConcurrentMapæ–°æ–¹æ³•

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ˜ å°„ç¤ºä¾‹æ¥å±•ç¤ºé‚£äº›JDK1.8æä¾›æ–°çš„æ–¹æ³•ï¼š

```java
ConcurrentMap<String, String> map = new ConcurrentHashMap<>();
map.put("foo", "bar");
map.put("han", "solo");
map.put("r2", "d2");
map.put("c3", "p0");
```

`forEach()`æ–¹æ³•æ¥å—ç±»å‹ä¸º`BiConsumer`çš„lambdaè¡¨è¾¾å¼ï¼Œä»¥æ˜ å°„çš„é”®å’Œå€¼ä½œä¸ºå‚æ•°ä¼ é€’ã€‚å®ƒå¯ä»¥ä½œä¸º`for-each`å¾ªç¯çš„æ›¿ä»£ï¼Œæ¥éå†å¹¶å‘æ˜ å°„ä¸­çš„å…ƒç´ ã€‚è¿­ä»£åœ¨å½“å‰çº¿ç¨‹ä¸Šä¸²è¡Œæ‰§è¡Œã€‚

```java
map.forEach((key, value) -> System.out.printf("%s = %s\n", key, value));
```

æ–°æ–¹æ³•`putIfAbsent()`åªåœ¨æä¾›çš„é”®ä¸å­˜åœ¨æ—¶ï¼Œå°†æ–°çš„å€¼æ·»åŠ åˆ°æ˜ å°„ä¸­ã€‚è‡³å°‘åœ¨`ConcurrentHashMap`çš„å®ç°ä¸­ï¼Œè¿™ä¸€æ–¹æ³•åƒ`put()`ä¸€æ ·æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä½ åœ¨ä¸åŒçº¿ç¨‹ä¸­å¹¶å‘è®¿é—®æ˜ å°„æ—¶ï¼Œä¸éœ€è¦ä»»ä½•åŒæ­¥æœºåˆ¶ã€‚

```java
String value = map.putIfAbsent("c3","p1");
System.out.println(value);          //è¾“å‡ºp0
System.out.println(map.get("c3"));  //è¿”å›çš„ä»æ˜¯åŸæ¥çš„p0

String value2 = map.putIfAbsent("c4","p1");
System.out.println(value2);         //è¾“å‡ºnull
System.out.println(map.get("c4"));  //è¿”å›æ–°å€¼p1
```

æ— è®ºéšå°„æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒputIfAbsent()éƒ½ä¼šè¿”å›è¯¥æ–¹æ³•è¢«è°ƒå‰çš„å€¼ã€‚

`getOrDefault()`æ–¹æ³•è¿”å›æŒ‡å®šé”®çš„å€¼ã€‚åœ¨ä¼ å…¥çš„é”®ä¸å­˜åœ¨æ—¶ï¼Œä¼šè¿”å›é»˜è®¤å€¼ï¼š

```java
String value = map.getOrDefault("hi", "there");
System.out.println(value);    // there
```

`replaceAll()`æ¥å—ç±»å‹ä¸º`BiFunction`çš„lambdaè¡¨è¾¾å¼ã€‚`BiFunction`æ¥å—ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚å‡½æ•°åœ¨è¿™é‡Œä»¥æ¯ä¸ªå…ƒç´ çš„é”®å’Œå€¼è°ƒç”¨ï¼Œå¹¶è¿”å›è¦æ˜ å°„åˆ°å½“å‰é”®çš„æ–°å€¼ã€‚

```java
map.replaceAll((key, value) -> "r2".equals(key) ? "d3" : value);
System.out.println(map.get("r2"));    // d3
```

`compute()`å…è®¸æˆ‘ä»¬è½¬æ¢å•ä¸ªå…ƒç´ ï¼Œè€Œä¸æ˜¯æ›¿æ¢æ˜ å°„ä¸­çš„æ‰€æœ‰å€¼ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—éœ€è¦å¤„ç†çš„é”®ï¼Œå’Œç”¨äºæŒ‡å®šå€¼çš„è½¬æ¢çš„`BiFunction`ã€‚

```java
map.compute("foo", (key, value) -> value + value);
System.out.println(map.get("foo"));   // barbar
```

é™¤äº†`compute()`ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªå˜ä½“ï¼š`computeIfAbsent()` å’Œ `computeIfPresent()`ã€‚è¿™äº›æ–¹æ³•çš„å‡½æ•°å¼å‚æ•°åªåœ¨é”®ä¸å­˜åœ¨æˆ–å­˜åœ¨æ—¶è¢«è°ƒç”¨ã€‚

æœ€åï¼Œ`merge()`æ–¹æ³•å¯ä»¥ç”¨äºä»¥æ˜ å°„ä¸­çš„ç°æœ‰å€¼æ¥ç»Ÿä¸€æ–°çš„å€¼ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—é”®ã€éœ€è¦å¹¶å…¥ç°æœ‰å…ƒç´ çš„æ–°å€¼ï¼Œä»¥åŠæŒ‡å®šä¸¤ä¸ªå€¼çš„åˆå¹¶è¡Œä¸ºçš„`BiFunction`ã€‚

```java
map.merge("foo",    //é”®
          "newVal",  //æƒ³è¦å¹¶å…¥çš„æ–°å€¼ â€œnewValâ€ 
          (oldVal, newVal) -> newVal + " was " + oldVal);//oldValæ˜¯åŸæ¥çš„å€¼â€œbarâ€,newValæ˜¯æ–°å€¼ â€œnewValâ€ 
System.out.println(map.get("foo")); //new was bar
```

# ConcurrentHashMapæ–°æ–¹æ³•

æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½æ˜¯`ConcurrentMap`æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å¯åœ¨æ‰€æœ‰è¯¥æ¥å£çš„å®ç°ä¸Šè°ƒç”¨ã€‚æ­¤å¤–ï¼Œæœ€é‡è¦çš„å®ç°`ConcurrentHashMap`ä½¿ç”¨äº†ä¸€äº›æ–°çš„æ–¹æ³•æ¥æ”¹è¿›ï¼Œä¾¿äºåœ¨æ˜ å°„ä¸Šæ‰§è¡Œå¹¶è¡Œæ“ä½œã€‚

å°±åƒå¹¶è¡Œæµé‚£æ ·ï¼Œè¿™äº›æ–¹æ³•ä½¿ç”¨ç‰¹å®šçš„`ForkJoinPool`ï¼Œç”±Java8ä¸­çš„`ForkJoinPool.commonPool()`æä¾›ã€‚è¯¥æ± ä½¿ç”¨äº†å–å†³äºå¯ç”¨æ ¸å¿ƒæ•°é‡çš„é¢„ç½®å¹¶è¡Œæœºåˆ¶ã€‚æˆ‘çš„ç”µè„‘æœ‰å››ä¸ªæ ¸å¿ƒå¯ç”¨ï¼Œè¿™ä¼šä½¿å¹¶è¡Œæ€§çš„ç»“æœä¸º3ï¼š

```java
System.out.println(ForkJoinPool.getCommonPoolParallelism());  // 3 
```

è¿™ä¸ªå€¼å¯ä»¥é€šè¿‡è®¾ç½®ä¸‹åˆ—JVMå‚æ•°æ¥å¢å‡ï¼š

```java
-Djava.util.concurrent.ForkJoinPool.common.parallelism=5
```

Java8å¼•å…¥äº†ä¸‰ç§ç±»å‹çš„å¹¶è¡Œæ“ä½œï¼š`forEach`ã€`search` å’Œ `reduce`ã€‚è¿™äº›æ“ä½œä¸­æ¯ä¸ªéƒ½ä»¥å››ç§å½¢å¼æä¾›ï¼Œæ¥å—ä»¥é”®ã€å€¼ã€å…ƒç´ æˆ–é”®å€¼å¯¹ä¸ºå‚æ•°çš„å‡½æ•°ã€‚

æ‰€æœ‰è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é€šç”¨çš„`parallelismThreshold`ã€‚è¿™ä¸€é˜ˆå€¼è¡¨ç¤ºæ“ä½œå¹¶è¡Œæ‰§è¡Œæ—¶çš„æœ€å°é›†åˆå¤§å°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä¼ å…¥é˜ˆå€¼500ï¼Œè€Œæ˜ å°„çš„å®é™…å¤§å°æ˜¯499ï¼Œé‚£ä¹ˆæ“ä½œå°±ä¼šåœ¨å•çº¿ç¨‹ä¸Šä¸²è¡Œæ‰§è¡Œã€‚åœ¨ä¸‹ä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨é˜ˆå€¼1ï¼Œå§‹ç»ˆå¼ºåˆ¶3ä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œæ¥å±•ç¤ºã€‚

forEach

`forEach()`æ–¹æ³•å¯ä»¥å¹¶è¡Œè¿­ä»£æ˜ å°„ä¸­çš„é”®å€¼å¯¹ã€‚`BiConsumer`ä»¥å½“å‰è¿­ä»£å…ƒç´ çš„é”®å’Œå€¼è°ƒç”¨ã€‚ä¸ºäº†å°†å¹¶è¡Œæ‰§è¡Œå¯è§†åŒ–ï¼Œæˆ‘ä»¬å‘æ§åˆ¶å°æ‰“å°äº†å½“å‰çº¿ç¨‹çš„åç§°ã€‚è¦æ³¨æ„åœ¨æˆ‘è¿™é‡Œåº•å±‚çš„`ForkJoinPool`æœ€å¤šä½¿ç”¨ä¸‰ä¸ªçº¿ç¨‹ã€‚

```java
map.forEach(1, (key, value) ->
    System.out.printf("key: %s; value: %s; thread: %s\n",
        key, value, Thread.currentThread().getName()));
// key: r2; value: d2; thread: main
// key: foo; value: bar; thread: ForkJoinPool.commonPool-worker-1
// key: han; value: solo; thread: ForkJoinPool.commonPool-worker-2
// key: c3; value: p0; thread: main
```

## search

`search()`æ–¹æ³•æ¥å—`BiFunction`å¹¶ä¸ºå½“å‰çš„é”®å€¼å¯¹è¿”å›ä¸€ä¸ªéç©ºçš„æœç´¢ç»“æœï¼Œæˆ–è€…åœ¨å½“å‰è¿­ä»£ä¸åŒ¹é…ä»»ä½•æœç´¢æ¡ä»¶æ—¶è¿”å›`null`ã€‚åªè¦è¿”å›äº†éç©ºçš„ç»“æœï¼Œå°±ä¸ä¼šå¾€ä¸‹æœç´¢äº†ã€‚è¦è®°ä½`ConcurrentHashMap`æ˜¯æ— åºçš„ã€‚æœç´¢å‡½æ•°åº”è¯¥ä¸ä¾èµ–äºæ˜ å°„å®é™…çš„å¤„ç†é¡ºåºã€‚å¦‚æœæ˜ å°„çš„å¤šä¸ªå…ƒç´ éƒ½æ»¡è¶³æŒ‡å®šæœç´¢å‡½æ•°ï¼Œç»“æœæ˜¯éç¡®å®šçš„ã€‚

```java
String result = map.search(1, (key, value) -> {
    System.out.println(Thread.currentThread().getName());
    if ("foo".equals(key)) {
        return value;
    }
    return null;
});
System.out.println("Result: " + result);
// ForkJoinPool.commonPool-worker-2
// main
// ForkJoinPool.commonPool-worker-3
// Result: bar
```

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ï¼Œä»…ä»…æœç´¢æ˜ å°„ä¸­çš„å€¼ï¼š

```java
String result = map.searchValues(1, value -> {
    System.out.println(Thread.currentThread().getName());
    if (value.length() > 3) {
        return value;
    }
    return null;
});
System.out.println("Result: " + result);
// ForkJoinPool.commonPool-worker-2
// main
// main
// ForkJoinPool.commonPool-worker-1
// Result: solo
```

## reduce

`reduce()`æ–¹æ³•æ¥å—ä¸¤ä¸ª`BiFunction`ç±»å‹çš„lambdaè¡¨è¾¾å¼ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°å°†æ¯ä¸ªé”®å€¼å¯¹è½¬æ¢ä¸ºä»»æ„ç±»å‹çš„å•ä¸€å€¼ã€‚ç¬¬äºŒä¸ªå‡½æ•°å°†æ‰€æœ‰è¿™äº›è½¬æ¢åçš„å€¼ç»„åˆä¸ºå•ä¸€ç»“æœï¼Œå¹¶å¿½ç•¥æ‰€æœ‰å¯èƒ½çš„`null`å€¼ã€‚

```java
String result = map.reduce(1,
    (key, value) -> {
        System.out.println("Transform: " + Thread.currentThread().getName());
        return key + "=" + value;
    },
    (s1, s2) -> {
        System.out.println("Reduce: " + Thread.currentThread().getName());
        return s1 + ", " + s2;
    });
System.out.println("Result: " + result);
// Transform: ForkJoinPool.commonPool-worker-2
// Transform: main
// Transform: ForkJoinPool.commonPool-worker-3
// Reduce: ForkJoinPool.commonPool-worker-3
// Transform: main
// Reduce: main
// Reduce: main
// Result: r2=d2, c3=p0, han=solo, foo=bar
```



# Reference

[Java 8 Concurrency Tutorial: Synchronization and Locks ](http://link.zhihu.com/?target=http%3A//winterbe.com/posts/2015/04/30/java8-concurrency-tutorial-synchronized-locks-examples/) *è¯‘è€…ï¼š[é£é¾™](http://link.zhihu.com/?target=https%3A//github.com/wizardforcel)* 

[Java7/8 ä¸­çš„ HashMap å’Œ ConcurrentHashMap å…¨è§£æ](http://www.importnew.com/28263.html)

