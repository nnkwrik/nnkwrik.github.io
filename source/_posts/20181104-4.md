---
title: å¹¶å‘æ“ä½œåˆé›†-11.ThreadLocal
typora-copy-images-to: 20181104-4
date: 2018-11-04 19:35:50
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
---

> ğŸ¤ [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— ç›®å½•]()
>
> ğŸ• [å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

# ThreadLocalçš„ç”¨æ³•

ThreadLocalç”¨äºä¿å­˜æŸä¸ªçº¿ç¨‹å…±äº«å˜é‡ï¼šå¯¹äºåŒä¸€ä¸ªstatic ThreadLocalï¼Œä¸åŒçº¿ç¨‹åªèƒ½ä»ä¸­getï¼Œsetï¼Œremoveè‡ªå·±çš„å˜é‡ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„å˜é‡ã€‚

- ThreadLocal.get: è·å–ThreadLocalä¸­å½“å‰çº¿ç¨‹å…±äº«å˜é‡çš„å€¼ã€‚

- ThreadLocal.set: è®¾ç½®ThreadLocalä¸­å½“å‰çº¿ç¨‹å…±äº«å˜é‡çš„å€¼ã€‚

- ThreadLocal.remove: ç§»é™¤ThreadLocalä¸­å½“å‰çº¿ç¨‹å…±äº«å˜é‡çš„å€¼ã€‚

- ThreadLocal.initialValue: ThreadLocalæ²¡æœ‰è¢«å½“å‰çº¿ç¨‹èµ‹å€¼æ—¶æˆ–å½“å‰çº¿ç¨‹åˆšè°ƒç”¨removeæ–¹æ³•åè°ƒç”¨getæ–¹æ³•ï¼Œè¿”å›æ­¤æ–¹æ³•å€¼ã€‚

ç¤ºä¾‹ä»£ç ï¼š

```java
private static final ThreadLocal<String> threadLocal = new ThreadLocal<>();

public static void main(String[] args) throws InterruptedException {
    Runnable task1 = () -> {
        threadLocal.set(Instant.now().toString());
        try {
            TimeUnit.SECONDS.sleep(3);
            System.out.println(Thread.currentThread().getName() + " ==> " + threadLocal.get());
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    };
    ExecutorService executorService = Executors.newFixedThreadPool(10);

    for (int i = 0; i < 5; i++) {
        executorService.submit(task1);
        TimeUnit.SECONDS.sleep(1);
    }
}
-----------------------------------
è¾“å‡º
pool-1-thread-1 ==> 2018-11-04T11:17:14.388Z
pool-1-thread-2 ==> 2018-11-04T11:17:15.387Z
pool-1-thread-3 ==> 2018-11-04T11:17:16.388Z
pool-1-thread-4 ==> 2018-11-04T11:17:17.388Z
pool-1-thread-5 ==> 2018-11-04T11:17:18.388Z
```

å¯è§æ¯ä¸ªçº¿ç¨‹ä»ThreadLocalä¸­å–å‡ºçš„å€¼ï¼Œéƒ½æ˜¯è‡ªèº«æ”¾å…¥çš„å€¼ã€‚

# ThreadLocalçš„å®ç°åŸç†

ä¸ºäº†åŠ æ·±ç†è§£ï¼Œç®€å•çœ‹çœ‹ThreadLocalçš„å®ç°åŸç†ã€‚

set()çš„æºç æ˜¯è¿™æ ·å­çš„ï¼š

```java
public void set(T value) {
	//1. è·å–å½“å‰çº¿ç¨‹å®ä¾‹å¯¹è±¡
    Thread t = Thread.currentThread();
	//2. é€šè¿‡å½“å‰çº¿ç¨‹å®ä¾‹è·å–åˆ°ThreadLocalMapå¯¹è±¡
    ThreadLocalMap map = getMap(t);
    if (map != null)
		//3. å¦‚æœMapä¸ä¸ºnull,åˆ™ä»¥å½“å‰threadLoclå®ä¾‹ä¸ºkey,å€¼ä¸ºvalueè¿›è¡Œå­˜å…¥
        map.set(this, value);
    else
		//4.mapä¸ºnull,åˆ™æ–°å»ºThreadLocalMapå¹¶å­˜å…¥value
        createMap(t, value);
}
```

é€šè¿‡æºç æˆ‘ä»¬çŸ¥é“valueæ˜¯å­˜æ”¾åœ¨äº†ThreadLocalMapé‡Œäº†ã€‚è¿™ä¸ªThreadLocalMapæ˜¯ä»å“ªé‡Œå–å‡ºæ¥çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æºç ä¸­çš„getMap(t)æ–¹æ³•ï¼š

```java
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}
```

ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªThreadLocalMapæ˜¯æˆ‘ä»¬å½“å‰Threadä¸­çš„ä¸€ä¸ªå«threadLocalsçš„æˆå‘˜å˜é‡ï¼ŒThreadLocalMapæ˜¯ç”±å½“å‰çº¿ç¨‹è‡ªèº«æŒæœ‰çš„ã€‚

å½“è¿™ä¸ªmapä¸ºnullæ—¶ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹è¿˜æ²¡åˆ›å»ºè¿‡ThreadLocalMapï¼Œæ‰€ä»¥é€šè¿‡createMap(t,value)åˆ›å»ºThreadLocalMapå¹¶æ”¾å…¥çº¿ç¨‹ä¸­ã€‚

å¯¹setæ–¹æ³•è¿›è¡Œæ€»ç»“ä¸€ä¸‹ï¼š é€šè¿‡å½“å‰çº¿ç¨‹å¯¹è±¡threadè·å–è¯¥threadæ‰€ç»´æŠ¤çš„threadLocalMap,è‹¥threadLocalMapä¸ä¸ºnull,åˆ™ä»¥threadLocalå®ä¾‹ä¸ºkey,å€¼ä¸ºvalueçš„é”®å€¼å¯¹å­˜å…¥threadLocalMap,è‹¥threadLocalMapä¸ºnullçš„è¯ï¼Œå°±æ–°å»ºthreadLocalMapç„¶ååœ¨ä»¥threadLocalä¸ºé”®ï¼Œå€¼ä¸ºvalueçš„é”®å€¼å¯¹å­˜å…¥å³å¯ã€‚

getï¼ˆï¼‰æ–¹æ³•å’Œremoveï¼ˆï¼‰å®é™…ä¸Šä¹Ÿéƒ½æ˜¯è°ƒç”¨äº†è¿™ä¸ªå½“å‰Threadä¸­ç»´æŠ¤çš„threadLocalMapã€‚è¿™é‡Œå°±ä¸å¤šåšè§£é‡Šäº†ã€‚

# ThreadLocalçš„ä½¿ç”¨åœºæ™¯

**ThreadLocal ä¸æ˜¯ç”¨æ¥è§£å†³å…±äº«å¯¹è±¡çš„å¤šçº¿ç¨‹è®¿é—®é—®é¢˜çš„**ï¼Œæ•°æ®å®è´¨ä¸Šæ˜¯æ”¾åœ¨æ¯ä¸ªthreadå®ä¾‹å¼•ç”¨çš„threadLocalMap,ä¹Ÿå°±æ˜¯è¯´**æ¯ä¸ªä¸åŒçš„çº¿ç¨‹éƒ½æ‹¥æœ‰ä¸“å±äºè‡ªå·±çš„æ•°æ®å®¹å™¨ï¼ˆthreadLocalMapï¼‰ï¼Œå½¼æ­¤ä¸å½±å“**ã€‚å› æ­¤threadLocalåªé€‚ç”¨äº **å…±äº«å¯¹è±¡ä¼šé€ æˆçº¿ç¨‹å®‰å…¨** çš„ä¸šåŠ¡åœºæ™¯ã€‚æ¯”å¦‚**hibernateä¸­é€šè¿‡threadLocalç®¡ç†Session**å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¡ˆä¾‹ï¼Œä¸åŒçš„è¯·æ±‚çº¿ç¨‹ï¼ˆç”¨æˆ·ï¼‰æ‹¥æœ‰è‡ªå·±çš„session,è‹¥å°†sessionå…±äº«å‡ºå»è¢«å¤šçº¿ç¨‹è®¿é—®ï¼Œå¿…ç„¶ä¼šå¸¦æ¥çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

# Reference

[ThreadLocalç”¨æ³•è¯¦è§£å’ŒåŸç†](https://www.cnblogs.com/coshaho/p/5127135.html)

[å¹¶å‘å®¹å™¨ä¹‹ThreadLocal](https://github.com/CL0610/Java-concurrency/blob/master/17.%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BThreadLocal/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BThreadLocal.md)

