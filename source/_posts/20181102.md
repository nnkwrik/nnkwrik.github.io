---
title: å¹¶å‘æ“ä½œåˆé›†-5.åŸå­å˜é‡å’Œvolatile
typora-copy-images-to: 20181102
date: 2018-11-02 09:07:31
tags:
  - Java
  - å¹¶å‘
  - å¹¶å‘æ“ä½œåˆé›†
categories:
  - å¹¶å‘æ“ä½œåˆé›†
---

> [ğŸ• å¹¶å‘æ“ä½œåˆé›†ç³»åˆ— æºä»£ç ](https://github.com/nnkwrik/learn-java-concurrency)

æœ¬ç« ä¸»è¦è®²è§£åŸå­å˜é‡å’Œvolatileå…³é”®å­—çš„ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼ŒåŒ…æ‹¬Java8ä¸­æ–°åŠ å…¥çš„LongAdderå’ŒLongAccumulatorã€‚æƒ³è¦äº†è§£åŸå­å˜é‡å’Œvolatileå…³é”®å­—ï¼Œå°±å¿…é¡»å…ˆäº†è§£Javaå†…å­˜æ¨¡å‹ä¸­çš„`åŸå­æ€§`å’Œ`å¯è§æ€§`ã€‚

# å¯è§æ€§å’ŒåŸå­æ€§

## åŸå­æ€§

åœ¨Javaä¸­ï¼Œå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡çš„**è¯»å–å’Œèµ‹å€¼**æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼Œå³è¿™äº›æ“ä½œæ˜¯ä¸å¯è¢«ä¸­æ–­çš„ï¼Œè¦ä¹ˆæ‰§è¡Œï¼Œè¦ä¹ˆä¸æ‰§è¡Œã€‚

```java
x = 10;         //è¯­å¥1
y = x;         //è¯­å¥2
x++;           //è¯­å¥3
x = x + 1;     //è¯­å¥4
```

ä¸Šé¢çš„è¯­å¥ä¸­åªæœ‰è¯­å¥1æ˜¯å…·å¤‡åŸå­æ€§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å…¶ä»–ä¸‰ç§è¯­å¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå‡ºé”™ã€‚

æˆ‘ä»¬æƒ³è¦è®©å…¶ä»–çš„ä¸‰ç§è¯­å¥éƒ½å˜æˆåŸå­æ“ä½œè¯¥æ€ä¹ˆåšï¼Ÿè¿™æ—¶å¯ä»¥ç”¨åˆ°ä¹‹å‰ä»‹ç»çš„synchronizedå’Œé”ï¼Œè¿˜æœ‰ä¸‹é¢è¦ä»‹ç»åŸå­å˜é‡ã€‚

## å¯è§æ€§

å¯è§æ€§å°±æ˜¯å½“ä¸€ä¸ªå˜é‡è¢«ä¸€ä¸ªä¿®æ”¹æ—¶ï¼Œå®ƒçš„å€¼ä¼šåœ¨ä¸»å­˜ä¸­ç«‹å³åˆ·æ–°ï¼Œå› æ­¤å…¶ä»–çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šä¸»å­˜ä¸­çœ‹åˆ°å®ƒçš„æ–°å€¼ã€‚è€ŒJavaæ¨¡å‹æœ¬èº«æ˜¯ä¸ä¿è¯å¯è§æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„è¯­å¥1,2,3,4æœ¬èº«éƒ½ä¸å…·å¤‡å¯è§æ€§ã€‚

æˆ‘ä»¬æƒ³è¦è®©ä¸Šé¢4ç§è¯­å¥éƒ½å…·æœ‰å¯è§æ€§è¯¥æ€ä¹ˆåšï¼ŸåŒæ ·å¯ä»¥ç”¨åˆ°ä¹‹å‰ä»‹ç»çš„synchronizedå’Œé”ï¼Œè¿˜æœ‰ä¸‹é¢è¦ä»‹ç»volatileå…³é”®å­—ã€‚

# åŸå­å˜é‡

## AtomicInteger

`java.concurrent.atomic`åŒ…åŒ…å«äº†è®¸å¤šå®ç”¨çš„ç±»ï¼Œç”¨äºæ‰§è¡ŒåŸå­æ“ä½œã€‚å¦‚æœä½ èƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ä¸­åŒæ—¶ä¸”å®‰å…¨åœ°æ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œè€Œä¸éœ€è¦`synchronized`å…³é”®å­—æˆ–é”ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå°±æ˜¯åŸå­çš„ã€‚

æœ¬è´¨ä¸Šï¼ŒåŸå­æ“ä½œä¸¥é‡ä¾èµ–äºæ¯”è¾ƒä¸äº¤æ¢ï¼ˆCASï¼‰ï¼Œå®ƒæ˜¯ç”±å¤šæ•°ç°ä»£CPUç›´æ¥æ”¯æŒçš„åŸå­æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤é€šå¸¸æ¯”åŒæ­¥å—è¦å¿«ã€‚æ‰€ä»¥åœ¨åªéœ€è¦å¹¶å‘ä¿®æ”¹å•ä¸ªå¯å˜å˜é‡çš„æƒ…å†µä¸‹ï¼Œæˆ‘å»ºè®®ä½ ä¼˜å…ˆä½¿ç”¨åŸå­ç±»ï¼Œè€Œä¸æ˜¯é”ã€‚

å¯¹äºå…¶å®ƒè¯­è¨€ï¼Œä¸€äº›è¯­è¨€çš„åŸå­æ“ä½œç”¨é”å®ç°ï¼Œè€Œä¸æ˜¯åŸå­æŒ‡ä»¤ã€‚

ç°åœ¨è®©æˆ‘ä»¬é€‰å–ä¸€ä¸ªåŸå­ç±»ï¼Œä¾‹å¦‚`AtomicInteger`ï¼š

```java
private static AtomicInteger atomicInt = new AtomicInteger(0);    
public static void testIncrement() throws InterruptedException {
        Runnable increment = () -> {

            IntStream.range(0,10000).forEach(i -> {
                atomicInt.incrementAndGet();
            });
        };
        new Thread(increment).start();
        new Thread(increment).start();
        TimeUnit.SECONDS.sleep(1);
        System.out.println(atomicInt.get());    //è¾“å‡º20000
    }
```

é€šè¿‡ä½¿ç”¨`AtomicInteger`ä»£æ›¿`Integer`ï¼Œæˆ‘ä»¬å°±èƒ½çº¿ç¨‹å®‰å…¨åœ°å¹¶å‘å¢åŠ æ•°å€¼ï¼Œè€Œä¸éœ€è¦åŒæ­¥è®¿é—®å˜é‡ã€‚`incrementAndGet()`æ–¹æ³•æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å®‰å…¨è°ƒç”¨å®ƒã€‚

å…¶ä»–JDK1.5ä¸­æä¾›çš„åŸå­æ“ä½œæ–¹æ³•è¿˜æœ‰ï¼š

```
public final int get()                  //è·å–å½“å‰çš„å€¼
public final int getAndSet(int newValue)//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼
public final int getAndIncrement()      //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢
public final int getAndDecrement()      //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡
public final int getAndAdd(int delta)   //è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼
```

ä»¥ä¸‹æ˜¯JDK1.8å¼€å§‹æ”¯æŒçš„åŸå­æ“ä½œã€‚`updateAndGet()`æ¥å—lambdaè¡¨è¾¾å¼ï¼Œä»¥ä¾¿åœ¨æ•´æ•°ä¸Šæ‰§è¡Œä»»æ„æ“ä½œï¼š

```java
private static AtomicInteger atomicInt = new AtomicInteger(0);    
public static void testUpdate() throws InterruptedException {
        atomicInt.set(0);
        Runnable update = () -> {
            IntStream.range(0, 1000).forEach(i -> {
                atomicInt.updateAndGet(n -> n + 2);
            });
        };
        new Thread(update).start();
        new Thread(update).start();
        TimeUnit.SECONDS.sleep(1);
        System.out.println(atomicInt.get());    //è¾“å‡º4000
    }
```

`accumulateAndGet()`æ–¹æ³•æ¥å—å¦ä¸€ç§ç±»å‹`IntBinaryOperator`çš„lambdaè¡¨è¾¾å¼ã€‚æˆ‘ä»¬åœ¨ä¸‹ä¸ªä¾‹å­ä¸­çš„æ“ä½œå’Œä¸Šä¸€ä¸ªä¾‹å­çš„`atomicInt.updateAndGet(n -> n + 2);`ç›¸åŒï¼š

```java
private static AtomicInteger atomicInt = new AtomicInteger(0);    
public static void testAccumulate() throws InterruptedException {
        atomicInt.set(0);
        Runnable accumulate = () -> {
            IntStream.range(0, 1000).forEach(i -> {
                // 2æ˜¯æƒ³è¦ç´¯è®¡è®¡ç®—çš„å€¼ ï¼Œ  (n, m) -> n + m è¡¨ç¤º å¯¹2å’Œç›®å‰çš„å€¼åšä»€ä¹ˆæ ·çš„æ“ä½œ
                //å½“ç„¶ä½ ä¹Ÿå¯ä»¥å†™æˆï¼š
                // atomicInt.accumulateAndGet(2, Integer::sum);
                atomicInt.accumulateAndGet(2, (n, m) -> n + m);
            });
        };
        new Thread(accumulate).start();
        new Thread(accumulate).start();
        TimeUnit.SECONDS.sleep(1);
        System.out.println(atomicInt.get());    //è¾“å‡º4000
    }
```

å…¶å®ƒå®ç”¨çš„åŸå­ç±»æœ‰`AtomicBoolean`ã€`AtomicLong` å’Œ `AtomicReference`ã€‚

## LongAdder

`LongAdder`æ˜¯`AtomicLong`çš„æ›¿ä»£ï¼Œç”¨äºå‘æŸä¸ªæ•°å€¼è¿ç»­æ·»åŠ å€¼ã€‚longå€¼çš„åŸå­è®¡ç®—æœ‰äº›ç‰¹æ®Šï¼ŒJVMä¼šæŠŠ64ä½çš„longå€¼å‰ååˆ†æˆä¸¤ä¸ª32ä½æ¥åˆ†åˆ«è¿›è¡Œæ“ä½œï¼Œå¯¼è‡´å‰32ä½æ˜¯æ–°å€¼ï¼Œè€Œå32ä½ä»æ˜¯æ—§å€¼ã€‚åŸæ¥çš„`AtomicLong`ä¹Ÿèƒ½å®ŒæˆåŸå­æ“ä½œï¼Œä½†`LongAdder`æ€§èƒ½æ›´é«˜ã€‚

```java
private static LongAdder adder = new LongAdder();    
public static void testIncrement() throws InterruptedException {

        Runnable increment = () -> {

            IntStream.range(0, 10000).forEach(i -> {
                adder.add(1);
//                adder.increment();
            });
        };
        new Thread(increment).start();
        new Thread(increment).start();
        TimeUnit.SECONDS.sleep(1);
        System.out.println(adder.sumThenReset());    //è¾“å‡º20000,å¹¶å½’é›¶
    }
```

`LongAdder`æä¾›äº†`add()`å’Œ`increment()`æ–¹æ³•ï¼Œå°±åƒåŸå­æ•°å€¼ç±»ä¸€æ ·ï¼ŒåŒæ ·æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯è¿™ä¸ªç±»åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ç³»åˆ—å˜é‡æ¥å‡å°‘çº¿ç¨‹ä¹‹é—´çš„äº‰ç”¨ï¼Œè€Œä¸æ˜¯æ±‚å’Œè®¡ç®—å•ä¸€ç»“æœã€‚å®é™…çš„ç»“æœå¯ä»¥é€šè¿‡è°ƒç”¨`sum()`æˆ–`sumThenReset()`æ¥è·å–ã€‚

å½“å¤šçº¿ç¨‹çš„æ›´æ–°æ¯”è¯»å–æ›´é¢‘ç¹æ—¶ï¼Œè¿™ä¸ªç±»é€šå¸¸æ¯”åŸå­æ•°å€¼ç±»æ€§èƒ½æ›´å¥½ã€‚è¿™ç§æƒ…å†µåœ¨æŠ“å–ç»Ÿè®¡æ•°æ®æ—¶ç»å¸¸å‡ºç°ï¼Œä¾‹å¦‚ï¼Œä½ å¸Œæœ›ç»Ÿè®¡WebæœåŠ¡å™¨ä¸Šè¯·æ±‚çš„æ•°é‡ã€‚`LongAdder`ç¼ºç‚¹æ˜¯è¾ƒé«˜çš„å†…å­˜å¼€é”€ï¼Œå› ä¸ºå®ƒåœ¨å†…å­˜ä¸­å‚¨å­˜äº†ä¸€ç³»åˆ—å˜é‡ã€‚

## LongAccumulator

`LongAccumulator`æ˜¯`LongAdder`çš„æ›´é€šç”¨çš„ç‰ˆæœ¬ã€‚`LongAccumulator`ä»¥ç±»å‹ä¸º`LongBinaryOperator`lambdaè¡¨è¾¾å¼æ„å»ºï¼Œè€Œä¸æ˜¯ä»…ä»…æ‰§è¡ŒåŠ æ³•æ“ä½œï¼Œåƒè¿™æ®µä»£ç å±•ç¤ºçš„é‚£æ ·ï¼š

```java
    private static void testAccumulate() throws InterruptedException {
        LongBinaryOperator op = (x, y) -> 2 * x + y;
        LongAccumulator accumulator = new LongAccumulator(op,1L);

        Runnable accumulate = () -> {
            IntStream.range(0,10).forEach(i -> accumulator.accumulate(i));
        };
        new Thread(accumulate).start();
        new Thread(accumulate).start();
        TimeUnit.SECONDS.sleep(2);

        System.out.println(accumulator.get());  //è¾“å‡º2086901
    }
```

æˆ‘ä»¬ä½¿ç”¨å‡½æ•°`2 * x + y`åˆ›å»ºäº†`LongAccumulator`ï¼Œåˆå§‹å€¼ä¸º1ã€‚æ¯æ¬¡è°ƒç”¨`accumulate(i)`çš„æ—¶å€™ï¼Œå½“å‰ç»“æœå’Œå€¼`i`éƒ½ä¼šä½œä¸ºå‚æ•°ä¼ å…¥lambdaè¡¨è¾¾å¼ã€‚

`LongAccumulator`å°±åƒ`LongAdder`é‚£æ ·ï¼Œåœ¨å†…éƒ¨ç»´æŠ¤ä¸€ç³»åˆ—å˜é‡æ¥å‡å°‘çº¿ç¨‹ä¹‹é—´çš„äº‰ç”¨ã€‚

# volatileå…³é”®å­—

å¯¹å˜é‡ä½¿ç”¨volatileå…³é”®å­—èƒ½è®©å®ƒå…·å¤‡å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å®ƒçš„å€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½èƒ½åŠæ—¶åœ¨ä¸»å­˜ä¸­çœ‹åˆ°å®ƒçš„æ–°å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»–æ˜¯ä¸å…·å¤‡åŸå­æ€§çš„ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­

```java
public class BadIncrementDemo {

    public static volatile int cnt = 0;

    public static void main(String[] args) throws InterruptedException {
        Runnable increment = () -> {
            IntStream.range(0, 10).forEach(i -> {
                cnt++;
                System.out.println(Thread.currentThread().getName());
            });
        };

        //å¯åŠ¨100ä¸ª æ‰§è¡Œ10æ¬¡cnt++çš„çº¿ç¨‹
        IntStream.range(0, 100).forEach(i -> {
            new Thread(increment).start();
        });


        TimeUnit.SECONDS.sleep(1);
        System.out.println(cnt);    //å¯èƒ½è¾“å‡º998
    }
}
```

ä¸Šé¢çš„ä»£ç æŒ‰ç†è®²åº”è¾“å‡º1000ï¼Œè€Œæˆ‘çš„å¾—åˆ°çš„æ—¶998ã€‚å¯è§å°±ç®—ä¿è¯å¯è§æ€§ä¸å…·å¤‡åŸå­æ€§ï¼Œä»ä¼šå‘ç”Ÿé”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºå½“å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸»å­˜ä¸­çš„å€¼ç¡®å®ä¼šç«‹å³åˆ·æ–°ï¼Œä½†æ—¶å¯èƒ½å„ä¸ªçº¿ç¨‹çš„**å·¥ä½œå†…å­˜**ä¸­çš„å€¼ä»æ˜¯æ—§å€¼ã€‚

## volatileçš„ä½¿ç”¨åœºæ™¯

é‚£ä¹ˆåˆ°åº•è¯¥ä»€ä¹ˆæ—¶å€™ä½¿ç”¨volatileå…³é”®å­—ã€‚å®é™…ä¸Švolatileçš„ä½¿ç”¨åœºæ™¯å¾ˆå°‘ï¼Œå¦‚æœè¦ç”¨å¿…é¡»å…·å¤‡ä¸€ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š

- å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–äºå½“å‰å€¼
- è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­

ä¹Ÿå°±æ˜¯è¯´ï¼Œvolatileå˜é‡åº”è¯¥ç‹¬ç«‹äºä»»ä½•ç¨‹åºçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å˜é‡çš„å½“å‰çŠ¶æ€ã€‚

ä¸‹é¢æ˜¯volatileçš„å¸¸ç”¨æ–¹å¼

### çŠ¶æ€æ ‡è®°é‡

```java
volatile boolean flag = false;
..
while(!flag) {
   wait();
}
doSomething();
```

### åŒé‡é”

```java
public class Singleton {
    private volatile static Singleton instance = null;

    private Singleton() {}

    public static Singleton getInstance() {
        if (instance == null) {
            synchronized (Singleton.class) {
                if (instance == null) {
                    instance = new Singleton();
                }
            }
        }
        return instance;
    }
}
```

# Reference

[è·Ÿä¸Šjava8 concurrent](https://github.com/biezhi/learn-java8/blob/master/java8-concurrent/README.md)

[Java 8 å¹¶å‘æ•™ç¨‹ï¼šåŸå­å˜é‡å’Œ ConcurrentMap](https://zhuanlan.zhihu.com/p/33267165)

[Javaå¹¶å‘ç¼–ç¨‹ï¼švolatileå…³é”®å­—è§£æ](https://www.cnblogs.com/dolphin0520/p/3920373.html)