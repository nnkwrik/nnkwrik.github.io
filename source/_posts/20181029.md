---
title: Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬5ç« -åŸºç¡€æ„å»ºæ¨¡å—
tags:
  - Java
  - å¹¶å‘
  - ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹
categories:
  - è¯»ä¹¦ç¬”è®°
typora-copy-images-to: Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬5ç« -åŸºç¡€æ„å»ºæ¨¡å—
date: 2018-10-29 21:28:34
---



æœ¬ç« ä¸­è®²ä»‹ç»åœ¨Java5å’Œ6ä¸­å¼•å…¥çš„ä¸€äº›æ„å»ºå¹¶å‘æ¨¡å—ï¼Œä»¥åŠå¦‚ä½•ç”¨è¿™äº›æ¨¡å—æ¥è¿›è¡Œå¼€å‘ã€‚

# åŒæ­¥å®¹å™¨ç±»

åŒæ­¥å®¹å™¨ç±»åŒ…æ‹¬`Vector`å’Œ`Hashtable`ã€è¿™äº›ç±»å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ˜¯ï¼šå°†å®ƒä»¬çš„çŠ¶æ€å°è£…èµ·æ¥ï¼Œå¹¶å¯¹æ¯ä¸ªå…¬æœ‰æ–¹æ³•éƒ½è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®å®¹å™¨çš„çŠ¶æ€ã€‚

## åŒæ­¥å®¹å™¨ç±»çš„é—®é¢˜

å¸¸è§çš„å¤åˆæ“ä½œåŒ…æ‹¬ï¼š

- è¿­ä»£ï¼ˆåå¤è®¿é—®å…ƒç´ ï¼ŒçŸ¥é“éå†å®¹å™¨ä¸­æ‰€æœ‰å…ƒç´ ï¼‰
- è·³è½¬ï¼ˆæ ¹æ®æŒ‡å®šé¡ºåºæ‰¾åˆ°å½“å‰å…ƒç´ çš„ä¸‹ä¸ªå…ƒç´ ï¼‰
- æ¡ä»¶è¿ç®—ï¼šä¾‹å¦‚â€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ã€‚åœ¨åŒæ­¥å®¹å™¨ç±»ä¸­ï¼Œè¿™äº›å¤åˆæ“ä½œåœ¨æ²¡æœ‰å®¢æˆ·ç«¯åŠ é”çš„æƒ…å†µä¸‹ä»ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å½“å…¶ä»–çº¿ç¨‹å¹¶å‘åœ°ä¿®æ”¹å®¹å™¨æ—¶ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¡¨ç°å‡ºæ„æ–™ä¹‹å¤–çš„è¡Œä¸ºã€‚

:confused:

```java
//           5-1    Vectorä¸Šå¯èƒ½å¯¼è‡´æ··ä¹±ç»“æœçš„å¤åˆæ“ä½œ
public static Object getLast(Vector list) {
    int lastIndex = list.size() - 1;
    return list.get(lastIndex);
}
public static void deleteLast(Vector list) {
     int lastIndex = list.size() - 1;
     list.remove(lastIndex);
}
```

ä¸Šé¢æ˜¯Vectorä¸­å®šä¹‰çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬éƒ½ä¼šæ‰§è¡Œâ€œå…ˆæ£€æŸ¥å†è¿è¡Œâ€æ“ä½œï¼Œæ¯ä¸ªæ–¹æ³•é¦–å…ˆéƒ½è·å¾—æ•°ç»„çš„å¤§å°ï¼Œç„¶åé€šè¿‡ç»“æœæ¥è·å–æˆ–åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ ã€‚

å¦‚æœçº¿ç¨‹Aåœ¨åŒ…å«10ä¸ªå…ƒç´ çš„Vectorä¸Šè°ƒç”¨`removeLast`ï¼ŒåŒæ—¶çº¿ç¨‹Bè°ƒç”¨`getLast`ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œå¹¶æŠ›å‡º`ArrayIndexOutOfBoundsException`ã€‚

![è¿™é‡Œå†™å›¾ç‰‡æè¿°](20181029/20170804151008286.jpeg)

:blush: æŠŠä¸Šé¢çš„ç¨‹åºæ”¹æˆ`å®¢æˆ·ç«¯åŠ é”`ï¼Œé€šè¿‡listè‡ªèº«çš„é”æ¥ä¿æŠ¤ä»–ï¼Œä½¿`getLast`å’Œ`deleteLast`æˆä¸ºåŸå­æ“ä½œ

```java
//              5-2    åœ¨ä½¿ç”¨å®¢æˆ·ç«¯åŠ é”çš„Vectorä¸Šçš„å¤åˆæ“ä½œ
public static Object getLast(Vector list) {
        synchronized (list) {         //è·å¾—å®¹å™¨ç±»çš„é”ï¼Œä»å®¢æˆ·ç«¯å¾—åˆ°
        int lastIndex = list.size() - 1;
        return list.get(lastIndex);
}
}
public static void deleteLast(Vector list) {
        synchronized (list) {
        int lastIndex = list.size() - 1;
        list.remove(lastIndex);
}
}
```

ä¸‹é¢æ˜¯å¸¦æœ‰å®¢æˆ·ç«¯åŠ é”çš„è¿­ä»£çš„ä¾‹å­

```java
//        5-4    å¸¦æœ‰å®¢æˆ·ç«¯åŠ é”çš„è¿­ä»£
synchronized (vector) {
    for (int i = 0; i < vector.size(); i++)
        doSomething(vector.get(i));
}
```

## è¿­ä»£å™¨ä¸`ConcurrentModificationException`

ä¸ç®¡æ˜¯foreachè¿˜æ˜¯iteratorï¼Œè¿­ä»£å™¨æ²¡æœ‰è€ƒè™‘åˆ°å¹¶å‘ä¿®æ”¹çš„é—®é¢˜ï¼Œå®ƒä»¬è¡¨ç°å‡ºçš„è¡Œä¸ºæ˜¯**â€œåŠæ—¶å¤±è´¥ï¼ˆfail-fastï¼‰â€**ï¼Œè¿™æ„å‘³ç€å½“å®ƒä»¬å‘ç°å®¹å™¨åœ¨è¿­ä»£è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹æ—¶ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ª`Concurrentmodificationexception`ï¼ˆå¹¶å‘ä¿®æ”¹å¼‚å¸¸ï¼‰ã€‚ä»è€Œèµ·åˆ°ä¸€ä¸ªè­¦å‘Šçš„ä½œç”¨ã€‚

ä½†è®¸å¤šåœºåˆæˆ‘ä»¬éƒ½ä¸å¸Œæœ›åƒ5-4é‚£æ ·é€šè¿‡ä¸Šé”æ¥ä¿æŠ¤è¿­ä»£ã€‚å› ä¸ºè¿­ä»£çš„æ—¶é—´å¯èƒ½ä¼šå¾ˆé•¿ï¼Œä¼šé™ä½æ•´ä½“çš„ååé‡ã€‚å¦‚æœä¸å¸Œæœ›åœ¨è¿­ä»£æœŸé—´å¯¹å®¹å™¨åŠ é”ï¼Œä¸€ç§æ›¿ä»£æ–¹æ³•å°±æ˜¯**â€œå…‹éš†â€å®¹å™¨ï¼Œå¹¶åœ¨å‰¯æœ¬ä¸Šè¿›è¡Œè¿­ä»£ã€‚** 

## éšè—è¿­ä»£å™¨

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿­ä»£å™¨ä¼šéšè—èµ·æ¥ã€‚å¦‚ä¸‹é¢çš„ç¨‹åºæ‰€ç¤º

:anguished:

```java
//       5-6   éšè—åœ¨å­—ç¬¦ä¸²è¿æ¥ä¸­çš„è¿­ä»£æ“ä½œï¼ˆä¸è¦è¿™ä¹ˆåšï¼‰
public class HiddenIterator {
    @GuardedBy("this") private final Set<Integer> set = new HashSet<Integer>();

    public synchronized void add(Integer i) {
        set.add(i);
    }

    public synchronized void remove(Integer i) {
        set.remove(i);
    }

    public void addTenThings() {
        Random r = new Random();
        for (int i = 0; i < 10; i++)
            add(r.nextInt());
        System.out.println("DEBUG: added ten elements to " + set);//æ‰§è¡Œéšè—çš„è¿­ä»£æ“ä½œ
    }
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé‚£ä¸ªéƒ¨åˆ†å­˜åœ¨éšè—è¿­ä»£å‘¢ï¼Ÿ`"DEBUG: added ten elements to " + set`çš„å­—ç¬¦ä¸²æ‹¼æ¥å°±æ˜¯éšè—è¿­ä»£ã€‚ç¼–è¯‘å™¨å°†å­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œè½¬æ¢ä¸ºè°ƒç”¨`StringBuilder.appendï¼ˆObjectï¼‰`ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨å®¹å™¨çš„`toString`æ–¹æ³•ï¼Œæ ‡å‡†å®¹å™¨çš„`toString`æ–¹æ³•å°†è¿­ä»£å®¹å™¨ï¼Œå¹¶åœ¨æ¯ä¸ªå…ƒç´ ä¸Šè°ƒç”¨`toString`æ¥ç”Ÿæˆå®¹å™¨å†…å®¹çš„æ ¼å¼åŒ–è¡¨ç¤ºã€‚

ä¹‹æ‰€ä»¥è¯´æ˜¯ä¸å®‰å…¨çš„ï¼Œæ˜¯ç”±äºåœ¨è°ƒç”¨`toString`çš„é€”ä¸­ï¼Œlistå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°`ConcurrentModificationException`çš„å¼‚å¸¸äº†ã€‚æ‰€æœ‰æœ‰å¿…è¦åœ¨`System.out.println()`æ—¶ç”¨é”ä¿æŠ¤ã€‚æ­¤å¤–ï¼Œå®¹å™¨ç±»çš„`hashCode`å’Œ`equals`ï¼Œä»¥åŠ`containsAll`ï¼Œ`removeAll`å’Œ`retainAll`ç­‰æ–¹æ³•ï¼Œä»¥åŠæŠŠå®¹å™¨ä½œä¸ºå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œéƒ½ä¼šå¯¹å®¹å™¨è¿›è¡Œè¿­ä»£ã€‚

# å¹¶å‘å®¹å™¨

Java5.0æä¾›äº†å¤šç§å¹¶å‘å®¹å™¨æ¥æ”¹è¿›åŒæ­¥å®¹å™¨çš„æ€§èƒ½ã€‚

ä¹‹å‰çš„`åŒæ­¥å®¹å™¨`æ˜¯å°†æ‰€æœ‰çš„å®¹å™¨çŠ¶æ€çš„è®¿é—®éƒ½ä¸²è¡ŒåŒ–ï¼ˆå„ä¸ªä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œå®Œæˆä¸€ä¸ªä¹‹åæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªï¼‰ï¼Œä»¥å®ç°å®ƒä»¬çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚è¿™ç§æ–¹æ³•çš„ä»£ä»·æ˜¯ä¸¥é‡é™ä½å¹¶å‘æ€§ï¼Œå½“å¤šä¸ªçº¿ç¨‹ç«äº‰å®¹å™¨çš„é”æ—¶ï¼Œååé‡å°†ä¸¥é‡å‡ä½ã€‚

ç›¸æ¯”ä¹‹ä¸‹`å¹¶å‘å®¹å™¨`æ˜¯é’ˆå¯¹å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®è®¾è®¡çš„ã€‚Java5.0ä¸­æ–°å¢çš„æœ‰

- `ConcurrentHashMap`ï¼Œä»£æ›¿`HashTable`ï¼Œ`synchronizedMap`ã€‚

- `CopyOnWriteArrayList`ï¼Œç”¨åœ¨éå†æ“ä½œä¸ºä¸»è¦æ“ä½œçš„æƒ…å†µä¸‹ä»£æ›¿`Vector`ï¼Œ`synchronizedList`ã€‚

- `Queue` : ä¹Ÿå°±æ˜¯FIFOå®¹å™¨ï¼Œé€šå¸¸ç”¨`LinkedList`å®ç°ã€‚å®ƒå¦å¤–æä¾›äº†å‡ ç§å®ç°ï¼ŒåŒ…æ‹¬ ï¼š

  - `ConcurrentLinkedQueue` : ä¼ ç»Ÿçš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ— 
  - `PriorityQueue` ï¼šä¸€ä¸ªï¼ˆéå¹¶å‘ï¼‰ä¼˜å…ˆé˜Ÿåˆ— 

- `BlockingQueue`: `Queue`çš„æ‰©å±•ã€‚å¢åŠ äº†å¯é˜»å¡çš„æ’å…¥å’Œè·å–ç­‰æ“ä½œã€‚

  å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆè·å–å…ƒç´ çš„æ“ä½œå°†ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­å‡ºç°ä¸€ä¸ªå¯ç”¨çš„å…ƒç´ ã€‚ 
  å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼ˆå¯¹äºæœ‰ç•Œé˜Ÿåˆ—ï¼‰ï¼Œæ’å…¥å…ƒç´ æ“ä½œå°†é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­å‡ºç°å¯ç”¨çš„ç©ºé—´ã€‚ 
  åœ¨â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€è¿™ç§è®¾è®¡æ¨¡å¼ä¸­ï¼Œé˜»å¡é˜Ÿåˆ—æ˜¯ååˆ†æœ‰ç”¨çš„ã€‚

## ConcurrentHashMap

`HashMap`æ˜¯åŸºäºæ•£åˆ—çš„é“¾è¡¨ã€‚å½“æˆ‘ä»¬ä½¿ç”¨`HashMap.get`æˆ–`set`æ—¶ï¼Œä¼šé€šè¿‡æ•£åˆ—å€¼ç‰¹å®šä¸€ä¸ªé“¾è¡¨ï¼Œå¹¶åœ¨è¯¥é“¾è¡¨çš„è®¸å¤šå…ƒç´ ä¸Šè°ƒç”¨`equals`ã€‚å½“æ•£åˆ—å€¼çš„åˆ†å¸ƒä¸å‡åŒ€æ—¶ï¼Œè¿™ç§éå†è°ƒç”¨`euqals`å¼€é”€æ˜¯å¾ˆå¤§çš„ã€‚å¦‚æœæ˜¯åŒæ­¥å®¹å™¨çš„`HashTable`ï¼Œè¿™æ®µæ—¶é—´å†…è€Œå…¶ä»–çº¿ç¨‹åœ¨æœŸé—´ä¸èƒ½è®¿é—®è¯¥å®¹å™¨ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚

`ConcurrentHashMap`ä¹Ÿæ˜¯å‡ ä¸ªåŸºäºæ•£åˆ—çš„Mapï¼Œä½†å®ƒä½¿ç”¨äº†ä¸€ç§å®Œå…¨ä¸åŒçš„åŠ é”ç­–ç•¥æ¥æä¾›æ›´é«˜çš„å¹¶å‘æ€§å’Œä¼¸ç¼©æ€§ã€‚è¿™ç§æœºåˆ¶è¢«ç§°ä¸º`åˆ†æ®µé”`ï¼Œä¸€ç§ç²’åº¦æ›´ç»†ï¼ˆfiner-grainedï¼‰çš„åŠ é”æœºåˆ¶ã€‚åœ¨è¿™ç§æœºåˆ¶ä¸­ï¼Œä»»æ„æ•°é‡çš„çº¿ç¨‹å¯ä»¥å¹¶å‘åœ°è®¿é—®Mapï¼Œæ‰§è¡Œè¯»å–æ“ä½œçš„çº¿ç¨‹å’Œæ‰§è¡Œå†™å…¥æ“ä½œçš„çº¿ç¨‹å¯ä»¥å¹¶å‘åœ°è®¿é—®Mapï¼Œå¹¶ä¸”ä¸€å®šæ•°é‡çš„å†™å…¥çº¿ç¨‹å¯ä»¥å¹¶å‘åœ°ä¿®æ”¹Mapã€‚ å› æ­¤å¹¶å‘è®¿é—®ç¯å¢ƒä¸‹å°†å®ç°æ›´é«˜çš„ååé‡ã€‚

å¦å¤–ï¼Œ`ConcurrentHashMap`ç­‰å¹¶å‘å®¹å™¨æä¾›çš„è¿­ä»£å™¨ä¸ä¼šæŠ›å‡º`ConcurrentModificationException`ï¼Œå› æ­¤ä¸éœ€è¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å®¹å™¨åŠ é”ã€‚å®ç°åŸç†æ˜¯ï¼Œè®©è¿”å›çš„è¿­ä»£å™¨å…·æœ‰`å¼±ä¸€è‡´æ€§`ï¼Œè€Œé`åŠæ—¶å¤±è´¥`ã€‚å¼±ä¸€è‡´æ€§çš„è¿­ä»£å™¨å¯ä»¥å®¹å¿å¹¶å‘çš„ä¿®æ”¹ï¼Œå½“åˆ›å»ºè¿­ä»£å™¨æ—¶ä¼šéå†å·²æœ‰é¢å…ƒç´ ï¼Œå¹¶å¯ä»¥ï¼ˆä½†ä¸ä¿è¯ï¼‰åœ¨è¿­ä»£å™¨è¢«æ„é€ åå°†ä¿®æ”¹æ“ä½œåæ˜ ç»™å®¹å™¨ã€‚

è€ƒè™‘åˆ°å¹¶å‘ç¯å¢ƒä¸‹çš„ä½¿ç”¨ï¼Œ`ConcurrentHashMap`ä¸­çš„`size`ï¼Œ`isEmpty`è¿”å›çš„å¹¶ä¸æ˜¯ç²¾ç¡®å€¼ï¼Œåªæ˜¯ä¸€ä¸ªä¼°å€¼ã€‚å› ä¸ºè¿™ä¸ªå€¼åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¾ˆå¯èƒ½å·²ç»æ˜¯è¿‡æœŸçš„ã€‚ä½†ä¹Ÿå› æ­¤æå‡äº†å…¶ä»–æ“ä½œçš„æ€§èƒ½ï¼ŒåŒ…æ‹¬`get`ï¼Œ`put`ï¼Œ`containKey`å’Œ`remove`ç­‰ã€‚

åœ¨`ConcurrentHashMap`ä¸­æ²¡æœ‰å®ç°å¯¹MapåŠ é”ä»¥æä¾›ç‹¬å è®¿é—®ã€‚

## é¢å¤–çš„åŸå­Mapæ“ä½œ

ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†`Vector`çš„â€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ï¼Œè€Œ `ConcurrentHashMap`æœ¬èº«å°±æä¾›äº†â€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ï¼Œâ€œè‹¥ç›¸ç­‰åˆ™ç§»é™¤â€ï¼Œâ€œè‹¥ç›¸ç­‰åˆ™æ›¿æ¢â€ç­‰ï¼Œèƒ½åŸå­æ“ä½œçš„æ¥å£ï¼š

```java
//       5-7    ConcurrentMapæ¥å£
public interface ConcurrentMap<K,V> extends Map<K,V> {
      // ä»…å½“Kæ²¡æœ‰ç›¸åº”çš„æ˜ å°„å€¼æ—¶æ‰æ’å…¥
      V putIfAbsent(K key, V value);

     // ä»…å½“Kè¢«æ˜ å°„åˆ°Væ—¶æ‰ç§»é™¤
     boolean remove(K key, V value);

     // ä»…å½“Kè¢«æ˜ å°„åˆ°oldValueæ—¶æ‰æ›¿æ¢ä¸ºnewValue
     boolean replace(K key, V oldValue, V newValue);

    // ä»…å½“Kè¢«æ˜ å°„åˆ°æŸä¸ªå€¼æ—¶æ‰æ›¿æ¢ä¸ºnewValue
    V replace(K key, V newValue);
}
```

## CopyOnWriteArrayList

`CopyOnWriteArrayList`ç”¨äºæ›¿ä»£åŒæ­¥Listï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å®ƒæä¾›äº†æ›´å¥½çš„å¹¶å‘æ€§èƒ½ï¼Œå¹¶ä¸”åœ¨è¿­ä»£æœŸé—´ä¸éœ€è¦å¯¹å®¹å™¨è¿›è¡ŒåŠ é”æˆ–å¤åˆ¶ï¼ˆ`CopyOnWriteArraySet`çš„ä½œç”¨æ˜¯æ›¿ä»£åŒæ­¥`Set`ï¼‰ã€‚

**â€œå†™å…¥æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰â€**å®¹å™¨çš„çº¿ç¨‹å®‰å…¨æ€§åœ¨äºï¼Œåªè¦æ­£ç¡®å‘å¸ƒä¸€ä¸ª**äº‹å®ä¸å¯å˜**çš„å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨è®¿é—®è¯¥å¯¹è±¡æ—¶å°±ä¸å†éœ€è¦è¿›ä¸€æ­¥çš„åŒæ­¥ã€‚ ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œå°±æ˜¯ä»–åœ¨æ¯æ¬¡ä¿®æ”¹æ—¶ï¼Œä¼šåˆ›å»ºå¹¶é‡æ–°å‘å¸ƒä¸€ä¸ª**æ–°çš„å®¹å™¨å‰¯æœ¬**ï¼Œä»è€Œå®ç°å¯å˜æ€§ã€‚ â€œå†™å…¥æ—¶å¤åˆ»â€å®¹å™¨çš„è¿­ä»£å™¨ä¿ç•™ä¸€ä¸ªæŒ‡å‘åº•å±‚åŸºç¡€æ•°ç»„çš„å¼•ç”¨ï¼Œè¿™ä¸ªæ•°ç»„å½“å‰ä½äºè¿­ä»£å™¨çš„èµ·å§‹ä½ç½®ï¼Œç”±äºå®ƒä¸ä¼šè¢«ä¿®æ”¹ï¼Œå› æ­¤åªéœ€ç¡®ä¿æ•°ç»„å†…å®¹çš„å¯è§æ€§ã€‚

æ‰€ä»¥ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿™ä¸ªå®¹å™¨è¿›è¡Œè¿­ä»£ï¼Œè€Œä¸ä¼šå½¼æ­¤å¹²æ‰°æˆ–ä¸ä¿®æ”¹å®¹å™¨çš„çº¿ç¨‹äº’ç›¸å¹²æ‰°ã€‚ä¹Ÿå› æ­¤ä¸ä¼šæŠ›å‡º`ConcurrentModificationException`ã€‚

è¿™ä¹ˆåšçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯å½“ä¿®æ”¹å®¹å™¨æ—¶éƒ½ä¼šå¤åˆ¶åº•å±‚æ•°ç»„ï¼Œè¿™éœ€è¦ä¸€å®šå¼€é”€ï¼Œç‰¹åˆ«æ˜¯å®¹å™¨è§„æ¨¡è¾ƒå¤§æ—¶ã€‚ä»…å½“è¿­ä»£æ“ä½œè¿œè¿œå¤šäºä¿®æ”¹æ“ä½œæ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨â€œå†™å…¥æ—¶å¤åˆ¶â€å®¹å™¨ã€‚

# é˜»å¡é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

é˜»å¡é˜Ÿåˆ—æä¾›äº†å¯é˜»å¡çš„`put`å’Œ`take`æ–¹æ³•ï¼Œä»¥åŠæ”¯æŒå®šæ—¶çš„`offer`å’Œ`poll`æ–¹æ³•ã€‚å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œ`put`æ–¹æ³•å°†é˜»å¡ç›´åˆ°ç©ºé—´å¯ç”¨ï¼›å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆ`take`æ–¹æ³•å°†ä¼šé˜»å¡ç›´åˆ°æœ‰å…ƒç´ å¯ç”¨ã€‚é˜Ÿåˆ—å¯ä»¥æœ‰ç•Œä¹Ÿå¯ä»¥æ— ç•Œï¼Œæ— ç•Œé˜Ÿåˆ—putæ°¸è¿œä¸ä¼šé˜»å¡ã€‚é˜»å¡é˜Ÿåˆ—è¿˜æä¾›äº†ä¸€ä¸ªofferæ–¹æ³•ï¼Œå¦‚æœæ•°æ®é¡¹ä¸èƒ½è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆå°†è¿”å›ä¸€ä¸ªå¤±è´¥çŠ¶æ€ã€‚

`BlockingQueue`ä¸­æ”¯æŒä»»æ„æ•°é‡çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå¸¸è§çš„ä½¿ç”¨æ–¹æ³•æ˜¯çº¿ç¨‹æ± ä¸å·¥ä½œé˜Ÿåˆ—çš„ç»„åˆã€‚

åœ¨ç±»åº“ä¸­è¿˜åŒ…å«äº†BlockingQueueçš„å¤šç§å®ç°ï¼Œå…¶ä¸­ï¼š 

- `LinkedBlockingQueue` ï¼šã€€FIFOã€‚ä¸LinkedListç±»ä¼¼
- `ArrayBlockingQueue`ï¼šFIFOã€‚ä¸ArrayListç±»ä¼¼

- `PriorityBlockingQueue` ï¼š ä¸€ä¸ªæŒ‰ä¼˜å…ˆçº§æ’åºçš„é˜Ÿåˆ—ã€‚æƒ³æŒ‰ç…§æŸç§é¡ºåºè€Œä¸æ˜¯FIFOæ¥å¤„ç†å…ƒç´ æ—¶ä½¿ç”¨ã€‚
- `SynchronousQueue` ï¼š ç‰¹æ®Šï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œå› ä¸ºå®ƒä¸ä¼šä¸ºé˜Ÿåˆ—ä¸­å…ƒç´ ç»´æŠ¤å­˜å‚¨ç©ºé—´ã€‚å®ƒç»´æŠ¤çš„æ˜¯ä¸€ç»„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åœ¨ç­‰å¾…ç€æŠŠå…ƒç´ åŠ å…¥æˆ–ç§»å‡ºé˜Ÿåˆ—ã€‚ 
  å¦‚æœä»¥æ´—ç›˜å­ä¸ºæ¯”å–»ï¼Œå°±ç›¸å½“äºæ²¡æœ‰ç›˜æ¶æ¥æš‚æ—¶å­˜æ”¾æ´—å¥½çš„ç›˜å­ï¼Œè€Œæ˜¯å°†æ´—å¥½çš„ç›˜å­ç›´æ¥æ”¾å…¥ä¸‹ä¸€ä¸ªç©ºé—²çš„çƒ˜å¹²æœºä¸­ã€‚è¿™ç§å®ç°é˜Ÿåˆ—ç”±äºå¯ä»¥**ç›´æ¥äº¤ä»˜**å·¥ä½œï¼Œä»è€Œé™ä½äº†å°†æ•°æ®ä»ç”Ÿäº§è€…ç§»åŠ¨åˆ°æ¶ˆè´¹è€…çš„å»¶è¿Ÿã€‚
  å› ä¸º`SynchronousQueue`æ²¡æœ‰å­˜å‚¨åŠŸèƒ½ï¼Œå› æ­¤putå’Œtakeä¼šä¸€ç›´é˜»å¡ï¼ŒçŸ¥é“æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»å‡†å¤‡å¥½å‚ä¸åˆ°äº¤ä»˜è¿‡ç¨‹ä¸­ã€‚ä»…å½“æœ‰è¶³å¤Ÿçš„æ¶ˆè´¹è€…ï¼Œå¹¶ä¸”æ€»æ˜¯æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å‡†å¤‡å¥½è·å–äº¤ä»˜çš„å·¥ä½œæ—¶ï¼Œæ‰é€‚åˆä½¿ç”¨åŒæ­¥é˜Ÿåˆ—ã€‚

## ç¤ºä¾‹ï¼šæ¡Œé¢æœç´¢

ä¸‹é¢æ¥çœ‹ä¸€ä¸ªç”¨`BlockingQueue`å®ç°çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„ç¤ºä¾‹ã€‚å‡å¦‚æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œæ‰«ææœ¬åœ°é©±åŠ¨ä¸Šçš„æ–‡ä»¶å¹¶å»ºç«‹ç´¢å¼•ä»¥ä¾¿éšåè¿›è¡Œæœç´¢ã€‚

ä¸‹é¢çš„FileCrawlerä¸­ç»™å‡ºäº†ä¸€ä¸ªç”Ÿäº§è€…ä»»åŠ¡ï¼Œå³åœ¨æŸä¸ªæ–‡ä»¶å±‚æ¬¡ç»“æ„ä¸­æœç´¢ç¬¦åˆç´¢å¼•æ ‡å‡†çš„æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬çš„åç§°æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ã€‚ å…¶ä¸­çš„crawlæ‰«ææ–‡ä»¶å¹¶å°†ç¬¦åˆfileFilteræ¡ä»¶çš„æ–‡ä»¶æ”¾å…¥æ•°ç»„ä¸­ã€‚

```java
// 5-8 æ¡Œé¢æœç´¢åº”ç”¨ç¨‹åºä¸­çš„ç”Ÿäº§è€…ä»»åŠ¡
public class FileCrawler implements Runnable{
//mplement Runnableæ˜¯é¢å‘æ¥å£ï¼Œæ‰©å±•æ€§ç­‰æ–¹é¢æ¯”extends Threadå¥½ï¼Œå› ä¸ºjavaåªèƒ½å•ç»§æ‰¿ï¼Œè€Œå¯ä»¥å®ç°å¤šæ¥å£
    private final BlockingQueue<File> fileQueue; //çœå»åˆå§‹åŒ–è¿‡ç¨‹
    private final FileFilter fileFilter;
    private final File root;
    //... 
    @Override
    public void run() {        //é‡å†™runæ–¹æ³•
        try{
            crawl(root);      
        }catch (InterruptedException e) { //å¦‚æœé˜Ÿåˆ—æ»¡åˆ™é˜»å¡
          // æ¢å¤è¢«ä¸­æ–­çš„çŠ¶æ€ï¼Œç»ˆç»“è¢«é˜»å¡çŠ¶æ€ã€‚ 
            Thread.currentThread().interrupt(); 
        }

    }
    private void crawl(File root) throws InterruptedException{
        File[] entries=root.listFiles(fileFilter);  //åˆ—å‡ºç¬¦åˆè¿‡æ»¤å™¨çš„æ–‡ä»¶åˆ—è¡¨
        if(entries!=null){
            for(File entry:entries)
                if(entry.isDirectory())         //åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹ï¼Œæ˜¯åˆ™é€’å½’ç»§ç»­æ‰«æ
                    crawl(entry);
                else if (!alreadyIndexed(entry))    //åˆ¤æ–­æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­,è¿™æ–¹æ³•ç†è§£å°±å¥½ï¼Œè¿™é‡Œæ²¡åˆ—å‡º
                    fileQueue.put(entry);
        }
    }

}
```

Indexerä¸­è¿˜ç»™å‡ºäº†ä¸€ä¸ªæ¶ˆè´¹è€…ä»»åŠ¡ï¼Œå³ä»é˜Ÿåˆ—ä¸­å–å‡ºæ–‡ä»¶åå¹¶å¯¹å®ƒä»¬å»ºç«‹ç´¢å¼•ã€‚

```java
//       5-8      æ¡Œé¢æœç´¢åº”ç”¨ä¸­æ¶ˆè´¹è€…ä»»åŠ¡
public class Indexer implements Runnable{
        private final BlockingQueue<File> queue;   //é˜»å¡é˜Ÿåˆ—

        public Indexer(BlockingQueue<File> queue){   //è·å¾—é˜»å¡é˜Ÿåˆ—
            this.queue=queue; 
        }

        public void run(){              //é‡å†™runæ–¹æ³•
            try{
                while(true)            //ä¸€ç›´å¾ªç¯ï¼Œå–å‡ºæ–‡ä»¶åå¹¶å¯¹å®ƒä»¬å»ºç«‹ç´¢å¼•ï¼Œè¿™é‡Œçœå»å»ºç«‹ç´¢å¼•çš„å‡½æ•°
                   indexFile(queue.take());
            }catch(InterruptedException e){   //å¦‚æœqueueä¸ºç©ºåˆ™é˜»å¡
              // æ¢å¤è¢«ä¸­æ–­çš„çŠ¶æ€ï¼Œç»ˆç»“è¢«é˜»å¡çŠ¶æ€ã€‚ 
                Thread.currentThread().interrupt();
            }
        }
}
```

å®¢æˆ·ç«¯è°ƒç”¨

```java
//              5-9    å¯åŠ¨æ¡Œé¢æœç´¢
 public static void startIndexing(File[] roots){
     BlockingQueue<File> queue=new LinkedBlockingQueue<File>(BOUND); //æ–°å»ºä¸€ä¸ªå…±äº«çš„é˜Ÿåˆ—
     FileFilter filter=new FileFilter() {     //åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¿‡æ»¤å™¨        
         @Override
         public boolean accept(File pathname) {      
             return true;
         }
     }; 
     for(File root:roots)      //å¯åŠ¨å¤šä¸ªçˆ¬è™«ç¨‹åº
         new Thread(new FileCrawler(queue,filter,root)).start();
     for(int i=0;i<N_CONSUMERS;i++)  //å¯åŠ¨å¤šä¸ªç´¢å¼•å»ºç«‹ç¨‹åº
         new Thread(new Indexer(queue)).start();
 }
```

ä¸Šé¢çš„ä»£ç å¯åŠ¨äº†å¤šä¸ªçˆ¬è™«ç¨‹åºå’Œç´¢å¼•å»ºç«‹ç¨‹åºï¼Œæ¯ä¸ªç¨‹åºéƒ½åœ¨å„è‡ªçš„çº¿ç¨‹ä¸­è¿è¡Œã€‚ ä½†è¿™ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ°¸è¿œä¸ä¼šé€€å‡ºï¼Œå› è€Œç¨‹åºæ— æ³•åœæ­¢ï¼Œè¿™å°†åœ¨åé¢çš„è¯¾ç¨‹è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## ä¸²è¡Œçº¿ç¨‹å°é—­

ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼å°±æ˜¯é€šè¿‡é˜»å¡é˜Ÿåˆ—å®ç°çš„ä¸²è¡Œçº¿ç¨‹å°é—­ã€‚çº¿ç¨‹å°é—­å¯¹è±¡åªèƒ½ç”±å•ä¸ªçº¿ç¨‹æ‹¥æœ‰ï¼Œä½†å¯ä»¥é€šè¿‡å®‰å…¨åœ°å‘å¸ƒè¯¥å¯¹è±¡æ¥â€œè½¬ç§»â€æ‰€æœ‰æƒã€‚åœ¨è½¬ç§»æ‰€æœ‰æƒåï¼Œä¹Ÿåªæœ‰å¦ä¸€ä¸ªçº¿ç¨‹èƒ½è·å¾—è¿™ä¸ªå¯¹è±¡çš„è®¿é—®æƒé™ï¼Œå¹¶ä¸”å‘å¸ƒå¯¹è±¡çš„çº¿ç¨‹ä¸ä¼šå†è®¿é—®å®ƒã€‚

å¯¹è±¡æ± ä¹Ÿæ˜¯åˆ©ç”¨äº†ä¸²è¡Œçº¿ç¨‹å°é—­ï¼Œå°†å¯¹è±¡â€œç§Ÿå€Ÿâ€ç»™ä¸€ä¸ªè¯·æ±‚çº¿ç¨‹ã€‚å®‰å…¨åœ°å‘å¸ƒæ± ä¸­çš„å¯¹è±¡ï¼Œå¹¶ä¸”åªè¦å®¢æˆ·ä»£ç æœ¬èº«ä¸ä¼šå‘å¸ƒæ± ä¸­çš„å¯¹è±¡ï¼Œæˆ–è€…åœ¨å°†å¯¹è±¡è¿”å›ç»™å¯¹è±¡æ± åå°±ä¸å†ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆå°±å¯ä»¥å®‰å…¨åœ°åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’æ‰€æœ‰æƒã€‚

## åŒç«¯é˜Ÿåˆ—ä¸å·¥ä½œå¯†å–

Java6ä¸­æ–°å¢çš„ä¸¤ç§å®¹å™¨ç±»å‹`Deque`å’Œ`BlockingDeque`ï¼Œåˆ†åˆ«å¯¹`Queue`å’Œ`BlockingQueue`è¿›è¡Œäº†æ‰©å±•ã€‚`Deque`æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œå®ç°äº†åœ¨é˜Ÿåˆ—å¤´å’Œé˜Ÿåˆ—å°¾çš„é«˜æ•ˆæ’å…¥å’Œç§»é™¤ã€‚å…·ä½“å®ç°åŒ…æ‹¬`ArrayDeque`å’Œ`LinkedBlockingDeque`ã€‚

é˜»å¡é˜Ÿåˆ—é€‚ç”¨ä¸ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œè€ŒåŒç«¯é˜Ÿåˆ—é€‚ç”¨ä¸**å·¥ä½œå¯†å–**ã€‚ä»€ä¹ˆæ˜¯å·¥ä½œå¯†å–ï¼Ÿåœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…æœ‰ä¸€ä¸ª**å…±äº«çš„å·¥ä½œé˜Ÿåˆ—**ï¼Œè€Œåœ¨å·¥ä½œå¯†å–è®¾è®¡ä¸­ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰**å„è‡ªçš„åŒç«¯é˜Ÿåˆ—**ã€‚å¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…å®Œæˆäº†è‡ªå·±åŒç«¯é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨å·¥ä½œï¼Œé‚£ä¹ˆå®ƒå¯ä»¥ä»å…¶ä»–æ¶ˆè´¹è€…åŒç«¯é˜Ÿåˆ—æœ«å°¾ç§˜å¯†åœ°è·å–å·¥ä½œã€‚

å¯†å–å·¥ä½œæ¨¡å¼æ¯”ä¼ ç»Ÿçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼å…·æœ‰æ›´é«˜çš„å¯ä¼¸ç¼©æ€§ï¼Œè¿™æ˜¯å› ä¸ºå·¥ä½œè€…çº¿ç¨‹ä¸ä¼šåœ¨å•ä¸ªå…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ä¸Šå‘ç”Ÿç«äº‰ã€‚å› ä¸ºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä»¬éƒ½åªæ˜¯è®¿é—®è‡ªå·±çš„åŒç«¯é˜Ÿåˆ—ã€‚å½“å·¥ä½œè€…çº¿ç¨‹éœ€è¦è®¿é—®å¦ä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—çš„å°¾éƒ¨è€Œä¸æ˜¯å¤´éƒ¨è·å–å·¥ä½œï¼Œå› æ­¤è¿›ä¸€æ­¥é™ä½äº†é˜Ÿåˆ—ä¸Šçš„ç«äº‰ç¨‹åº¦ã€‚å¹¶ä¸”èƒ½ç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½å¤„äºå¿™ç¢ŒçŠ¶æ€ã€‚

# é˜»å¡æ–¹æ³•ä¸ä¸­æ–­æ–¹æ³•

çº¿ç¨‹å¯èƒ½ä¼šé˜»å¡æˆ–æš‚åœæ‰§è¡Œï¼ŒåŸå› æœ‰å¤šç§ï¼šç­‰å¾…I/Oæ“ä½œç»“æŸï¼Œç­‰å¾…è·å¾—ä¸€ä¸ªé”ï¼Œç­‰å¾…ä»Thread.sleepæ–¹æ³•ä¸­é†’æ¥ï¼Œæˆ–æ˜¯ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„è®¡ç®—ç»“æœã€‚

å½“çº¿ç¨‹é˜»å¡æ—¶ï¼Œå®ƒé€šå¸¸è¢«æŒ‚èµ·ï¼Œå¹¶å¤„äºæŸä¸ªé˜»å¡çŠ¶æ€ï¼ˆBLOCKED,WAITING,æˆ–TIMED_WAITINGï¼‰ã€‚è¢«é˜»å¡çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…æŸä¸ªä¸å—å®ƒæ§åˆ¶çš„äº‹ä»¶å‘ç”Ÿåæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œä¾‹å¦‚ç­‰åˆ°I/Oæ“ä½œï¼Œç­‰å¾…æŸä¸ªé”å˜æˆå¯ç”¨ï¼Œæˆ–è€…ç­‰å¾…å¤–éƒ¨è®¡ç®—çš„ç»“æŸã€‚å½“æŸä¸ªå¤–éƒ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œçº¿ç¨‹è¢«ç½®å›RUNNABLEçŠ¶æ€ï¼Œå¹¶å¯ä»¥å†æ¬¡è¢«è°ƒåº¦æ‰§è¡Œã€‚

`BlockingQueue`çš„`put`å’Œ`take`ç­‰æ–¹æ³•ä¼šæŠ›å‡ºå—æ£€æŸ¥å¼‚å¸¸`InterruptedException`ã€‚`InterruptedException`ä»£è¡¨ä»€ä¹ˆï¼Ÿå¦‚æœæŸä¸ªæ–¹æ³•ä¼šæŠ›å‡º`InterruptedException`ï¼Œå®ƒæ˜¯åœ¨å‘Šè¯‰ä½ ï¼Œå¦‚æœæ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå®ƒå°†å°è¯•åœæ­¢å®ƒæ­£åœ¨åšçš„äº‹æƒ…è€Œæå‰è¿”å›ï¼Œå¹¶é€šè¿‡æŠ›å‡º `InterruptedException` è¡¨æ˜å®ƒæå‰è¿”å›ã€‚

`Thread`æä¾›äº†`interrupt`æ–¹æ³•ï¼Œç”¨äºä¸­æ–­çº¿ç¨‹æˆ–è€…æŸ¥è¯¢çº¿ç¨‹æ˜¯å¦å·²ç»è¢«ä¸­æ–­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å±æ€§ï¼Œè¡¨ç¤ºçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå½“ä¸­æ–­çº¿ç¨‹æ—¶å°†è®¾ç½®è¿™ä¸ªæ ‡å¿—ã€‚ä»€ä¹ˆæ˜¯ä¸­æ–­ï¼Ÿä¸­æ–­å¹¶ä¸æ˜¯å¼ºåˆ¶å¦ä¸€ä¸ªçº¿ç¨‹åœä¸‹æ¥ï¼Œåªæ˜¯è¯·æ±‚å®ƒåœ¨é€‚å½“çš„åœ°æ–¹åœä¸‹æ¥ï¼Œå°±å¦‚linuxä¸­çš„`kill`æŒ‡ä»¤ï¼Œå’Œ`kill 9`ã€‚

å½“åƒ`BlockingQueue`çš„æ–¹æ³•æŠ›å‡ºäº†`InterruptedException`æ—¶ï¼Œä½ å°±å¿…é¡»å¯¹ä¸­æ–­åšå‡ºå“åº”ã€‚æ­¤æ—¶æœ‰ä¸¤ç§ç­–ç•¥ï¼š

- ä¼ é€’`InterruptedException`ã€‚
- æ¢å¤ä¸­æ–­ã€‚å½“ä»£ç æ˜¯`Runnable`çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œè‚¯å®šå°±ä¸èƒ½ç»§ç»­æŠ›å¼‚å¸¸äº†ã€‚å¿…é¡»æ•è·å®ƒï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨`interrupt`æ¥æ¢å¤ä¸­æ–­çŠ¶æ€ã€‚è¿™æ ·åœ¨è°ƒç”¨æ ˆä¸­æ›´é«˜å±‚çš„ä»£ç å°†çœ‹åˆ°å¼•å‘äº†ä¸€ä¸ªä¸­æ–­ã€‚

åœ¨å‡ºç°`InterruptedException`æ—¶ä¸åº”è¯¥æ•è·å®ƒå´ä¸åšå‡ºä»»ä½•å“åº”ã€‚è¿™å°†ä½¿è°ƒç”¨æ ˆä¸Šæ›´é«˜å±‚ä»£ç æ— æ³•å¯¹ä¸­æ–­é‡‡å–å¤„ç†æªæ–½ï¼Œå› ä¸ºçº¿ç¨‹è¢«ä¸­æ–­çš„è¯æ®å·²ç»ä¸¢å¤±ã€‚

# åŒæ­¥å·¥å…·ç±»

åŒæ­¥å·¥å…·ç±»å¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªå¯¹è±¡ï¼Œåªè¦å®ƒæ ¹æ®è‡ªèº«çš„çŠ¶æ€æ¥åè°ƒçº¿ç¨‹çš„æ§åˆ¶æµã€‚é˜»å¡é˜Ÿåˆ—å¯ä»¥ä½œä¸ºåŒæ­¥å·¥å…·ç±»ï¼Œå…¶ä»–ç±»å‹çš„åŒæ­¥å·¥å…·ç±»è¿˜åŒ…æ‹¬`ä¿¡å·é‡`ï¼Œ`æ …æ `ï¼Œä»¥åŠ`é—­é”`ã€‚

æ‰€æœ‰çš„åŒæ­¥å·¥å…·ç±»éƒ½åŒ…å«ä¸€äº›ç‰¹å®šçš„ç»“æ„åŒ–å±æ€§ï¼š

- ä¸€äº›çŠ¶æ€ï¼Œå†³å®šæ˜¯ç»§ç»­æ‰§è¡Œè¿˜æ˜¯ç­‰å¾…ã€‚
- å¯¹è¿™äº›çŠ¶æ€è¿›è¡Œæ“ä½œçš„æ–¹æ³•
- ç”¨äºé«˜æ•ˆåœ°ç­‰å¾…åŒæ­¥å·¥å…·ç±»è¿›å…¥åˆ°é¢„æœŸçŠ¶æ€çš„æ–¹æ³•

## é—­é”

é—­é”æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ç±»ï¼Œå¯ä»¥å»¶è¿Ÿçº¿ç¨‹çš„è¿›åº¦ç›´åˆ°å…¶è¾¾åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé—­é”çš„ä½œç”¨ç›¸å½“äºä¸€æ‰‡é—¨ï¼šåœ¨é—­é”åˆ°è¾¾ç»“æŸçŠ¶æ€ä¹‹å‰ï¼Œè¿™æ‰‡é—¨ä¸€ç›´æ˜¯å…³é—­çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•çº¿ç¨‹èƒ½é€šè¿‡ï¼Œå½“åˆ°è¾¾ç»“æŸçŠ¶æ€æ—¶ï¼Œè¿™æ‰‡é—¨ä¼šæ‰“å¼€å¹¶å…è®¸æ‰€æœ‰çš„çº¿ç¨‹é€šè¿‡ã€‚

é—­é”ç”¨æ¥ç¡®ä¿ä¸€äº›æ´»åŠ¨ç›´åˆ°å…¶ä»–æ´»åŠ¨éƒ½å®Œæˆåç»§ç»­æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š

- ç¡®ä¿æŸä¸ªè®¡ç®—åœ¨å…¶éœ€è¦çš„æ‰€æœ‰èµ„æºéƒ½è¢«åˆå§‹åŒ–ä¹‹åæ‰ç»§ç»­æ‰§è¡Œã€‚
- ç¡®ä¿æŸä¸ªæœåŠ¡åœ¨å…¶ä¾èµ–çš„æ‰€æœ‰å…¶ä»–æœåŠ¡éƒ½å·²ç»å¯åŠ¨ä¹‹åæ‰å¯åŠ¨ã€‚
- ç­‰åˆ°ç›´åˆ°æŸä¸ªæ“ä½œçš„æ‰€æœ‰å‚ä¸è€…ï¼ˆä¾‹å¦‚æ‰€æœ‰ç©å®¶ï¼‰éƒ½å°±ç»ªå†ç»§ç»­æ‰§è¡Œã€‚

`CountDownLatch`å¯ä»¥ç”¨äºä¸Šé¢çš„å„ç§æƒ…å†µã€‚å¯ä»¥ä½¿ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ä¸€ç»„äº‹ä»¶å‘ç”Ÿã€‚å…¶ä¸­åŒ…å«

- è®¡æ•°å™¨å±æ€§ã€‚è¯¥è®¡æ•°å™¨è¢«åˆå§‹åŒ–ä¸ºä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºéœ€è¦ç­‰å¾…çš„äº‹ä»¶æ•°é‡ã€‚ 
- `countDown`æ–¹æ³•ã€‚é€’å‡è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿäº†
- `await`æ–¹æ³•ã€‚ç­‰å¾…è®¡æ•°å™¨è¾¾åˆ°é›¶ï¼Œè¿™è¡¨ç¤ºæ‰€æœ‰éœ€è¦ç­‰å¾…çš„äº‹ä»¶éƒ½å·²ç»å‘ç”Ÿã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é—­é”çš„ä¸¤ç§å¸¸è§ç”¨æ³•ã€‚é€šè¿‡ä¸¤ä¸ªé—­é”æ¥æµ‹`nThreads`ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ã€‚

```java
//            5-11    åœ¨è®¡æ—¶æµ‹è¯•ä¸­ä½¿ç”¨CountDownLatchæ¥å¯åŠ¨å’Œåœæ­¢çº¿ç¨‹
public class TestHarness {
    public long timeTasks(int nThreads, final Runnable task)
            throws InterruptedException {
        //æœ‰ä¸¤ä¸ªé—­é”
        final CountDownLatch startGate = new CountDownLatch(1);    //startGateè®¡æ•°å™¨åˆå§‹å€¼ä¸º1     
        final CountDownLatch endGate = new CountDownLatch(nThreads); //endGateè®¡æ•°å™¨åˆå§‹å€¼ä¸ºå·¥ä½œçº¿ç¨‹çš„æ•°é‡

        for (int i = 0; i < nThreads; i++) {
            Thread t = new Thread() { //åˆ›å»ºä¸€å®šæ•°é‡çš„çº¿ç¨‹
                public void run() {
                    try {
                        startGate.await();//æ¯ä¸ªçº¿ç¨‹é¦–å…ˆè¦åšçš„å°±æ˜¯åœ¨å¯åŠ¨é—¨ä¸Šç­‰å¾…ï¼Œä»è€Œç¡®ä¿æ‰€æœ‰çº¿ç¨‹éƒ½å°±ç»ªåæ‰å¼€å§‹æ‰§è¡Œï¼Œç­‰å¾…startGateå€¼ä¸º0æ‰èƒ½æ‰§è¡Œï¼Œä¹‹å‰ä¸€ç›´é˜»å¡
                        try {
                            task.run();  //å…è®¸ä»»åŠ¡
                        } finally {
                            endGate.countDown(); //æ¯ä¸ªçº¿ç¨‹è¦åšçš„æœ€åä¸€ä»¶äº‹å°±æ˜¯è®²è°ƒç”¨ç»“æŸé—¨çš„countDownæ–¹æ³•å‡1ï¼Œè¿™èƒ½ä½¿ä¸»çº¿ç¨‹é«˜æ•ˆåœ°ç­‰åˆ°æ‰€æœ‰å·¥ä½œéƒ½æ‰§è¡Œå®Œæˆï¼Œå› æ­¤å¯ä»¥ç»Ÿè®¡æ‰€æ¶ˆè€—çš„æ—¶é—´
                        }
                    } catch (InterruptedException ignored) {
                    }
                }
            };
            t.start();
        }
        //è®¡ç®—æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´
        long start = System.nanoTime();
        startGate.countDown();  //countDownæ–¹æ³•é€’å‡è®¡æ•°å™¨ï¼Œåœ¨è¿™ä¸€æ¡ä¹‹åstartGateæ‰å˜ä¸º0ï¼Œæ­¤æ—¶æ‰€æœ‰çº¿ç¨‹æ‰å¼€å§‹è·‘
        // åœ¨è¿™ä¸€æ®µä¸€ç›´åœé¡¿ï¼Œç›´åˆ°å®Œæˆæ‰€æœ‰ï¼Œtask.run();
        endGate.await();      //ç­‰å¾…å·¥ä½œéƒ½æ‰§è¡Œå®Œï¼ŒendGateä¸º0æ‰èƒ½æ‰§è¡Œï¼Œä¹‹å‰ä¸€ç›´é˜»å¡
        long end = System.nanoTime();
        return end - start;
    }
}
```

åœ¨åŒä¸€æ—¶åˆ»å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œéšåè¿›è¡Œé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç»“æŸã€‚

## Future Task

`FutureTask`ä¹Ÿå¯ä»¥ç”¨ä½œé—­é”ï¼Œæœ¬èº«å°±æ˜¯å¼‚æ­¥æ‰§è¡Œã€‚`FutureTask`æ˜¯é€šè¿‡`Callable`æ¥å®ç°çš„ï¼Œç›¸å½“äºä¸€ç§å¯ç”Ÿæˆç»“æœçš„`Runnable`ã€‚`FutureTask`æ˜¯`Future`æ¥å£çš„ä¸€ä¸ªå”¯ä¸€å®ç°ç±»ã€‚

å¯ä»¥å¤„ç†ä»¥ä¸‹3ç§çŠ¶æ€ï¼š

- ç­‰å¾…çŠ¶æ€ï¼ˆWaiting to runï¼‰
- æ­£åœ¨è¿è¡Œ(Running)
- è¿è¡Œå®Œæˆ(Completed)

å½“`FutureTask`è¿›å…¥å®ŒæˆçŠ¶æ€åï¼Œå®ƒä¼šæ°¸è¿œåœæ­¢åœ¨â€œæ‰§è¡Œå®Œæˆâ€çš„çŠ¶æ€ä¸Šã€‚è¿™ä¸ªçŠ¶æ€æœ‰å¯èƒ½æ˜¯æ­£å¸¸ç»“æŸï¼Œç”±äºå–æ¶ˆè€Œç»“æŸå’Œç”±äºå¼‚å¸¸è€Œç»“æŸç­‰ã€‚

`Future.get`çš„è¡Œä¸ºå–å†³äºä»»åŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œé‚£ä¹ˆgetä¼šç«‹å³è¿”å›ç»“æœï¼Œå¦åˆ™getå°†é˜»å¡ç›´åˆ°ä»»åŠ¡è¿›å…¥å®ŒæˆçŠ¶æ€ï¼Œç„¶åè¿”å›ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚`FutrueTask`ä¼šå°†è®¡ç®—ç»“æœä»æ‰§è¡Œè®¡ç®—çš„çº¿ç¨‹ä¼ é€’åˆ°è·å–è¿™ä¸ªç»“æœçš„çº¿ç¨‹ã€‚

å¸¸ç”¨çš„æ–¹å¼æ˜¯åœ¨ä½¿ç”¨ç»“æœä¹‹å‰ï¼Œæå‰è¿›è¡Œè°ƒç”¨ï¼Œä»è€ŒåŠæ—¶æ‹¿åˆ°å¼‚æ­¥è°ƒç”¨è¿”å›çš„ç»“æœã€‚

```java
//        5-12   ä½¿ç”¨FutureTaskæ¥æå‰åŠ è½½ç¨åéœ€è¦çš„æ•°æ®
public class Preloader {
   //æ–°å»ºäº†ä¸€ä¸ªFutureTaskï¼Œå…¶ä¸­åŒ…å«ä»æ•°æ®åº“åŠ è½½äº§å“ä¿¡æ¯çš„ä»»åŠ¡ï¼Œä»¥åŠä¸€ä¸ªæ‰§è¡Œè¿ç®—çš„çº¿ç¨‹
    private final FutureTask<ProductInfo> future =
        new FutureTask<ProductInfo>(new Callable<ProductInfo>() {  //Callableè¡¨ç¤ºçš„ä»»åŠ¡å¯ä»¥æŠ›å‡ºå—æ£€æŸ¥æˆ–æœªå—æ£€æŸ¥çš„å¼‚å¸¸ï¼Œå¹¶ä¸”ä»»ä½•ä»£ç éƒ½å¯èƒ½æŠ›å‡ºä¸€ä¸ªError
            public ProductInfo call() throws DataLoadException {  //Callableå¯èƒ½æŠ›å‡ºå—æ£€æŸ¥å¼‚å¸¸
                return loadProductInfo();
            }
        });
    private final Thread thread = new Thread(future);  //åˆ›å»ºprivateï¼Œfinalçº¿ç¨‹

    public void start() { thread.start(); }//ç”±äºåœ¨æ„é€ å‡½æ•°æˆ–è€…é™æ€åˆå§‹åŒ–æ–¹æ³•ä¸­å¯åŠ¨çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç§å¥½æ–¹æ³•ï¼Œå› æ­¤æä¾›äº†startæ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹

    public ProductInfo get()                     
            throws DataLoadException, InterruptedException {   //å½“çº¿ç¨‹éœ€è¦ProductInfoæ—¶ï¼Œè°ƒç”¨getï¼Œå¦‚æœæ•°æ®å·²ç»åŠ è½½ï¼Œè¿”å›æ•°æ®ï¼Œå¦åˆ™å°†ç­‰å¾…åŠ è½½å®Œæˆåå†è¿”å›
        try {
            return future.get();
        } catch (ExecutionException e) { //å½“getæ–¹æ³•æŠ›å‡ºExecutionExceptionï¼ˆæ‰§è¡Œå¼‚å¸¸ï¼‰ï¼Œå¯èƒ½æ˜¯ä¸‹é¢ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼šCallableæŠ›å‡ºçš„å—æ£€æŸ¥å¼‚å¸¸ï¼ŒRuntimeExceptionä»¥åŠErrorã€‚
            Throwable cause = e.getCause();
            //getCauseæ¥è·å¾—è¢«å°è£…çš„åˆå§‹å¼‚å¸¸
            //åœ¨è°ƒç”¨LaunderThrowableä¹‹å‰ï¼ŒPreloaderä¼šé¦–å…ˆæ£€æŸ¥å·²çŸ¥çš„å—æ£€æŸ¥å¼‚å¸¸ï¼Œå¹¶é‡æ–°æŠ›å‡ºå®ƒä»¬ã€‚
            if (cause instanceof DataLoadException) 
                throw (DataLoadException) cause;
            else
                throw LaunderThrowable.launderThrowable(cause);
        }
    }
```

## ä¿¡å·é‡

`è®¡æ•°ä¿¡å·é‡ï¼ˆCounting Semaphoreï¼‰`æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®æŸä¸ªç‰¹å®šèµ„æºçš„æ“ä½œæ•°é‡ï¼Œæˆ–è€…åŒæ—¶æ‰§è¡ŒæŸä¸ªæ‰§è¡Œæ“ä½œçš„æ•°é‡ã€‚

Semaphoreä¸­ç®¡ç†ç€ä¸€ç»„è™šæ‹Ÿçš„è®¸å¯ï¼ˆ`permit`ï¼‰ï¼Œè®¸å¯çš„åˆå§‹æ•°é‡å¯é€šè¿‡æ„é€ å‡½æ•°æ¥æŒ‡å®šã€‚åœ¨æ‰§è¡Œæ“ä½œæ—¶å¯ä»¥é¦–å…ˆè·å¾—è®¸å¯ï¼ˆåªè¦è¿˜æœ‰å‰©ä½™çš„è®¸å¯ï¼‰ï¼Œå¹¶ä¸”ä½¿ç”¨ä»¥åé‡Šæ”¾è®¸å¯ã€‚å¦‚æœæ²¡æœ‰è®¸å¯ï¼Œé‚£ä¹ˆ`acquire`æ–¹æ³•å°†é˜»å¡ç›´åˆ°æœ‰è®¸å¯ï¼ˆæˆ–è€…ç›´åˆ°è¢«ä¸­æ–­æˆ–è¯·æ±‚è¶…æ—¶ï¼‰ã€‚`release`æ–¹æ³•å°†è¿”å›ä¸€ä¸ªè®¸å¯ç»™ä¿¡å·é‡ã€‚

Semaphoreå¯ä»¥ç”¨äºå®ç°èµ„æºæ± ï¼Œè·å–èµ„æºæ—¶ä½¿ç”¨`acquire`æ–¹æ³•è·å–`permit`ï¼Œä½¿ç”¨å®Œæ¯•åç”¨`release`é‡Šæ”¾`permit`ã€‚

å¦å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨Semaphoreå°†ä»»ä½•ä¸€ç§å®¹å™¨å˜æˆæœ‰ç•Œé˜»å¡å®¹å™¨ã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
//               5-14   ä½¿ç”¨Semaphoreä¸ºå®¹å™¨è®¾ç½®è¾¹ç•Œ
public class BoundedHashSet<T>{
       private final Set<T> set;
       private final Semaphore sem;
       public BoundedHashSet(int bound){
           this.set=Collections.synchronizedSet(new HashSet<T>());
           sem=new Semaphore(bound);  //åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œå¤§å°ä¸ºboundï¼Œä¿¡å·é‡çš„è®¡æ•°å€¼ä¼šåˆå§‹åŒ–ä¸ºå®¹å™¨å®¹é‡çš„æœ€å¤§å€¼
       }
       public boolean add(T o) throws InterruptedException{
           sem.acquire();       //è·å¾—è®¸å¯
           boolean wasAdded=false;
           try{                     //å› ä¸ºå·²ç»æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ‰€ä»¥ä¸ç”¨catchåšå¤„ç†
               wasAdded=set.add(o);
               return wasAdded;
           }
           finally{
               if(!wasAdded)
                   sem.release();       //å¦‚æœæ²¡æœ‰æ·»åŠ ä»»ä½•å…ƒç´ ï¼Œé‡Šæ”¾è®¸å¯
           }
       }
       public boolean remove(Object o){
           boolean wasRemoved=set.remove(o);
           if(wasRemoved){
               sem.release();   //é‡Šæ”¾ä¸€ä¸ªè®¸å¯ï¼Œä½¿æ›´å¤šå…ƒç´ èƒ½æ·»åŠ åˆ°å®¹å™¨ä¸­
           }
           return wasRemoved;
       }

}
```

## æ …æ 

ä¹‹å‰ä»‹ç»çš„é—­é”æ˜¯ä¸€æ¬¡æ€§å¯¹è±¡ï¼Œä¸€æ—¦è¿›å…¥ç»ˆæ­¢çŠ¶æ€ï¼Œå°±ä¸èƒ½è¢«é‡ç½®ã€‚

æ …æ ç±»ä¼¼äºé—­é”ï¼Œå®ƒèƒ½é˜»å¡ä¸€ç»„çº¿ç¨‹ç›´åˆ°æŸä¸ªäº‹ä»¶å‘ç”Ÿã€‚ æ …æ ä¸é—­é”çš„åŒºåˆ«åœ¨äºï¼Œæ‰€æœ‰çº¿ç¨‹å¿…é¡»åŒäº‹åˆ°è¾¾æ …æ ä½ç½®ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå¦å¤–ï¼Œé—­é”æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè€Œæ …æ å¯ä»¥åå¤ä½¿ç”¨ã€‚é—­é”ç”¨äºç­‰å¾…äº‹ä»¶ï¼Œè€Œæ …æ ç”¨äºç­‰å¾…å…¶ä»–çº¿ç¨‹ã€‚æ …æ ç”¨äºå®ç°ä¸€äº›åè®®ï¼Œä¾‹å¦‚å‡ ä¸ªå®¶åº­å†³å®šåœ¨æŸä¸ªåœ°æ–¹é›†åˆï¼šâ€œæ‰€æœ‰äºº6ï¼š00åœ¨éº¦å½“åŠ³ç¢°å¤´ï¼Œåˆ°äº†ä»¥åè¦ç­‰å…¶ä»–äººï¼Œä¹‹åå†è®¨è®ºä¸‹ä¸€æ­¥åšçš„äº‹æƒ…â€ã€‚

`CyclicBarrier`å¯ä»¥ä½¿ä¸€å®šæ•°é‡çš„å‚ä¸æ–¹åå¤åœ°åœ¨æ …æ ä½ç½®æ±‡é›†ï¼Œå®ƒåœ¨å¹¶è¡Œè¿­ä»£ç®—æ³•ä¸­éå¸¸æœ‰ç”¨ï¼šè¿™ç§ç®—æ³•é€šå¸¸å°†ä¸€ä¸ªé—®é¢˜æ‹†åˆ†æˆä¸€ç³»åˆ—ç›¸äº’ç‹¬ç«‹çš„å­é—®é¢˜ã€‚å½“çº¿ç¨‹åˆ°è¾¾æ …æ ä½ç½®æ—¶å°†è°ƒç”¨`await`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†é˜»å¡ç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾æ …æ ä½ç½®ã€‚å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾äº†æ …æ ä½ç½®ï¼Œé‚£ä¹ˆæ …æ å°†æ‰“å¼€ï¼Œæ­¤æ—¶æ‰€æœ‰çº¿ç¨‹éƒ½å°†é‡Šæ”¾ï¼Œè€Œæ …æ **å°†è¢«é‡ç½®**ã€ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚

- å¦‚æœå¯¹`await`çš„è°ƒç”¨è¶…æ—¶ï¼Œæˆ–è€…`await`é˜»å¡çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆæ …æ å°±è¢«è®¤ä¸ºæ˜¯æ‰“ç ´äº†ï¼Œæ‰€æœ‰é˜»å¡çš„`await`è°ƒç”¨éƒ½å°†ç»ˆæ­¢å¹¶æŠ›å‡º`BrokenBarrierException`ã€‚

- å¦‚æœæˆåŠŸåœ°é€šè¿‡æ …æ ï¼Œé‚£ä¹ˆ`await`å°†ä¸ºæ¯ä¸ªçº¿ç¨‹è¿”å›ä¸€ä¸ªå”¯ä¸€çš„è¾¾åˆ°ç´¢å¼•å·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™äº›ç´¢å¼•æ¥â€œé€‰ä¸¾â€äº§ç”Ÿä¸€ä¸ªé¢†å¯¼çº¿ç¨‹ï¼Œå¹¶åœ¨ä¸‹ä¸€æ¬¡è¿­ä»£ä¸­ç”±è¯¥é¢†å¯¼çº¿ç¨‹æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„å·¥ä½œã€‚ 

`CyclicBarrier`è¿˜å¯ä»¥ä½¿ä½ å°†ä¸€ä¸ªæ …æ æ“ä½œä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ª`Runnable`ï¼Œå½“æˆåŠŸé€šè¿‡æ …æ æ—¶ä¼šï¼ˆåœ¨ä¸€ä¸ªå­ä»»åŠ¡çº¿ç¨‹ä¸­ï¼‰æ‰§è¡Œå®ƒï¼Œä½†åœ¨é˜»å¡çº¿ç¨‹è¢«é‡Šæ”¾ä¹‹å‰æ˜¯ä¸èƒ½æ‰§è¡Œçš„ã€‚

ä¸‹é¢çš„ç¨‹åºä¸­é€šè¿‡æ …æ æ¥è®¡ç®—ç»†èƒçš„è‡ªåŠ¨åŒ–æ¨¡æ‹Ÿã€‚å°†é—®é¢˜åˆ†è§£æˆå¤šä¸ªå­é—®é¢˜ï¼Œä¸ºæ¯ä¸ªå­é—®é¢˜åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ±‚è§£ï¼Œä¹‹åå†å°†æ‰€æœ‰çš„ç»“æœåˆå¹¶èµ·æ¥ã€‚

```java
//     5-15 é€šè¿‡CyclicBarrieråè°ƒç»†èƒè‡ªåŠ¨è¡ç”Ÿç³»ç»Ÿä¸­çš„è®¡ç®—
public class CellularAutomata {
      private final Board mainBoard;
      private final CyclicBarrier barrier;
      private final Worker[] workers;

      public CellularAutomata(Board board){  
          this.mainBoard=board; 
          int count=Runtime.getRuntime().availableProcessors(); //è·å¾—å¯ç”¨çš„å¤„ç†å™¨ä¸ªæ•°
          //æœ‰countæ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶åœ¨çº¿ç¨‹å…¨éƒ¨åˆ°è¾¾æ …æ å¤„æ‰§è¡ŒRunnable
          this.barrier=new CyclicBarrier(count,new Runnable(){
              public void run(){
                  mainBoard.commitNewValues(); 
              }
          });
          this.workers=new Worker[count];
          //
          for(int i=0;i<count;i++)       //å°†é—®é¢˜åˆ†ä¸ºcountä¸ªå­é—®é¢˜
              workers[i]=new Worker(mainBoard.getSubBoard(count, i));
      }
      public class Worker implements Runnable{
          private final Board board;
          public Worker(Board board){
              this.board=board;
          }
          public void run(){         //å·¥ä½œçº¿ç¨‹ä¸ºå„è‡ªè‡ªé—®ä¸­çš„æ‰€æœ‰ç»†èƒè®¡ç®—æ–°å€¼
              while(!board.hasConverged()){  
                  for(int x =0;x<board.getMaxX();x++)
                      for(int y=0;y<board.getMaxY();y++)
                          board.setNewValue(x, y, computeValue(x,y));
                  try{
                      barrier.await();//ç­‰å¾…æ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½åˆ°è¾¾æ …æ å¤„
                  }catch (InterruptedException e) {
                    // TODO: handle exception
                      return ;
                }catch (BrokenBarrierException e) {
                    // TODO: handle exception
                    return ;
                }
              }
          }
          private int computeValue(int x, int y) {
              // è®¡ç®—åœ¨ (x,y)ä¸­çš„æ–°å€¼
              return 0;
          }
      }
      public void start(){
          for(int i=0;i<workers.length;i++)
              new Thread(workers[i]).start(); //ä¸ºæ¯ä¸ªå­é—®é¢˜åˆ†é…ä¸€ä¸ªçº¿ç¨‹
          mainBoard.waitForConvergence();//è¿›è¡Œä¸‹ä¸€æ­¥
      }
}
```

å¦ä¸€ç§å½¢å¼çš„æ …æ æ˜¯`Exchanger`ï¼Œå®ƒæ˜¯ä¸€ç§ä¸¤æ–¹ï¼ˆTwo-Partyï¼‰æ …æ ï¼Œå„æ–¹åœ¨æ …æ ä½ç½®ä¸Šäº¤æ¢æ•°æ®ã€‚å½“ä¸¤æ–¹æ‰§è¡Œä¸å¯¹ç§°çš„æ“ä½œæ—¶ï¼Œ`Exchanger`ä¼šéå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚å½“ä¸€ä¸ªçº¿ç¨‹å‘ç¼“å†²åŒºå†™å…¥æ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®ã€‚è¿™äº›çº¿ç¨‹å¯ä»¥ä½¿ç”¨`Exchanger`æ¥æ±‡åˆï¼Œå¹¶å°†æ»¡çš„ç¼“å†²åŒºä¸ç©ºçš„ç¼“å†²åŒºäº¤æ¢ã€‚å½“ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡Exchangeräº¤æ¢å¯¹è±¡æ—¶ï¼Œè¿™ç§äº¤æ¢å°±æŠŠè¿™ä¸¤ä¸ªå¯¹è±¡å®‰å…¨åœ°å‘å¸ƒç»™å¦ä¸€æ–¹ã€‚ğŸ¤”

ğŸ¤”æ•°æ®äº¤æ¢çš„æ—¶æœºå–å†³ä¸åº”ç”¨ç¨‹åºçš„å“åº”éœ€æ±‚ : 

- æœ€ç®€å•çš„æ–¹æ¡ˆ:å½“ç¼“å†²åŒºè¢«å¡«æ»¡æ—¶ï¼Œç”±å¡«å……ä»»åŠ¡è¿›è¡Œäº¤æ¢ ã€‚å½“ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œç”±æ¸…ç©ºä»»åŠ¡è¿›è¡Œäº¤æ¢ã€‚
  è¿™æ ·ä¼šæŠŠéœ€è¦äº¤æ¢çš„æ¬¡æ•°é™è‡³æœ€ä½ã€‚ä½†å¦‚æœæ–°æ•°æ®çš„åˆ°è¾¾ç‡ä¸å¯é¢„æµ‹ï¼Œé‚£ä¹ˆä¸€äº›æ•°æ®çš„å¤„ç†è¿‡ç¨‹å°±å°†å»¶è¿Ÿã€‚
- å¦ä¸€ä¸ªæ–¹æ³• : ä¸ä»…å½“ç¼“å†²è¢«å¡«æ»¡æ—¶è¿›è¡Œäº¤æ¢ï¼Œå¹¶ä¸”å½“ç¼“å†²è¢«å¡«å……åˆ°ä¸€å®šç¨‹åº¦å¹¶ä¿æŒä¸€å®šæ—¶é—´åï¼Œä¹Ÿè¿›è¡Œäº¤æ¢ã€‚

# æ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜

æœ¬èŠ‚æˆ‘ä»¬å°è¯•å¼€å‘ä¸€ä¸ªé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç¼“å­˜ï¼Œç”¨äºæ”¹è¿›ä¸€ä¸ªé«˜è®¡ç®—å¼€é”€çš„å‡½æ•°ã€‚æˆ‘ä»¬é¦–å…ˆä»ç®€å•çš„HashMapå¼€å§‹ï¼Œç„¶ååˆ†æå®ƒçš„å¹¶å‘æ€§ç¼ºé™·ï¼Œå¹¶è®¨è®ºå¦‚ä½•ä¿®å¤å®ƒä»¬ã€‚

:confused:ä½¿ç”¨HashMapå’ŒåŒæ­¥æœºåˆ¶

```java
//          5-16 ä½¿ç”¨HashMapå’ŒåŒæ­¥æœºåˆ¶æ¥åˆå§‹åŒ–ç¼“å†²ï¼ˆå¹¶ä¸å¥½ï¼Œéœ€æ”¹è¿›ï¼‰
public class Memoizer1<A,V> implements Computable<A,V>{
    private final Map<A,V> cache=new HashMap<A,V>();
    private final Computable<A,V> c;

    public Memoizer1(Computable<A,V> c){
        this.c=c;
    }

    public synchronized V compute(A arg) throws InterruptedException{
        V result=cache.get(arg);     //å¾—åˆ°ç¼“å­˜
        if(result==null){            //ç¼“å­˜ä¸ºç©ºï¼Œåˆ™ç¼“å­˜è®¡ç®—åçš„ç»“æœ
            result=c.compute(arg);
            cache.put(arg, result);
        }
        return result;      //è¿”å›ç»“æœ
    }

}

interface Computable<A,V>{         //è¾“å…¥ç±»å‹ä¸ºA,è¾“å‡ºç±»å‹ä¸ºV
    V compute(A rag) throws InterruptedException;
}

class ExpensiveFunction implements Computable<String,BigInteger>{
    public BigInteger compute(String arg){
        //åœ¨é•¿æ—¶é—´çš„è®¡ç®—å
        return new BigInteger(arg);
    }
}
```

åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªäº†Computableçš„åŒ…è£…å™¨ï¼Œä½¿ç”¨HashMapæ¥å¸®åŠ©è®°ä½ä¹‹å‰çš„è®¡ç®—ç»“æœï¼Œå¹¶å°†ç¼“å­˜è¿‡ç¨‹å°è£…èµ·æ¥ã€‚

ä½†è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæ¯”æ²¡æœ‰ç¼“å­˜æ“ä½œæ‰€èŠ±çš„æ—¶é—´è¿˜è¦é•¿ï¼Œå› ä¸ºè¿™ä¸ªç¼“å­˜ä¸ºäº†å®ç°çº¿ç¨‹å®‰å…¨ï¼ŒæŠŠç¼“å­˜æ“ä½œéƒ½ç”¨`synchronized`é”äº†èµ·æ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´é˜»å¡æ—¶é—´å¾ˆé•¿ã€‚

![20170805214957300](20181029/20170805214957300.jpg)



:confused: åˆ©ç”¨ConcurrentHashMapä»£æ›¿HashMapæ¥å¯¹ä¸Šé¢çš„ç¨‹åºè¿›è¡Œæ”¹è¿›

```java
//        5-17    ç”¨ConcurrentHashMapæ›¿æ¢HashMapï¼ˆè¿˜æ˜¯ä¸å¥½ï¼‰
public class Memoizer2<A,V> implements Computable<A, V>{
    private final Map<A,V> cache=new ConcurrentHashMap<A,V>();
    private final Computable<A, V> c;   //åˆ›å»ºæ¥å£å®ä¾‹
    public Memoizer2(Computable<A,V> c){
        this.c=c;
    }
    public V compute(A arg) throws InterruptedException{
        V result=cache.get(arg);
        if(result==null){
            result=c.compute(arg);
            result=cache.put(arg, result);
        }
        return result;
    }
}
```

ç”±äºä½¿ç”¨çš„æ˜¯ConcurrentHashMapï¼Œæ‰€ä»¥å°±ä¸éœ€è¦æ˜¾ç¤ºçš„è¿›è¡ŒåŒæ­¥ï¼Œæ€§èƒ½ä¹Ÿæ¯”ä¸Šé¢çš„ç¨‹åºæ›´é«˜ã€‚

ä½†æ˜¯ä»å­˜åœ¨æ¼æ´ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨computeæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´è®¡ç®—å¾—åˆ°ä¸¤ä¸ªç›¸åŒçš„å€¼ï¼ˆè€Œæˆ‘ä»¬åªéœ€è¦ç¼“å­˜ä¸€ä¸ªï¼‰ã€‚è¿™å°±ä¸æ»¡è¶³ç¼“å­˜çš„è®¾è®¡ç†å¿µäº†ã€‚ ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå› ä¸ºå¦‚æœæŸä¸ªçº¿ç¨‹å¯åŠ¨äº†ä¸€ä¸ªå¼€é”€å¾ˆå¤§çš„è®¡ç®—ï¼Œè€Œå…¶ä»–çº¿ç¨‹å¹¶ä¸çŸ¥é“è¿™ä¸ªè®¡ç®—æ­£åœ¨è®¡ç®—ï¼Œå°±ä¼šé‡å¤è¿™ä¸ªè®¡ç®—ã€‚

![20170806000721130](20181029/20170806000721130.jpg)

:confused: ç”¨`ConcurrentHashMap<A,Future<V>>` æ¥ä»£æ›¿åŸæ¥çš„`ConcurrentHashMap<A,V>`

```java
//     5-18   åŸºäºFutureTaskçš„Memoizingå°è£…å™¨ï¼ˆè¿˜ä¸å¤Ÿå¥½ï¼‰
public class Memoizer3 <A, V> implements Computable<A, V> {
    private final Map<A, Future<V>> cache
            = new ConcurrentHashMap<A, Future<V>>();
    private final Computable<A, V> c;

    public Memoizer3(Computable<A, V> c) {
        this.c = c;
    }

    public V compute(final A arg) throws InterruptedException { 
        Future<V> f = cache.get(arg);
        if (f == null) {
            Callable<V> eval = new Callable<V>() {
                public V call() throws InterruptedException {
                    return c.compute(arg);
                }
            };
            FutureTask<V> ft = new FutureTask<V>(eval);
            f = ft;
            cache.put(arg, ft);//æ³¨å†Œåˆ°Mapä¸­
            ft.run(); // è°ƒç”¨callå¯åŠ¨è®¡ç®—
        }
        try {
            return f.get();  //è‹¥ç»“æœå·²ç»è®¡ç®—å‡ºæ¥ï¼Œé‚£ä¹ˆå°†ç«‹åˆ»è¿”å›ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹æ­£åœ¨è®¡ç®—è¯¥ç»“æœï¼Œé‚£ä¹ˆä¿¡é“çš„çº¿ç¨‹å°†ä¸€ç›´ç­‰å¾…è¿™ä¸ªç»“æœè¢«è®¡ç®—å‡ºæ¥ã€‚
        } catch (ExecutionException e) {//å½“getæ–¹æ³•æŠ›å‡ºExecutionExceptionï¼ˆæ‰§è¡Œå¼‚å¸¸ï¼‰åŠErrorã€‚
            throw LaunderThrowable.launderThrowable(e.getCause());//e.getCasueè·å¾—è¢«å°è£…çš„åˆå§‹å¼‚å¸¸
        }
    }
}
```

ä¹‹å‰çš„ç¨‹åºä¸­éƒ½æ˜¯é¦–å…ˆåˆ¤æ–­è®¡ç®—æ˜¯å¦å·²å®Œæˆï¼Œè€Œä¸Šé¢çš„ç¨‹åºæ˜¯åˆ¤æ–­è®¡ç®—æ˜¯å¦å·²å¼€å§‹ã€‚è‹¥ç»“æœå·²ç»è®¡ç®—å‡ºæ¥ï¼Œé‚£ä¹ˆå°†ç«‹åˆ»è¿”å›ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹æ­£åœ¨è®¡ç®—è¯¥ç»“æœï¼Œé‚£ä¹ˆä¿¡é“çš„çº¿ç¨‹å°†ä¸€ç›´ç­‰å¾…è¿™ä¸ªç»“æœè¢«è®¡ç®—å‡ºæ¥ã€‚

ä½†ä»ç„¶å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹è®¡ç®—å‡ºç›¸åŒå€¼çš„æ¼æ´ï¼Œè¿™ä¸ªæ¦‚ç‡æ¯”Memoizer2è¦å°ã€‚åŸå› åœ¨äºconputeæ–¹æ³•ä¸­çš„ifä»£ç å—æ˜¯éåŸå­çš„çš„â€œå…ˆæ£€æŸ¥åœ¨æ‰§è¡Œâ€æ“ä½œï¼Œå› æ­¤ä»æœ‰å¯èƒ½åœ¨åŒä¸€æ—¶é—´è°ƒç”¨computeæ¥è®¡ç®—ç›¸åŒçš„å€¼ã€‚

![20170806004937014](20181029/20170806004937014.jpg)



:blush: æœ€ç»ˆå®ç°ã€‚ä½¿ç”¨ConcurrentMapä¸­çš„åŸå­æ–¹æ³•putIfAbsentï¼Œæ¥é¿å…Memoizer3çš„æ¼æ´ã€‚

```java
//          5-19       æœ€ç»ˆå®ç°
public class Memoizer <A, V> implements Computable<A, V> {//ç»§æ‰¿Computableï¼Œå…¶ä¸­æœ‰computeæ–¹æ³•
    private final ConcurrentMap<A, Future<V>> cache
            = new ConcurrentHashMap<A, Future<V>>();
    private final Computable<A, V> c;

    public Memoizer(Computable<A, V> c) {
        this.c = c;
    }

    public V compute(final A arg) throws InterruptedException {//å°½é‡å°†åŸŸå£°æ˜ä¸ºfinalç±»å‹ï¼Œé™¤ééœ€è¦å®ƒä»¬æ˜¯å¯å˜çš„ã€‚ä¸å¯å˜å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
        while (true) {      //ä¸€ç›´æ“ä½œç›´åˆ°è¢«åœæ­¢
            Future<V> f = cache.get(arg);
            if (f == null) {
                Callable<V> eval = new Callable<V>() {
                    public V call() throws InterruptedException {
                        return c.compute(arg);
                    }
                };
                FutureTask<V> ft = new FutureTask<V>(eval);
                //putIfAbsentæ“ä½œï¼šä»…å½“Kæ²¡æœ‰ç›¸åº”çš„æ˜ å°„å€¼æ—¶æ‰æ’å…¥ï¼Œabsentï¼ˆä¸åœ¨åœºçš„ï¼‰
                f = cache.putIfAbsent(arg, ft);//åº•å±‚çš„Mapä¸­çš„putæ˜¯å¤åˆæ“ä½œï¼ˆâ€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ï¼‰ï¼Œå±äºéåŸå­æ€§çš„â€œå…ˆæ£€æŸ¥å†æ‰§è¡Œâ€æ“ä½œ
                /*putIfAbsentç›¸å½“äº
                 * if (!map.containsKey(key))
                      return map.put(key, value);
                   else
                       return map.get(key);
                 */
                if (f == null) { //æ‰€ä»¥è¦å¯¹fè¿›è¡Œåˆ¤æ–­
                    f = ft;
                    ft.run();
                }
            }
            try {
                return f.get();//è‹¥ç»“æœå·²ç»è®¡ç®—å‡ºæ¥ï¼Œé‚£ä¹ˆå°†ç«‹åˆ»è¿”å›ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹æ­£åœ¨è®¡ç®—è¯¥ç»“æœï¼Œé‚£ä¹ˆä¿¡é“çš„çº¿ç¨‹å°†ä¸€ç›´ç­‰å¾…è¿™ä¸ªç»“æœè¢«è®¡ç®—å‡ºæ¥ã€‚
            } catch (CancellationException e) {
                cache.remove(arg, f);  //å¦‚æœå‘ç°è®¡ç®—è¢«å–æ¶ˆæˆ–å¤±è´¥ï¼Œå°†Futureä»ç¼“å­˜ä¸­ç§»å‡º
            } catch (ExecutionException e) {
            //getCauseæ¥è·å¾—è¢«å°è£…çš„åˆå§‹å¼‚å¸¸
                throw LaunderThrowable.launderThrowable(e.getCause());
            }
        }
    }
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“ç¼“å­˜çš„æ˜¯Futureè€Œä¸æ˜¯å€¼æ—¶ï¼Œå°†å¯¼è‡´ç¼“å­˜æ±¡æŸ“ï¼ˆCache Pollutionï¼‰é—®é¢˜ï¼šå¦‚æœæŸä¸ªè®¡ç®—è¢«å–æ¶ˆæˆ–å¤±è´¥ï¼Œé‚£ä¹ˆfutureåœ¨è®¡ç®—è¿™ä¸ªç»“æœæ—¶å°†æŒ‡æ˜è®¡ç®—è¿‡ç¨‹è¢«å–æ¶ˆæˆ–å¤±è´¥ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¦‚æœMemoizerå‘ç°è®¡ç®—è¢«å–æ¶ˆï¼Œé‚£ä¹ˆå°†Futureä»ç¼“å­˜ä¸­ç§»é™¤ã€‚å¦‚æœæ£€æŸ¥åˆ°`RuntimeException`ï¼Œä¹Ÿä¼šç§»é™¤Futureï¼Œè¿™æ ·å°†æ¥çš„è®¡ç®—æ‰å¯èƒ½æˆåŠŸã€‚

# Reference

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜](https://book.douban.com/subject/10484692/)

[æºä»£ç ](http://jcip.net/listings.html)

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼ˆå­¦ä¹ ç¬”è®°å›› ç¬¬äº”ç«  åŸºç¡€æ„å»ºæ¨¡å— ä¸Šï¼‰](https://blog.csdn.net/ahaha413525642/article/details/76683937)

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼ˆå­¦ä¹ ç¬”è®°å›› ç¬¬äº”ç«  åŸºç¡€æ„å»ºæ¨¡å— ä¸‹ï¼‰](https://blog.csdn.net/ahaha413525642/article/details/76709483)

