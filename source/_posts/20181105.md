---
title: Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜-ç¬¬7ç« -å–æ¶ˆä¸å…³é—­
typora-copy-images-to: 20181105
date: 2018-11-05 09:22:17
tags:
  - Java
  - å¹¶å‘
  - ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹
categories:
  - è¯»ä¹¦ç¬”è®°
---

æœ¬ç« å°†ç»™å‡ºå„ç§å®ç°å–æ¶ˆå’Œä¸­æ–­çš„æœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä»»åŠ¡å’ŒæœåŠ¡ï¼Œä½¿å®ƒä»¬èƒ½å¯¹å–æ¶ˆè¯·æ±‚åšå‡ºå“åº”ã€‚

# ä»»åŠ¡å–æ¶ˆ

å¯å–æ¶ˆçš„æ“ä½œ ï¼šã€€å¤–éƒ¨ä»£ç èƒ½åœ¨æŸä¸ªæ“ä½œæ­£å¸¸å®Œæˆä¹‹å‰å°†å…¶ç½®å…¥â€œå®Œæˆâ€çŠ¶æ€

å–æ¶ˆæŸä¸ªæ“ä½œçš„åŸå› ï¼š

- ç‚¹å‡»æŸä¸ªæ¡Œé¢åº”ç”¨ä¸­çš„å–æ¶ˆæŒ‰é’®æ—¶ï¼› 
- æŸä¸ªæ“ä½œè¶…è¿‡äº†ä¸€å®šçš„æ‰§è¡Œæ—¶é—´é™åˆ¶éœ€è¦ä¸­æ­¢æ—¶ï¼› 
- å¤šä¸ªçº¿ç¨‹åšç›¸åŒçš„äº‹æƒ…ï¼Œåªè¦ä¸€ä¸ªçº¿ç¨‹æˆåŠŸå…¶å®ƒçº¿ç¨‹éƒ½å¯ä»¥å–æ¶ˆæ—¶ï¼› 
- ä¸€ç»„çº¿ç¨‹ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå‡ºç°é”™è¯¯å¯¼è‡´æ•´ç»„éƒ½æ— æ³•ç»§ç»­æ—¶ï¼› 
- å½“ä¸€ä¸ªåº”ç”¨æˆ–æœåŠ¡éœ€è¦åœæ­¢æ—¶ã€‚

Javaä¸­æ²¡æœ‰ä¸€ç§å®‰å…¨çš„æŠ¢å å¼æ–¹æ³•æ¥åœæ­¢çº¿ç¨‹ï¼Œåªæœ‰ä¸€äº›åä½œå¼çš„æœºåˆ¶ï¼Œä»£ç éƒ½ä¼šéµå¾ªçš„ä¸€ç§åè®®ã€‚

æ¯”å¦‚ï¼š

> **â€œå·²è¯·æ±‚å–æ¶ˆâ€æ ‡å¿—**
>
> ä»»åŠ¡å°†å®šæœŸåœ°æŸ¥çœ‹è¿™ä¸ªæ ‡å¿—ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ï¼Œé‚£ä¹ˆä»»åŠ¡å°†æå‰ç»“æŸã€‚

ğŸ˜ŠPrimeGeneratoræŒç»­åœ°æšä¸¾ç´ æ•°ï¼ˆPrimeï¼‰ï¼Œç›´åˆ°cancelledè¢«è®¾ç½®ã€‚ä¸ºäº†ç¡®ä¿å¯é æ€§cancelledè¢«è®¾ç½®ä¸ºvolatileã€‚

```java
//        7-1      ä½¿ç”¨Volatileç±»å‹çš„åŸŸæ¥ä¿å­˜å–æ¶ˆçŠ¶æ€  
public class PrimeGenerator implements Runnable{
    private final List<BigInteger> primes=
            new ArrayList<BigInteger>();
    private volatile boolean cancelled;//volatileå˜é‡èƒ½ç¡®ä¿å¯è§æ€§ ç¦æ­¢æŒ‡ä»¤é‡æ’åº

    public void run(){
        BigInteger p=BigInteger.ONE;//å¸¸é‡
        while(!cancelled){  //ä»»åŠ¡å°†å®šæœŸåœ°æŸ¥çœ‹è¿™ä¸ªæ ‡å¿—ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ï¼Œé‚£ä¹ˆä»»åŠ¡å°†æå‰ç»“æŸã€‚ï¼ˆå³å¦‚æœcancelledä¸ä¸ºtrueåˆ™ä¸€ç›´è¿è¡Œï¼‰
            p=p.nextProbablePrime();//è¿”å›ä¸€ä¸ªæ¯”å½“å‰å¤§çš„
            synchronized (this) { //ç¡®ä¿ä¸ä¼šè¢«æ·»åŠ å¤šæ¬¡
                primes.add(p);
            }
        }
    }

    public void cancel(){
        cancelled=true;      //å°†â€œå·²è¯·æ±‚å–æ¶ˆæ ‡å¿—â€å–ä¸ºtrue
    }

    public synchronized List<BigInteger> get(){
        return new ArrayList<BigInteger>(primes);
    }
}
```

ä¸Šé¢ä»£ç çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œä¸€ä¸ªä»…è¿è¡Œä¸€ç§’çš„ç´ æ•°ç”Ÿæˆå™¨

```java
//            7-2      ä¸€ä¸ªä»…è¿è¡Œä¸€ç§’çš„ç´ æ•°ç”Ÿæˆå™¨
  static List<BigInteger> aSecondOfPrimes() throws InterruptedException{
        PrimeGenerator generator=new PrimeGenerator();
        new Thread(generator).start();
        try{
            SECONDS.sleep(1); //å»¶è¿Ÿä¸€ç§’æ‰æ‰§è¡Œcancel
        }finally{
            generator.cancel();
        }
        return generator.get();

    }
```

cancelæ–¹æ³•ç”±finallyå—è°ƒç”¨ï¼Œç¡®ä¿å³ä½¿åœ¨è°ƒç”¨sleepæ—¶è¢«ä¸­æ–­ä¹Ÿèƒ½å–æ¶ˆç´ æ•°ç”Ÿæˆå™¨çš„æ‰§è¡Œã€‚

## ä¸­æ–­

PrimeGeneratorçš„é—®é¢˜ï¼šæœä½¿ç”¨è¿™ç§æ–¹æ³•çš„ä»»åŠ¡è°ƒç”¨äº†ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œä¾‹å¦‚BlockingQueue.putï¼Œé‚£ä¹ˆä»»åŠ¡å¯èƒ½æ°¸è¿œä¸ä¼šæ£€æŸ¥å–æ¶ˆæ ‡å¿—ï¼Œå› æ­¤æ°¸è¿œä¸ä¼šç»“æŸã€‚

ğŸ˜§ç”Ÿäº§è€…çº¿ç¨‹ç”Ÿæˆç´ æ•°ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚å¦‚æœç”Ÿæˆè€…çš„é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦ï¼Œ é˜Ÿåˆ—å°†è¢«å¡«æ»¡ï¼Œputæ–¹æ³•ä¹Ÿä¼šé˜»å¡ã€‚å› æ­¤ï¼Œç”Ÿäº§è€…å´æ°¸è¿œä¸èƒ½æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ã€‚

```java
//             7-3    ä¸å¯é çš„å–æ¶ˆæ“ä½œå§ç”Ÿæˆè€…ç½®äºé˜»å¡çš„æ“ä½œä¸­ï¼ˆä¸è¦è¿™ä¹ˆåšï¼‰
public class BrokenPrimeProducer extends Thread {
       private final BlockingQueue<BigInteger> queue;
       private volatile boolean cancelled=false;

      public BrokenPrimeProducer(BlockingQueue<BigInteger> queue) {
        this.queue=queue;
      }

      public void run(){
          try{
              BigInteger p=BigInteger.ONE;
              while(!cancelled){
                  queue.put(p=p.nextProbablePrime());
              }
          }catch (InterruptedException consumed) {

        }
      }
}

void consumePrimes() throws InterruptedException{
    BlockingQueue<BigInteger> primes=new ArrayBlockingQueue<>(MAX_PRIORITY);
    BrokenPrimeProducer producer=new BrokenPrimeProducer(primes);
    producer.start();
    try{
        while(needMorePrimes())              //å¦‚æœéœ€è¦ç»§ç»­æ¶ˆè´¹
            consume(primes.take());
    }finally{              
        //å®ƒå¯ä»¥è°ƒç”¨cancelæ–¹æ³•æ¥è®¾ç½®cancelledæ ‡å¿—ï¼Œä½†æ­¤æ—¶ç”Ÿäº§è€…å´æ°¸è¿œä¸èƒ½æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œå› ä¸ºå®ƒæ— æ³•ä»é˜»å¡çš„putæ–¹æ³•ä¸­æ¢å¤è¿‡æ¥ï¼ˆå› ä¸ºæ¶ˆè´¹è€…æ­¤æ—¶å·²ç»åœæ­¢ä»é˜Ÿåˆ—ä¸­å–å‡ºç´ æ•°ï¼Œæ‰€ä»¥putæ–¹æ³•å°†ä¸€ç›´ä¿æŒé˜»å¡çŠ¶æ€ã€‚ï¼‰
        producer.cancel();
    }
}
```

> **Threadçš„ä¸­æ–­**
> é˜»å¡åº“æ–¹æ³•å®šæœŸæ£€æŸ¥Threadçš„ä¸­æ–­ï¼Œå¹¶åœ¨é€‚å½“æ—¶å€™åœæ­¢å½“å‰å·¥ä½œ

**Threadä¸­çš„ä¸­æ–­æ–¹æ³•** ï¼š æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªbooleanç±»å‹çš„ä¸­æ–­çŠ¶æ€ã€‚å½“ä¸­æ–­çº¿ç¨‹æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†è¢«è®¾ç½®ä¸ºtrueã€‚

åœ¨Threadä¸­åŒ…å«äº†ä¸­æ–­çº¿ç¨‹ä»¥åŠæŸ¥è¯¢çº¿ç¨‹ä¸­æ–­çŠ¶æ€çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

- interruptæ–¹æ³•èƒ½ä¸­æ–­ç›®æ ‡çº¿ç¨‹ 
- isInterruptæ–¹æ³•èƒ½è¿”å›ç›®æ ‡çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ 
- é™æ€çš„interruptedæ–¹æ³•å°†æ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¹¶è¿”å›å®ƒä¹‹å‰çš„å€¼ï¼Œè¿™ä¹Ÿæ˜¯æ¸…é™¤ä¸­æ–­çŠ¶æ€çš„å”¯ä¸€æ–¹æ³•ã€‚

é˜»å¡åº“æ–¹æ³•ï¼Œå¦‚Thread.sleepå’ŒObject.waitï¼Œåœ¨å‘ç°ä¸­æ–­æ—¶æå‰è¿”å›ã€‚å®ƒä»¬åœ¨å“åº”ä¸­æ–­æ—¶ä¼šï¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼ŒæŠ›å‡ºInterruptedException

**è°ƒç”¨Interruptå¹¶ä¸æ„å‘³ç€ç«‹å³åœæ­¢ç›®æ ‡çº¿ç¨‹æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œè€Œåªæ˜¯ä¼ é€’äº†è¯·æ±‚ä¸­æ–­çš„æ¶ˆæ¯ã€‚**

ä¸Šé¢çš„BrokenPrimeProducerçš„è§£å†³æ–¹å¼ï¼šè¿›è¡Œé˜»å¡çš„BlockingQueueå¯ä»¥æ£€æµ‹Threadçš„interruptï¼Œæ‰€ä»¥ç”¨interruptä»£æ›¿è‡ªå®šä¹‰çš„ä¸­æ–­æ–¹å¼ã€‚

```java
//       7-5 é€šè¿‡ä¸­æ–­æ¥å–æ¶ˆ
public class PrimeProducer extends Thread {
    private final BlockingQueue<BigInteger> queue;

    PrimeProducer(BlockingQueue<BigInteger> queue) {
        this.queue = queue;
    }

    public void run() {
        try {
            BigInteger p = BigInteger.ONE;
            //åœ¨æ¯æ¬¡è¿­ä»£å¾ªç¯ä¸­ï¼Œæœ‰ä¸¤ä¸ªä½ç½®å¯ä»¥æ£€æµ‹å‡ºä¸­æ–­ï¼šåœ¨é˜»å¡çš„putæ–¹æ³•ä¸­è°ƒç”¨ï¼Œä»¥åŠåœ¨å¾ªç¯å¼€å§‹å¤„æŸ¥è¯¢ä¸­æ–­çŠ¶æ€ã€‚
            while (!Thread.currentThread().isInterrupted())
                queue.put(p = p.nextProbablePrime());
        } catch (InterruptedException consumed) {
            /* å…è®¸çº¿ç¨‹é€€å‡º */
        }
    }

    public void cancel() {
        interrupt();
    }
}
```

## ä¸­æ–­ç­–ç•¥

ä¸­æ–­ç­–ç•¥ï¼šåœ¨å‘ç°ä¸­æ–­è¯·æ±‚æ—¶åº”è¯¥åšå“ªäº›å·¥ä½œ

æœ€åˆç†çš„ç»ˆç«¯ç­–ç•¥ï¼šå°½å¿«é€€å‡ºï¼Œå¹¶æŠŠä¸­æ–­ä¿¡æ¯ä¼ é€’ç»™è°ƒç”¨è€…ï¼Œä»è€Œä½¿è°ƒç”¨æ ˆä¸­çš„ä¸Šå±‚ä»£ç å¯ä»¥é‡‡å–è¿›ä¸€æ­¥çš„æ“ä½œã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°å¯é˜»å¡çš„åº“å‡½æ•°éƒ½åªæ˜¯æŠ›å‡ºInterruptedExceptionä½œä¸ºä¸­æ–­å“åº”ã€‚å®ƒä»¬æ°¸è¿œä¸ä¼šåœ¨æŸä¸ªç”±è‡ªå·±æ‹¥æœ‰çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œå› æ­¤å®ƒä»¬ä¸ºä»»åŠ¡æˆ–åº“ä»£ç å®ç°äº†è¿™ä¸ªæœ€åˆç†çš„å–æ¶ˆç­–ç•¥ã€‚ä½†å®ƒå¯ä»¥æ¨è¿Ÿå¤„ç†ä¸­æ–­è¯·æ±‚ï¼Œå¹¶ç›´åˆ°æŸä¸ªæ›´åˆé€‚çš„æ—¶åˆ»ï¼Œåœ¨æŠ›å‡ºInterruptedExceptionã€‚

## å“åº”ä¸­æ–­

æœ‰ä¸¤ç§å®ç”¨ç­–ç•¥å¯ç”¨äºå¤„ç†InterruptedExceptionï¼š 

- **ä¼ é€’å¼‚å¸¸**ï¼ˆå¯èƒ½åœ¨æŸä¸ªç‰¹å®šäºä»»åŠ¡é¢æ¸…é™¤æ“ä½œä¹‹åï¼‰ï¼Œä»è€Œä½¿ä½ çš„æ–¹æ³•ä¹Ÿç§°ä¸ºå¯ä¸­æ–­çš„é˜»å¡æ–¹æ³•ã€‚
- **æ¢å¤ä¸­æ–­çŠ¶æ€**ï¼Œä»è€Œä½¿è°ƒç”¨æ ˆä¸Šçš„ä¸Šå±‚ä»£ç èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ä¹Ÿå°±æ˜¯catch InterruptedException

æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªç”±ThreadPoolExecutoræ‹¥æœ‰çš„å·¥ä½œè€…çº¿ç¨‹æ£€æµ‹åˆ°ä¸­æ–­æ—¶ï¼Œå®ƒä¼šæ£€æµ‹çº¿ç¨‹æ± æ˜¯å¦æ­£åœ¨å…³é—­ã€‚å¦‚æœæ˜¯ï¼Œå®ƒä¼šåœ¨ç»“æŸä¹‹å‰æ‰§è¡Œä¸€äº›çº¿ç¨‹æ± æ¸…ç†å·¥ä½œï¼Œå¦åˆ™å®ƒå¯èƒ½åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å°†çº¿ç¨‹æ± æ¢å¤åˆ°åˆç†çš„è§„æ¨¡

## ç¤ºä¾‹ï¼šè®¡æ—¶è¿è¡Œ

ğŸ˜§åœ¨æŒ‡å®šæ—¶é—´å†…è¿è¡Œä¸€ä¸ªRunnableï¼ŒæŒ‡å®šæ—¶é—´åä¸­æ–­ï¼Œè¯¥å¼‚å¸¸ä¼šè¢«timeRun1çš„è°ƒç”¨è€…æ•è·

```java
//        7-8    åœ¨å¤–éƒ¨çº¿ç¨‹ä¸­å®‰æ’ä¸­æ–­ï¼ˆä¸è¦è¿™ä¹ˆåšï¼‰
public class TimedRun1 {
    private static final ScheduledExecutorService cancelExec = Executors.newScheduledThreadPool(1);
  //ræ˜¯ä»»åŠ¡
    public static void timedRun(Runnable r,
                                long timeout, TimeUnit unit) {
        //è¿”å›ä¸€ä¸ªå¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹çš„å¼•ç”¨
        final Thread taskThread = Thread.currentThread();
        //å®ƒåœ¨è°ƒç”¨çº¿ç¨‹ä¸­è¿è¡Œä»»åŠ¡ï¼Œå¹¶å®‰æ’äº†ä¸€ä¸ªå–æ¶ˆä»»åŠ¡ï¼Œåœ¨è¿è¡ŒæŒ‡å®šçš„æ—¶é—´é—´éš”åä¸­æ–­å®ƒã€‚
        cancelExec.schedule(new Runnable() {
            public void run() {
                taskThread.interrupt();
            }
        }, timeout, unit);
        //è¿è¡Œä»»åŠ¡
        r.run();
    }
}
```

ä¸Šé¢çš„ç¨‹åºæœ‰å“ªäº›é—®é¢˜ï¼Œä¸»è¦æ˜¯ç”±äºtimedRunä¸äº†è§£æ¯ä¸ªå‚æ•°Runnableçš„ä¸­æ–­ç­–ç•¥ï¼š

- å¯èƒ½è¿™ä¸ªRunnableåœ¨è¶…æ—¶å‰å°±å®Œæˆäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸­æ–­å¼‚å¸¸å°†ä¼šåœ¨è°ƒç”¨è€…ä¹‹åçš„ç¨‹åºä¸­æ‰æŠ›å‡ºã€‚
- å¯èƒ½ä»»åŠ¡ä¸å“åº”ä¸­æ–­ï¼ŒtimedRunä¼šåœ¨ä»»åŠ¡ç»“æŸæ—¶æ‰è¿”å›ï¼Œæ²¡æœ‰èµ·åˆ°æ—¶é—´é™åˆ¶çš„ä½œç”¨ã€‚

ğŸ˜• ä¸Šé¢é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼šæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ‰§è¡Œç­–ç•¥ï¼Œå³ä½¿ä»»åŠ¡ä¸å“åº”ä¸­æ–­ï¼Œé™æ—¶è¿è¡Œçš„æ–¹æ³•ä»ç„¶èƒ½è¿”å›åˆ°å®ƒçš„è°ƒç”¨è€…ã€‚

```java
//           7-9  åœ¨ä¸“é—¨çš„çº¿ç¨‹ä¸­ä¸­æ–­ä»»åŠ¡     
public class timeRun2 {
    private static final ScheduledExecutorService cancelExec = newScheduledThreadPool(1);

    public static void timedRun(final Runnable r,
                                long timeout, TimeUnit unit)
            throws InterruptedException {
        class RethrowableTask implements Runnable {
            private volatile Throwable t; //æ‰€æœ‰errorå’Œexceptionçš„è¶…ç±»

            public void run() {
                try {
                    r.run();
                } catch (Throwable t) {
                    this.t = t;
                }
            }

            void rethrow() {
                if (t != null)
                    throw LaunderThrowable.launderThrowable(t);
            }
        }
//æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ‰§è¡Œç­–ç•¥ï¼Œå³ä½¿ä»»åŠ¡ä¸å“åº”ä¸­æ–­ï¼Œé™æ—¶è¿è¡Œçš„æ–¹æ³•ä»ç„¶èƒ½è¿”å›åˆ°å®ƒçš„è°ƒç”¨è€…ã€‚
        RethrowableTask task = new RethrowableTask();
        final Thread taskThread = new Thread(task);
        taskThread.start();
        cancelExec.schedule(new Runnable() {
            public void run() {
                taskThread.interrupt();
            }
        }, timeout, unit);
        taskThread.join(unit.toMillis(timeout));//ç­‰å¾…ä»»åŠ¡çº¿ç¨‹çš„æ¶ˆäº¡ï¼Œå³ç­‰å®ƒè¿è¡Œå®Œæ¯•
        //åœ¨joinè¿”å›åï¼Œå®ƒå°†æ£€æŸ¥ä»»åŠ¡ä¸­æ˜¯å¦æœ‰å¼‚å¸¸æŠ›å‡ºï¼Œå¦‚æœæœ‰çš„è¯ï¼Œåˆ™ä¼šåœ¨è°ƒç”¨timedRun2çš„çº¿ç¨‹ä¸­å†æ¬¡æŠ›å‡ºåº”è¯¥å¼‚å¸¸ã€‚
        task.rethrow();
    }
}
```

è¿™ä¸ªç¨‹åºçš„é—®é¢˜æ˜¯ï¼Œå®ƒä¾èµ–äºä¸€ä¸ªé™æ—¶çš„join
joinçš„ä¸è¶³ï¼šæ— æ³•çŸ¥é“æ‰§è¡Œæ§åˆ¶æ˜¯å› ä¸ºçº¿ç¨‹æ­£å¸¸é€€å‡ºè¿˜æ˜¯å› ä¸ºjoinè¶…æ—¶è€Œè¿”å›ã€‚

## é€šè¿‡Futureæ¥å®ç°å–æ¶ˆ

å…ˆè¯´ä¸€ä¸‹Futureå¸¦æœ‰çš„cancelæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¸¦æœ‰ä¸€ä¸ªbooleanç±»å‹çš„å‚æ•°mayInterruptIfRunningï¼Œè¡¨ç¤ºå–æ¶ˆæ“ä½œæ˜¯å¦æˆåŠŸã€‚

mayInterruptIfRunningå‚æ•°ï¼štrueè¡¨ç¤ºçº¿ç¨‹èƒ½è¢«ä¸­æ–­ï¼Œfalseåˆ™è¡¨ç¤ºä¸èƒ½ã€‚

ä»€ä¹ˆæ—¶å€™å¯ä»¥æŠŠcancelçš„å‚æ•°æŒ‡å®šä¸ºtrueï¼Ÿå¦‚æœæ˜¯åœ¨æ ‡å‡†çš„Executorä¸­åˆ›å»ºï¼Œå¹¶ä¸”ä½ æ‰“ç®—ç”¨Futureæ¥å–æ¶ˆï¼Œåˆ™å¯ä»¥ã€‚

```java
//          7-10     é€šè¿‡Futureæ¥å–æ¶ˆä»»åŠ¡
public class TimedRun {
    private static final ExecutorService taskExec = Executors.newCachedThreadPool();

    public static void timedRun(Runnable r,
                                long timeout, TimeUnit unit)
            throws InterruptedException {
        Future<?> task = taskExec.submit(r);
        try {
            task.get(timeout, unit);//åœ¨é™æ—¶å†…å–å¾—ç»“æœï¼Œå¦‚æœè¦ç­‰å¾…åˆ™ç­‰å¾…
        } catch (TimeoutException e) {
            // æ¥ä¸‹æ¥ä»»åŠ¡ä¼šè¢«å–æ¶ˆ
        } catch (ExecutionException e) {
            // å¦‚æœåœ¨ä»»åŠ¡ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆé‡æ–°æŠ›å‡ºè¯¥å¼‚å¸¸
            throw launderThrowable(e.getCause());
        } finally {
            // å¦‚æœä»»åŠ¡å·²ç»ç»“æŸï¼Œé‚£ä¹ˆæ‰§è¡Œå–æ¶ˆæ“ä½œä¹Ÿä¸ä¼šæœ‰ä»»ä½•å½±å“
            task.cancel(true); // å¦‚æœä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œé‚£ä¹ˆå°†è¢«ä¸­æ–­
        }
    }
}
```

## å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡

ä¸æ˜¯æ‰€æœ‰Javaä¸­çš„é˜»å¡æœºåˆ¶éƒ½ä¼šç›´æ¥å“åº”InterruptExceptionï¼Œå¦‚ä¸€ä¸ªçº¿ç¨‹ç”±äºæ‰§è¡ŒåŒæ­¥çš„Socket I/Oæˆ–è€…ç­‰å¾…è·å¾—å†…ç½®é”è€Œé˜»å¡ã€‚ä½†ä»–ä»¬ä¹Ÿæœ‰ç±»ä¼¼InterruptExceptionçš„æœºåˆ¶ï¼š

- **Java.ioåŒ…ä¸­çš„åŒæ­¥Socket I/O**
  åœ¨æœåŠ¡å™¨åº”ç”¨ç¨‹åºä¸­ï¼Œæœ€å¸¸è§çš„é˜»å¡I/Oå½¢å¼å°±æ˜¯å¯¹å¥—æ¥å­—è¿›è¡Œè¯»å–å’Œå†™å…¥ã€‚è™½ç„¶InputStreamå’ŒOutputStreamä¸­çš„readå’Œwriteç­‰æ–¹æ³•ä¸ä¼šå“åº”ä¸­æ–­ï¼Œä½†é€šè¿‡å…³é—­åº•å±‚çš„socketï¼ˆå¥—æ¥å­—ï¼‰ï¼Œå¯ä»¥ä½¿å¾—ç”±äºæ‰§è¡Œreadå’Œwriteç­‰æ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹æŠ›å‡ºä¸€ä¸ªSocketExceptionã€‚
- **Java.ioåŒ…ä¸­çš„åŒæ­¥I/O**
  å½“ä¸­æ–­ä¸€ä¸ªæ­£åœ¨InterruptibleChannelä¸Šç­‰å¾…çš„çº¿ç¨‹æ—¶ï¼Œå°†æŠ›å‡ºClosedByInterruptExceptionå¹¶å…³é—­é“¾è·¯ï¼ˆchannelï¼‰ï¼ˆè¿™ä¼šä½¿å¾—å…¶ä»–åœ¨è¿™æ¡é“¾è·¯ä¸Šé˜»å¡çš„çº¿ç¨‹åŒæ ·æŠ›å‡ºClosedByInterruptExceptionï¼‰ã€‚å½“å…³é—­ä¸€ä¸ªInterruptibleChannelæ—¶ï¼Œå°†å¯¼è‡´æ‰€æœ‰åœ¨é“¾è·¯æ“ä½œä¸Šé˜»å¡çš„çº¿ç¨‹éƒ½æŠ›å‡ºAsynchronousCloseExceptionã€‚å¤§å¤šæ•°æ ‡å‡†çš„Channeléƒ½å®ç°(implements)äº†InterruptibleChannelã€‚
- **Selectorçš„å¼‚æ­¥I/O**
  å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨Selector.selectæ–¹æ³•ï¼ˆåœ¨java.nio.channelsä¸­ï¼‰æ—¶é˜»å¡äº†ï¼Œé‚£ä¹ˆè°ƒç”¨closeå’Œwakeupæ–¹æ³•ä¼šä½¿çº¿ç¨‹æŠ›å‡ºClosedByInterruptExceptionå¹¶æå‰è¿”å›ã€‚
- **è·å–æŸä¸ªé”**
  å¦‚æœä¸€ä¸ªçº¿ç¨‹ç”±äºç­‰å¾…æŸä¸ªå†…ç½®é”è€Œé˜»å¡ï¼Œé‚£ä¹ˆå°†æ— æ³•å“åº”ä¸­æ–­ï¼Œå› ä¸ºçº¿ç¨‹è®¤ä¸ºå®ƒè‚¯å®šä¼šå¾—åˆ°é”ï¼Œæ‰€æœ‰å°†ä¸ä¼šç†ä¼šä¸­æ–­è¯·æ±‚ã€‚ä½†æ˜¯ï¼Œåœ¨Lockç±»æä¾›äº†lockInterruptiblyæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…è®¸åœ¨ç­‰å¾…ä¸€ä¸ªé”çš„åŒæ—¶ä»èƒ½å“åº”ä¸­æ–­ã€‚

è®©ä¸€ä¸ªSocketæ—¢èƒ½å¤„ç†æ ‡å‡†çš„ä¸­æ–­ï¼Œä¹Ÿèƒ½å…³é—­åº•å±‚çš„å¥—æ¥å­—

```java
//               7-11 é€šè¿‡æ”¹å†™interruptæ–¹æ³•å°†éæ ‡å‡†çš„å–æ¶ˆæ“ä½œå°è£…åœ¨Threadä¸­
public class ReaderThread extends Thread{
    private static final int BUFSZ = 512;
    private final Socket socket;
    private final InputStream in;

    public ReaderThread(Socket socket) throws IOException{
        this.socket=socket;
        this.in=socket.getInputStream();
    }
    //æ”¹å†™äº†interruptæ–¹æ³•ï¼Œä½¿å…¶æ—¢èƒ½å¤„ç†æ ‡å‡†çš„ä¸­æ–­ï¼Œä¹Ÿèƒ½å…³é—­åº•å±‚çš„å¥—æ¥å­—
    public void interrupt(){
        try{
            socket.close();
        }catch (IOException ignored) {      
        }finally{
            //è°ƒç”¨ç»§æ‰¿çš„Threadä¸­çš„æ–¹æ³•å¤„ç†æ ‡å‡†çš„ä¸­æ–­
            super.interrupt();
        }
    }

    public void run(){
        try{
            byte[] buf=new byte[BUFSZ];
            while(true){       //ç”¨åŒæ­¥çš„æ–¹å¼ä»è¯¥å¥—æ¥å­—ä¸­è¯»å–æ•°æ®
                int count=in.read(buf);
                if(count<0)
                    break;
                else if(count>0)
                    processBuffer(buf,count); //å¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®ä¼ é€’ç»™processBuffer
            }
        }catch (IOException e) {
            // å…è®¸çº¿ç¨‹é€€å‡º       
        }
    }
}
```

æ— è®ºReaderThreadçº¿ç¨‹æ˜¯åœ¨readæ–¹æ³•ä¸­é˜»å¡è¿˜æ˜¯åœ¨æŸä¸ªå¯ä¸­æ–­çš„é˜»å¡æ–¹æ³•ä¸­é˜»å¡ï¼Œéƒ½å¯ä»¥è¢«ä¸­æ–­å¹¶åœæ­¢æ‰§è¡Œå½“å‰çš„å·¥ä½œã€‚

## é‡‡ç”¨newTaskForæ¥å°è£…éæ ‡å‡†çš„å–æ¶ˆ

newTaskForï¼šThreadPoolExecutorä¸­çš„ä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œå®ƒå°†åˆ›å»ºFutureæ¥ä»£è¡¨ä»»åŠ¡ã€‚newTaskForè¿˜èƒ½è¿”å›ä¸€ä¸ªRunnableFutureæ¥å£ï¼Œè¯¥æ¥å£ç»§æ‰¿ï¼ˆæ‰©å±•ï¼‰äº†Futureå’ŒRunnableï¼ˆå¹¶ç”±FutureTaskå®ç°ï¼‰ã€‚

æ”¹å†™Future.cancelä¹Ÿå¯ä»¥å®ç°å’Œä¸Šé¢ä»£ç ç›¸åŒçš„åŠŸèƒ½

```java
//   7-12     é€šè¿‡newTaskForå°†éæ ‡å‡†çš„å–æ¶ˆæ“ä½œå°è£…åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­
//CancellableTaskå®šä¹‰äº†ä¸€ä¸ªCancellableTaskæ¥å£ï¼Œè¯¥æ¥å£æ‰©å±•äº†Callableï¼Œå¹¶å¢åŠ äº†ä¸€ä¸ªcancelæ–¹æ³•å’ŒnewTaskæ–¹æ³•æ¥æ„é€ RunnableFutureã€‚
public interface CancellableTask<T> extends Callable<T> {
       void cancel();
       RunnableFuture<T> newTask();
}
```

```java
//   7-12     é€šè¿‡newTaskForå°†éæ ‡å‡†çš„å–æ¶ˆæ“ä½œå°è£…åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­
//CancellingExecutorç»§æ‰¿äº†THReadPoolExecutorï¼Œå¹¶é€šè¿‡æ”¹å†™newTaskForä½¿å¾—CancellableTaskå¯ä»¥åˆ›å»ºè‡ªå·±çš„Future
@ThreadSafe
class CancellingExecutor extends ThreadPoolExecutor {
	...
    protected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {
        if (callable instanceof CancellableTask)
            return ((CancellableTask<T>) callable).newTask();
        else
            return super.newTaskFor(callable);
    }
}
```

```java
//            7-12 é€šè¿‡newTaskForå°†éæ ‡å‡†çš„å–æ¶ˆæ“ä½œå°è£…åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­
//           SocketUsingTaskå®ç°äº†CancellableTask
public abstract class SocketUsingTask <T> implements CancellableTask<T> {
     private Socket socket;

    protected synchronized void setSocket(Socket s) {
        socket = s;
    }
   //å®šä¹‰äº†Future.cancelæ¥å…³é—­å¥—æ¥å­—
    public synchronized void cancel() {
        try {
            if (socket != null)
                socket.close();
        } catch (IOException ignored) {
        }
    }
   //å¦‚æœSocketUsingTaské€šè¿‡å…¶è‡ªå·±çš„Futureæ¥å–æ¶ˆï¼Œé‚£ä¹ˆåº•å±‚çš„å¥—æ¥å­—å°†è¢«å…³é—­å¹¶ä¸”çº¿ç¨‹å°†è¢«ä¸­æ–­
    public RunnableFuture<T> newTask() {
        return new FutureTask<T>(this) {  //Creates a FutureTask that will, upon runningï¼ˆæ­£åœ¨è¿è¡Œï¼‰, execute the given Callable.
            @SuppressWarnings("finally")
            public boolean cancel(boolean mayInterruptIfRunning) {
                try {
                    SocketUsingTask.this.cancel();
                } finally {  //è°ƒç”¨super.cancel
                    return super.cancel(mayInterruptIfRunning);
                }
            }
        };
    }
}
```

# åœæ­¢åŸºäºçº¿ç¨‹çš„æœåŠ¡

æœåŠ¡åº”è¯¥æä¾›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ¥å…³é—­å®ƒè‡ªå·±ä»¥åŠå®ƒæ‰€æ‹¥æœ‰çš„çº¿ç¨‹ï¼Œæ¯”å¦‚ExecutorServiæä¾›äº†shutdownå’ŒshutdownNowç­‰æ–¹æ³•ã€‚

## ç¤ºä¾‹ï¼šæ—¥å¿—æœåŠ¡

ğŸ˜• æ—¥å¿—æ“ä½œåœ¨å•ç‹¬çš„æ—¥å¿—çº¿ç¨‹ä¸­æ‰§è¡Œã€‚äº§ç”Ÿæ—¥å¿—æ¶ˆæ¯çš„çº¿ç¨‹å¹¶ä¸ä¼šå°†æ¶ˆæ¯ç›´æ¥å†™å…¥è¾“å‡ºæµï¼Œè€Œæ˜¯ç”±LogWriteré€šè¿‡BlockingQueueå°†æ¶ˆæ¯æäº¤ç»™æ—¥å¿—çº¿ç¨‹ï¼Œç”±æ—¥å¿—çº¿ç¨‹å†™å…¥ã€‚

```java
//         7-13 ä¸æ”¯æŒå…³é—­çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ—¥å¿—æœåŠ¡ï¼ˆä¸å¥½ï¼‰
public class LogWriter {
      private final BlockingQueue<String> queue;
      private final LoggerThread logger; //logger(è®°å½•å™¨)
      private static final int CAPACITY = 1000;

      public LogWriter(Writer writer){
          this.queue=new LinkedBlockingQueue<>(CAPACITY);
          this.logger=new LoggerThread(writer);
      }

      public void start(){ //å¯åŠ¨çº¿ç¨‹
          logger.start();
      }
      //å……å½“ç”Ÿäº§è€…
      public void log(String msg)throws InterruptedException{
          queue.put(msg);
      }
      //äº§ç”Ÿæ—¥å¿—æ¶ˆæ¯çš„çº¿ç¨‹å¹¶ä¸ä¼šå°†æ¶ˆæ¯ç›´æ¥å†™å…¥è¾“å‡ºæµï¼Œè€Œæ˜¯ç”±LogWriteré€šè¿‡BlockingQueueå°†æ¶ˆæ¯æäº¤ç»™æ—¥å¿—çº¿ç¨‹ï¼Œç”±æ—¥å¿—çº¿ç¨‹å†™å…¥ã€‚
      private class LoggerThread extends Thread{   //æ—¥å¿—çº¿ç¨‹
          private final PrintWriter writer;  //PrintWriteræ˜¯çº¿ç¨‹å®‰å…¨çš„

          public LoggerThread(Writer writer) {
              this.writer = new PrintWriter(writer, true); // trueå‚æ•°ä»£è¡¨äº†autoflush
          }

          public void run(){
              try{
                  while(true)
                      writer.println(queue.take());
              }catch (InterruptedException ignored) {	//å¯ä»¥åšäº›ä»€ä¹ˆ..ä½†æ˜¯..
              }finally{
                writer.close();
              }
          }
      }
}
```

å¦‚æœå°†æ—¥å¿—çº¿ç¨‹ä¿®æ”¹ä¸ºå½“æ•è·åˆ°InterruptedExceptionæ—¶é€€å‡ºï¼Œé‚£ä¹ˆåªéœ€ä¸­æ–­æ—¥å¿—çº¿ç¨‹å°±èƒ½åœæ­¢æœåŠ¡ã€‚ä½†æ˜¯ï¼Œ1.ä¼šä¸¢å¤±é‚£äº›æ­£åœ¨ç­‰å¾…è¢«å†™å…¥åˆ°æ—¥å¿—çš„ä¿¡æ¯ï¼Œ2.å…¶ä»–çº¿ç¨‹å°†åœ¨è°ƒç”¨logæ—¶è¢«é˜»å¡ï¼Œå› ä¸ºæ—¥å¿—æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ»¡çš„(æ—¥å¿—çº¿ç¨‹åœæ­¢äº†take)

ğŸ˜• å¦ä¸€ç§å…³é—­æ–¹æ³•ï¼šè®¾ç½®æŸä¸ªâ€œå·²è¯·æ±‚å…³é—­â€æ ‡å¿—(ä¸å‰é¢çš„å·²è¯·æ±‚å–æ¶ˆæ ‡å¿—ç±»ä¼¼)ï¼Œé¿å…è¿›ä¸€æ­¥æäº¤æ—¥å¿—ä¿¡æ¯ã€‚

```java
//          7-14    é€šè¿‡ä¸€ç§ä¸å¯é çš„æ–¹å¼ä¸ºæ—¥å¿—å¢åŠ å…³é—­æ”¯æŒ
public void log(String msg) throws InterruptedException {
     if (!shutdownRequested)    //å­˜åœ¨ç«æ€æ¡ä»¶,å› ä¸ºå®ƒæ˜¯â€œå…ˆåˆ¤æ–­å†è¿è¡Œâ€
         //æ£€æŸ¥çš„æ—¶å€™è¿˜æœªåœæ­¢ï¼Œè€Œputçš„æ—¶å€™åœæ­¢äº†ï¼Œè¿™ä¸ªæ—¶å€™å°†ä¼šé˜»å¡
          queue.put(msg);
     else                       //å¦åˆ™æŠ›å‡ºå¼‚å¸¸
           throw new IllegalStateException("logger is shut down");
     }
```

ğŸ˜Š é€šè¿‡åŸå­æ–¹å¼æ¥æ£€æŸ¥å…³é—­è¯·æ±‚ï¼Œå¹¶ä¸”æœ‰æ¡ä»¶åœ°é€’å¢ä¸€ä¸ªè®¡æ•°å™¨æ¥â€œä¿æŒâ€æäº¤ä¿¡æ¯çš„æƒåˆ©ã€‚

```java
//           7-15  å‘LogWriteræ·»åŠ å¯é çš„å–æ¶ˆæ“ä½œ
public class LogService {
     private final BlockingQueue<String> queue;
     private final LoggerThread loggerThread;
     private final PrintWriter  writer;
     private boolean isShutdown;
     private int reservations;  //ä¿ç•™,è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•æœ‰å¤šå°‘ä¸ªä»»åŠ¡â€œä¿æŒâ€æäº¤ä¿¡æ¯çš„æƒåˆ©

     public LogService(Writer writer) {
         this.queue = new LinkedBlockingQueue<String>();
         this.loggerThread = new LoggerThread();
         this.writer = new PrintWriter(writer);
     }

     public void start(){
         loggerThread.start();
     }

     public void stop(){
         synchronized (this) {   //é¿å…åœ¨æœªè®¾ç½®çš„æ—¶å€™æœ‰ä»»åŠ¡å¼€å§‹ï¼Œåœ¨è®¾ç½®åä»»åŠ¡å› ä¸ºåœæ­¢äº†é˜»å¡
            isShutdown=true;
        }
         loggerThread.interrupt();  //æ—¥å¿—çº¿ç¨‹ä¸­æ–­
     }

     public void log(String msg)throws InterruptedException{
         //é¿å…æ£€æŸ¥çš„æ—¶å€™è¿˜æœªåœæ­¢ï¼Œè€Œputçš„æ—¶å€™åœæ­¢äº†ï¼Œè¿™ä¸ªæ—¶å€™å°†ä¼šé˜»å¡
         synchronized (this) {        //é€šè¿‡åŸå­æ“ä½œæ¥æ£€æŸ¥å…³é—­è¯·æ±‚
            if(isShutdown)
                throw new IllegalStateException(/*...*/);
            ++reservations;  //é€’å¢ä¸€ä¸ªè®¡æ•°å™¨æ¥â€œä¿æŒâ€æäº¤ä¿¡æ¯çš„æƒåˆ©
        }
         queue.put(msg);
     }

     private class LoggerThread extends Thread{
         public void run(){
             try{
                 while(true){
                     try{     //ç”¨çš„éƒ½æ˜¯LogServiceçš„å†…ç½®é”
                         synchronized (LogService.this) { //é€šè¿‡åŸå­æ“ä½œæ¥æ£€æŸ¥å…³é—­è¯·æ±‚å’Œæ‹¥æœ‰æäº¤ä¿¡æ¯æƒåˆ©çš„ä»»åŠ¡çš„æ•°é‡
                            if(isShutdown&&reservations==0)
                                break;
                        }
                         String msg=queue.take();
                         synchronized (LogService.this) {//è¿™æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼Œéœ€è¦ä¸Šé”
                            --reservations;               
                        }
                         writer.println(msg);
                     }catch (InterruptedException e) {
                        // é‡è¯•
                    }
                 }
             }finally{
                 writer.close();
             }
         }
     }
}

```

## å…³é—­ExecutorService

ExecutorServiceæä¾›äº†ä¸¤ç§å…³é—­æ–¹æ³•ï¼š1.shutdownæ­£å¸¸å…³é—­ã€‚2.shutdownNowå¼ºè¡Œå…³é—­ï¼Œé¦–å…ˆå…³é—­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åè¿”å›æ‰€æœ‰å°šæœªå¯åŠ¨çš„ä»»åŠ¡æ¸…å•ã€‚

ä½¿ç”¨ExecutorServiceçš„æ—¥å¿—æœåŠ¡

```java
//        7-16  ä½¿ç”¨ExecutorServiceçš„æ—¥å¿—æœåŠ¡
public class LogService {
    //å°†ç®¡ç†çº¿ç¨‹çš„å·¥ä½œå§”æ‰˜ç»™ä¸€ä¸ªExecutorService,è€Œä¸æ˜¯è‡ªè¡Œç®¡ç†
     private final ExecutorService exec=newSingleThreadExecutor();
     private final PrintWriter writer;
     //...
     public void start(){

     }

     public void stop()throws InterruptedException{
         try{
             exec.shutdown();
             //å†æ¥å—åˆ°shutdownè¯·æ±‚åä¼šç­‰å¾…ä»»åŠ¡å®Œæˆæˆ–è¶…æ—¶, æˆ–è€…å¹¶å‘çº¿ç¨‹è¢«ä¸­æ–­
             exec.awaitTermination(TIMEOUT, UNIT)ï¼›
         }finally {
            writer.close();
        }
     }

     public void log(String msg){
         try{
             exec.execute(new WriteTask(msg));
         }catch (RejectedExecutionException ignored) {
            // TODO: handle exception
        }
     }   
}
```

## â€œæ¯’ä¸¸â€å¯¹è±¡

â€œæ¯’ä¸¸â€ï¼šâ€œå½“å¾—åˆ°è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œç«‹å³åœæ­¢â€ã€‚ åœ¨FIFOé˜Ÿåˆ—ä¸­ä½¿ç”¨

ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…çš„æ¡Œé¢æœç´¢ç¤ºä¾‹ï¼Œé€šè¿‡â€œæ¯’ä¸¸â€å¯¹è±¡æ¥å…³é—­æœåŠ¡

```java
//          7-17    é€šè¿‡æ¯’ä¸¸å¯¹è±¡æ¥å…³é—­æœåŠ¡
public class IndexingService {
     private static final int CAPACITY = 1000;  //capacitryå®¹é‡
     private static final  File POSION=new File("");
     private final CrawlerThread producer=new CrawlerThread();
     private final IndexerThread consumer=new IndexerThread();
     private final BlockingQueue<File> queue;
     private final FileFilter fileFilter;
     private final File root;

     public IndexingService(File root, final FileFilter fileFilter) {
         this.root = root;
         this.queue = new LinkedBlockingQueue<File>(CAPACITY);
         this.fileFilter = new FileFilter() {
             public boolean accept(File f) { //æµ‹è¯•è¯¥è·¯å¾„åç§°è¯¥ä¸è¯¥è¢«åŠ å…¥åˆ°è·¯å¾„åç§°åˆ—è¡¨ä¸­
                 return f.isDirectory() || fileFilter.accept(f);
             }
         };
     }

     private boolean alreadyIndexed(File f) {
         return false;
     }

     public void start(){
         producer.start();
         consumer.start();
     }

     public void stop() {   //åœæ­¢ç”Ÿäº§
         producer.interrupt();
     }

     public void awaitTermination() throws InterruptedException {
         consumer.join();  //ç­‰å¾…å‰é¢æ‰§è¡Œçš„çº¿ç¨‹æ¶ˆäº¡åå†æ‰§è¡Œ
     }
}
```

```java
//           7-18  IndexingServiceçš„ç”Ÿäº§è€…çº¿ç¨‹
public class CrawlerThread extends Thread{
         public void run(){
             try{
                 crawl(root);
             }catch (InterruptedException e) {
                // å‘ç”Ÿå¼‚å¸¸
            }finally{                               //æäº¤æ¯’ä¸¸å¯¹è±¡åï¼Œå°†ä¸å†æäº¤ä»»ä½•å·¥ä½œ
                while(true){
                    try{
                        queue.put(POSION);
                        break;
                    }catch (InterruptedException e) {
                        //é‡æ–°å°è¯•
                    }
                }
            }
         }
         private void crawl(File root) throws InterruptedException {
             File[] entries = root.listFiles(fileFilter); //è¿”å›ç¬¦åˆè¿‡æ»¤å™¨çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
             if (entries != null) {
                 for (File entry : entries) {
                     if (entry.isDirectory())   //å¦‚æœæ˜¯æ–‡ä»¶å¤¹åˆ™é€’å½’
                         crawl(entry);
                     else if (!alreadyIndexed(entry))    //å¦‚æœè¿˜æ²¡ç»™æ–‡ä»¶ç¼–ç´¢å¼•å®Œæˆ,åˆ™æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­
                         queue.put(entry);
                 }
             }
         }
     }
```

```java
//           7-19  IndexingServiceçš„æ¶ˆè´¹è€…çº¿ç¨‹
public class IndexerThread extends Thread{
         public void run(){           //åœ¨æ¯’ä¸¸å¯¹è±¡æäº¤å‰çš„æ‰€æœ‰å·¥ä½œéƒ½è¢«è¢«å¤„ç†
             try{
                 while(true){
                     File file=queue.take();
                     if(file==POSION)
                         break;
                     else
                         indexFile(file);
                 }
             }catch (InterruptedException comsumed) {
            }    
         }
         public void indexFile(File file) {
             /*...*/
         };
     } 
```

## ç¤ºä¾‹ï¼šåªæ‰§è¡Œä¸€æ¬¡çš„æœåŠ¡

checkMailæ–¹æ³•èƒ½åœ¨å¤šå°ä¸»æœºä¸Šå¹¶è¡Œåœ°æ£€æŸ¥æ–°é‚®ä»¶ã€‚å®ƒåˆ›å»ºä¸€ä¸ªç§æœ‰çš„Executorï¼Œå¹¶å‘æ¯å°ä¸»æœºæäº¤ä¸€ä¸ªä»»åŠ¡ã€‚ç„¶åï¼Œå½“æ‰€æœ‰é‚®ä»¶æ£€æŸ¥ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå…³é—­Executorå¹¶ç­‰å¾…ç»“æŸã€‚

```java
public class CheckForMail {
      public boolean checkMail(Set<String> hosts,long timeout,TimeUnit unit)throws InterruptedException{
          ExecutorService exec=Executors.newCachedThreadPool();
          //ä¹‹æ‰€ä»¥ç”¨AtomicBooleanä»£æ›¿volatileï¼Œæ˜¯å› ä¸ºèƒ½ä»å†…éƒ¨çš„Runnableä¸­è®¿é—®hasNewMailæ ‡å¿—ï¼Œå› æ­¤å®ƒå¿…é¡»æ˜¯finalç±»å‹ä»¥å…ä¿®æ”¹
          final AtomicBoolean hasNewMail=new AtomicBoolean(false);//åˆå§‹å€¼ä¸ºfalse
          try{
              for(final String host:hosts)
                  exec.execute(new Runnable(){ //Executes the given command at some time in the future
                      public void run(){
                          if(checkMail(host))
                              hasNewMail.set(true);
                      }
                  });
          }finally {
            exec.shutdown();
            exec.awaitTermination(timeout, unit);
        }
          return hasNewMail.get();
      }
      private boolean checkMail(String host) {
          //æ£€æŸ¥é‚®ä»¶
          return false;
      }
}
```

## shutdownNowçš„å±€é™æ€§

ä½¿ç”¨shutdownNowæ—¶ï¼Œè™½ç„¶ä»–ä¼šè¿”å›å·²æäº¤ä½†å°šæœªå¼€å§‹çš„ä»»åŠ¡ï¼Œä½†æˆ‘ä»¬æ— æ³•åœ¨å…³é—­ä¸­çŸ¥é“æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çš„çŠ¶æ€

è®°å½•å“ªäº›ä»»åŠ¡æ˜¯åœ¨å…³é—­åå–æ¶ˆçš„ï¼š

```java
//          7-21   åœ¨ExecutorServiceä¸­è·Ÿè¸ªåœ¨å…³é—­ä¹‹åå–æ¶ˆçš„ä»»åŠ¡
public class TrackingExecutor extends AbstractExecutorService{
    private final ExecutorService exec;
    private final Set<Runnable> tasksCancelledAtShutdown=
            Collections.synchronizedSet(new HashSet<Runnable>());   //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„Setæ¥è®°å½•é‚£äº›ä»»åŠ¡æ˜¯å…³é—­åå–æ¶ˆçš„

    public List<Runnable> getCancelledTasks(){	//å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•çŸ¥é“ï¼Œå“ªäº›ä»»åŠ¡æ˜¯åœ¨å…³é—­åå–æ¶ˆçš„
        if(!exec.isShutdown())
            throw new IllegalStateException();
        return new ArrayList<Runnable>(tasksCancelledAtShutdown);
    }

    public void execute(final Runnable runnable){
        exec.execute(new Runnable(){
            public void run(){
                try{
                    runnable.run();
                }finally{           //å¦‚æœå·²ç»ExecutorServiceå…³é—­äº†å¹¶ä¸”ä»»åŠ¡è¢«ä¸­æ–­ï¼ˆå–æ¶ˆï¼‰ï¼Œæ·»åŠ åˆ°Setä¸­
                    if(isShutdown()&&Thread.currentThread().isInterrupted())
                        tasksCancelledAtShutdown.add(runnable);
                }
            }
        });
    }
    // å°†ExecutorServiceçš„å…¶ä»–æ–¹æ³•å§”æ‰˜ç»™exec
}
```

TrackingExecutorçš„å®¢æˆ·ç«¯ç¨‹åºã€‚

å½“çˆ¬è™«ç¨‹åºå¿…é¡»å…³é—­æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›ä¿å­˜å®ƒçš„çŠ¶æ€ï¼Œä»¥ä¾¿ç¨åé‡æ–°å¯åŠ¨ã€‚

```java
//       7-22    ä½¿ç”¨TrackingExecutorServiceæ¥ä¿å­˜æœªå®Œæˆçš„ä»»åŠ¡å·²å¤‡åç»­æ‰§è¡Œ
public abstract class WebCrawler {
    private volatile TrackingExecutor exec;        
    @GuardedBy("this") private final Set<URL> urlsToCrawl = new HashSet<URL>(); //å­˜æ”¾

    private final ConcurrentMap<URL, Boolean> seen = new ConcurrentHashMap<URL, Boolean>();
    private static final long TIMEOUT = 500;
    private static final TimeUnit UNIT = MILLISECONDS;

    public WebCrawler(URL startUrl) {
        urlsToCrawl.add(startUrl);
    }

    public synchronized void start() {
        exec = new TrackingExecutor(Executors.newCachedThreadPool()); //åˆ›å»ºå¯è·å¾—åœ¨å…³é—­åè¢«å–æ¶ˆçš„ä»»åŠ¡çš„TrackingExecutor
        for (URL url : urlsToCrawl) submitCrawlTask(url);  //å°†urlsToCrawlä¸­çš„urlåŠ å…¥æ‰§è¡Œé˜Ÿåˆ—
        urlsToCrawl.clear();    //æ¸…ç©º
    }

    public synchronized void stop() throws InterruptedException {
        try {
            saveUncrawled(exec.shutdownNow());                   //shutdownNowé¦–å…ˆå…³é—­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åè¿”å›æ‰€æœ‰å°šæœªå¯åŠ¨çš„ä»»åŠ¡æ¸…å•ã€‚
            if (exec.awaitTermination(TIMEOUT, UNIT))
                saveUncrawled(exec.getCancelledTasks());      //è¿”å›åœ¨å…³é—­åè¢«å–æ¶ˆçš„ä»»åŠ¡å¹¶ä¿å­˜
        } finally {
            exec = null;          
        }
    }

    protected abstract List<URL> processPage(URL url);

    private void saveUncrawled(List<Runnable> uncrawled) {  //ä¿å­˜å·²åœ¨ä»»åŠ¡æ¸…å•ä¸­ä½†å°šæœªæ‰§è¡Œçš„ä»»åŠ¡
        for (Runnable task : uncrawled)
            urlsToCrawl.add(((CrawlTask) task).getPage());
    }

    private void submitCrawlTask(URL u) {       //åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—
        exec.execute(new CrawlTask(u));         
    }

    private class CrawlTask implements Runnable {
        private final URL url;

        CrawlTask(URL url) {
            this.url = url;
        }

        private int count = 1;

        boolean alreadyCrawled() {        //è¡¨ç¤ºè¯¥urlå·²ç»è¢«çˆ¬è¿‡,putIfAbsentåŒ…å«äº†åˆ¤æ–­çš„ï¼Œæ˜¯åŸå­æ“ä½œ
            return seen.putIfAbsent(url, true) != null;
        }

        void markUncrawled() {   //ç§»é™¤
            seen.remove(url);
            System.out.printf("marking %s uncrawled%n", url);
        }

        public void run() {
            for (URL link : processPage(url)) {    
                if (Thread.currentThread().isInterrupted())  //å¦‚æœå·²ç»è¢«ä¸­æ–­å°±ä¸åšæ“ä½œ
                    return;
                submitCrawlTask(link);        //å¦‚æœæœªä¸­æ–­åˆ™é€’å½’ï¼Œä¸€ç›´å¾€execä¸­æ·»åŠ ä»»åŠ¡
            }
        }

        public URL getPage() {   //è¿”å›url
            return url;
        }
    }
}
```

# å¤„ç†éæ­£å¸¸çš„çº¿ç¨‹ç»ˆæ­¢

æœ€ä¸»è¦åŸå› å°±æ˜¯RuntimeExceptionã€‚

ä¸‹é¢ä»£ç ä¸­ï¼Œå¦‚æœä»»åŠ¡æŠ›å‡ºäº†ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ï¼Œé‚£ä¹ˆå®ƒå°†ä½¿çº¿ç¨‹ç»ˆç»“ã€‚ThreadPoolExecutorä¹Ÿä½¿ç”¨äº†è¿™ç§æŠ€æœ¯ã€‚

```java
//       å…¸å‹çš„çº¿ç¨‹æ± å·¥ä½œè€…çº¿ç¨‹ç»“æ„
public void run() {
    Throwable thrown = null;
    try {
        while (!isInterrupted())   //æœªä¸­æ–­
           runTask(getTaskFromWorkQueue());
    } catch (Throwable e) {      //æ£€æŸ¥åˆ°å¼‚å¸¸
        thrown = e;
    } finally {            //çº¿ç¨‹ç»ˆç»“
       threadExited(this, thrown);
    }
}
```

## æœªæ•è·å¼‚å¸¸çš„å¤„ç†

é™¤äº†ä¸Šä¸€ç§ç§ä¸»åŠ¨æ–¹æ³•æ¥è§£å†³è¿è¡Œæ—¶å¼‚å¸¸ï¼Œåœ¨Thread API ä¸­åŒæ ·æä¾›äº†UncaughtExceptionHandlerï¼Œå®ƒèƒ½æ£€æµ‹å‡ºæŸä¸ªçº¿ç¨‹ç”±äºæœªæ•è·çš„å¼‚å¸¸è€Œç»ˆç»“çš„æƒ…å†µã€‚è¿™ä¸¤ç§æ–¹æ³•æ˜¯äº’è¡¥çš„ï¼Œé€šè¿‡å°†ä¸¤è€…ç»“åˆåœ¨ä¸€èµ·ï¼Œå°±èƒ½æœ‰æ•ˆåœ°é˜²æ­¢**çº¿ç¨‹æ³„æ¼**é—®é¢˜ã€‚

å½“çº¿ç¨‹ç”±äºæœªæ•è·å¼‚å¸¸è€Œé€€å‡ºæ—¶ï¼ŒJVMä¼šå§è¿™ä¸ªäº‹ä»¶æŠ¥å‘Šç»™åº”ç”¨ç¨‹åºæçš„UncaughtExceptionHandlerå¼‚å¸¸å¤„ç†å™¨ã€‚å¦‚æœæ²¡æœ‰æä¾›ä»»ä½•å¼‚å¸¸å¤„ç†å™¨ï¼Œé‚£ä¹ˆé»˜è®¤çš„è¡Œä¸ºæ˜¯å°†æ ˆè¿½è¸ªä¿¡æ¯è¾“å‡ºåˆ°System.errã€‚

æˆ–è€…åƒä¸‹é¢ç¨‹åºè¿™æ ·ï¼Œå†™å…¥æ—¥å¿—ã€‚

```java
//      7-25  å°†å¼‚å¸¸å†™å…¥æ—¥å¿—çš„UncaughtExceptionHandler
public class UEHLogger implements Thread.UncaughtExceptionHandler {
    public void uncaughtException(Thread t, Throwable e) {
        Logger logger = Logger.getAnonymousLogger();  //åˆ›å»ºä¸€ä¸ªåŒ¿åçš„æ—¥å¿—
        logger.log(Level.SEVERE, "Thread terminated with exception: " + t.getName(), e);
    }
}
```



# Reference

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜](https://book.douban.com/subject/10484692/)

[æºä»£ç ](http://jcip.net/listings.html)

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼ˆå­¦ä¹ ç¬”è®°å…­ ç¬¬ä¸ƒç«  å–æ¶ˆä¸å…³é—­ ä¸Šï¼‰](https://blog.csdn.net/ahaha413525642/article/details/76815299)

[Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼ˆå­¦ä¹ ç¬”è®°å…­ ç¬¬ä¸ƒç«  å–æ¶ˆä¸å…³é—­ ä¸‹ï¼‰](https://blog.csdn.net/ahaha413525642/article/details/76879439)